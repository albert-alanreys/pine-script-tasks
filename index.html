<!DOCTYPE html>
<html lang="ru" data-bs-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="" />
    <link rel="stylesheet" href="styles/main.css" />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="images/favicon-32x32.png"
    />
    <script src="scripts/jquery-1.12.4.min.js"></script>
    <script src="scripts/ulightbox.min.js"></script>
    <title>Сборник задач</title>
  </head>

  <body>
    <header>
      <div class="collapse bg-pine text-white" id="headbar">
        <div class="container">
          <div class="row d-flex justify-content-center">
            <div class="col-8 px-3 py-3">
              <h4>Оффер</h4>
              <p class="fw-light mb-0">
                Автор данного учебного материала может разработать для вас
                торговый алгоритм в соответствии с техническим заданием, а
                также предложить вам приобрести различные высокодоходные
                торговые алгоритмы.
              </p>
            </div>
            <div class="col-3 text-end px-3 py-3">
              <h4>Обратная связь</h4>
              <ul class="list-unstyled m-0">
                <li>
                  <a
                    class="text-white underline"
                    href="https://t.me/AlanReys"
                    target="_blank"
                    >Telegram</a
                  >
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
      <div class="headbar bg-pine">
        <div class="container">
          <div class="d-flex justify-content-center">
            <div class="col-5">
              <strong class="fs-4 text-white align-bottom ps-1-5"
                >СБОРНИК ЗАДАЧ ПО PINE SCRIPT V6</strong
              >
            </div>
            <div class="col-6">
              <ul class="navbar-nav flex-row float-end">
                <li>
                  <button
                    type="button"
                    class="btn btn-headbar d-flex align-items-center p-2"
                    data-bs-toggle="collapse"
                    data-bs-target="#headbar"
                  >
                    <div id="dollar-icon"></div>
                  </button>
                </li>
                <li>
                  <div class="vr d-flex text-white h-100 mx-2"></div>
                </li>
                <li>
                  <button
                    type="button"
                    class="btn btn-headbar d-flex align-items-center p-2"
                    id="bd-theme"
                  >
                    <div id="theme-icon"></div>
                  </button>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </header>
    <div class="container">
      <div class="row d-flex justify-content-center">
        <nav class="col-3 d-none d-lg-block navbar py-4">
          <div class="flex-shrink-0 sticky mx-3">
            <h4>Навигация</h4>
            <hr />
            <ul class="list-unstyled fw-normal">
              <li>
                <a href="#top">Вступление</a>
              </li>
              <li>
                <a href="#section-1">Задача #1. Исторические значения</a>
              </li>
              <li>
                <a href="#section-2">Задача #2. Последнее значение</a>
              </li>
              <li>
                <a href="#section-3">Задача #3. Конвертер времени</a>
              </li>
              <li>
                <a href="#section-4">Задача #4. Временные рамки</a>
              </li>
              <li>
                <a href="#section-5">Задача #5. Конъюнкция</a>
              </li>
              <li>
                <a href="#section-6">Задача #6. Строгая дизъюнкция</a>
              </li>
              <li>
                <a href="#section-7">Задача #7. Скользящее среднее</a>
              </li>
              <li>
                <a href="#section-8">Задача #8. Прошлые значения</a>
              </li>
              <li>
                <a href="#section-9">Задача #9. Счётчик пересечений</a>
              </li>
              <li>
                <a href="#section-10">Задача #10. Счётчик обновлений</a>
              </li>
              <li>
                <a href="#section-11">Задача #11. Калькулятор</a>
              </li>
              <li>
                <a href="#section-12">Задача #12. Среднее значение</a>
              </li>
              <li>
                <a href="#section-13">Задача #13. Сумма цен</a>
              </li>
              <li>
                <a href="#section-14">Задача #14. Старший таймфрейм</a>
              </li>
              <li>
                <a href="#section-15">Задача #15. Младший таймфрейм</a>
              </li>
              <li>
                <a href="#section-16">Задача #16. Мультипликатор</a>
              </li>
              <li>
                <a href="#section-17">Задача #17. Cтрелки</a>
              </li>
              <li>
                <a href="#section-18">Задача #18. Счастливый билет</a>
              </li>
              <li>
                <a href="#section-19">Задача #19. GC-состав</a>
              </li>
              <li>
                <a href="#section-20">Задача #20. Числовой ряд</a>
              </li>
              <li>
                <a href="#section-21">Задача #21. Повторения</a>
              </li>
              <li>
                <a href="#section-22">Задача #22. Бычьи бары</a>
              </li>
              <li>
                <a href="#section-23">Задача #23. Прямоугольники</a>
              </li>
              <li>
                <a href="#section-24">Задача #24. Зигзаг</a>
              </li>
              <li>
                <a href="#section-25">Задача #25. Спираль</a>
              </li>
              <li>
                <a href="#section-26">Задача #26. Линейная регрессия</a>
              </li>
              <li>
                <a href="#section-27">Задача #27. Матрица корреляций</a>
              </li>
              <li>
                <a href="#section-28">Задача #28. Частота слов</a>
              </li>
              <li>
                <a href="#section-29">Задача #29. Шифр подстановки</a>
              </li>
              <li>
                <a href="#section-30">Задача #30. Рост цен</a>
              </li>
              <li>
                <a href="#section-31">Задача #31. Случайная сумма</a>
              </li>
              <li>
                <a href="#section-32">Задача #32. Сессия</a>
              </li>
              <li>
                <a href="#section-33">Задача #33. Экстремальные цены</a>
              </li>
              <li>
                <a href="#section-34">Задача #34. Полином</a>
              </li>
              <li>
                <a href="#section-35">Задача #35. Зоны поддержки</a>
              </li>
              <li>
                <a href="#section-36">Задача #36. Хейкен Аши</a>
              </li>
              <li>
                <a href="#section-37">Задача #37. Конвертер валют</a>
              </li>
              <li>
                <a href="#section-38">Задача #38. Бэк-тест</a>
              </li>
              <li>
                <a href="#section-39">Задача #39. Форвард-тест</a>
              </li>
              <li>
                <a href="#section-40">Задача #40. Отложенные ордера</a>
              </li>
              <li>
                <a href="#section-41">Задача #41. Уровни Фибоначчи</a>
              </li>
              <li>
                <a href="#section-42">Задача #42. Внутридневной убыток</a>
              </li>
              <li>
                <a href="#section-43">Задача #43. Белый список</a>
              </li>
              <li>
                <a href="#section-44">Задача #44. Торговая статистика</a>
              </li>
              <li>
                <a href="#section-45">Задача #45. Профит-фактор</a>
              </li>
            </ul>
            <hr />
          </div>
        </nav>
        <main class="col-lg-9 col-xxl-8 py-4">
          <section id="section-0">
            <h4 class="mt-0">Вступление</h4>
            <p>
              Целями учебного материала является совершенствование знаний о
              языке Pine Script и развитие логического мышления. Всем, кто не
              знаком с Pine Script, перед решением задач следует изучить
              соответствующую теорию.
            </p>
            <p class="mb-1">
              Как получить максимальную пользу от решения задач:
            </p>
            <ul>
              <li>
                старайтесь решать задачи, не заглядывая в готовые решения;
              </li>
              <li>
                изучайте готовые решения (включая информацию, доступную по
                ссылкам);
              </li>
              <li>
                если вы не справились с задачей, то после изучения готового
                решения повторите попытку.
              </li>
            </ul>
          </section>
          <section id="section-1">
            <h4>Задача #1. Исторические значения</h4>
            <p>Написать индикатор.</p>
            <h5>Ввод</h5>
            <p>Отсутствует.</p>
            <h5>Основные вычисления</h5>
            <p>
              Наибольшие значения из цен открытия и закрытия исторических
              баров.
            </p>
            <h5>Вывод</h5>
            <p>Наибольшие значения объектом <em>plot</em>.</p>
            <a href="images/tasks/task-1-L.png" class="image">
              <img
                src="images/tasks/task-1-L.png"
                class="img-fluid img-thumbnail"
              />
            </a>
            <div class="accordion" id="task-1">
              <div class="accordion-item">
                <div class="accordion-header">
                  <button
                    class="accordion-button collapsed"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#collapse-1"
                  >
                    Решение
                  </button>
                </div>
                <div
                  id="collapse-1"
                  class="accordion-collapse collapse"
                  data-bs-parent="#task-1"
                >
                  <div class="accordion-body">
                    <div class="code-box">
                      <pre><code><span class="psc-3">//@version=6</span>
<span class="psc-5">indicator</span>(<span class="psc-2">"Task #1"</span>)

max <span class="psc-4">=</span> <span class="psc-5">float</span>(<span class="psc-6">na</span>)

<span class="psc-4">if</span> <span class="psc-6">barstate.ishistory</span>
    max <span class="psc-4">:=</span> <span class="psc-5">math.max</span>(<span class="psc-6">close</span><span class="psc-4">,</span> <span class="psc-6">open</span>)

<span class="psc-5">plot</span>(max<span class="psc-4">,</span> linewidth <span class="psc-4">=</span> <span class="psc-1">2</span>)</code></pre>
                    </div>
                    <p>Повторяем теорию:</p>
                    <ul>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_indicator"
                          target="_blank"
                          class="underline"
                          >indicator()</a
                        >
                        определяет скрипт как индикатор и задаёт ему ряд
                        соответствующих свойств;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_float"
                          target="_blank"
                          class="underline"
                          >float()</a
                        >
                        преобразует значение аргумента в значение типа
                        <em>float</em>;
                      </li>
                      <li>
                        переменная
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#var_barstate.ishistory"
                          target="_blank"
                          class="underline"
                          >barstate.ishistory</a
                        >
                        имеет значение <em>true</em>, если текущий бар является
                        историческим баром, иначе переменная имеет значение
                        <em>false</em>;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_math.max"
                          target="_blank"
                          class="underline"
                          >math.max()</a
                        >
                        возвращает наибольшее из нескольких значений
                        аргументов;
                      </li>
                      <li>
                        переменная
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#var_close"
                          target="_blank"
                          class="underline"
                          >close</a
                        >
                        содержит цену закрытия текущего исторического бара или
                        последнюю цену незавершённого бара реального времени;
                      </li>
                      <li>
                        переменная
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#var_open"
                          target="_blank"
                          class="underline"
                          >open</a
                        >
                        содержит цену открытия текущего бара;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_plot"
                          target="_blank"
                          class="underline"
                          >plot()</a
                        >
                        создаёт объект <em>plot</em> и отображает его на
                        графике.
                      </li>
                    </ul>
                    <div class="note-box">
                      <div class="note-box-header">На заметку</div>
                      <p>
                        <a
                          href="https://www.tradingview.com/pine-script-docs/language/execution-model/#calculation-based-on-historical-bars"
                          target="_blank"
                          class="underline"
                          >Исторический бар</a
                        >
                        — это любой бар графика, кроме последнего. Последний
                        бар также считается историческим, при условии, что в
                        данный момент по символу графика не активна торговля.
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>
          <section id="section-2">
            <h4>Задача #2. Последнее значение</h4>
            <p>Написать стратегию.</p>
            <h5>Ввод</h5>
            <p>Отсутствует.</p>
            <h5>Основные вычисления</h5>
            <p>
              Простое скользящее среднее (SMA — Simple Moving Average) цен
              закрытия баров.
            </p>
            <h5>Вывод</h5>
            <p>
              Значение простого скользящего среднего на баре реального времени
              объектом
              <em>plot</em> в виде точки.
            </p>
            <a href="images/tasks/task-2-L.png" class="image">
              <img
                src="images/tasks/task-2-L.png"
                class="img-fluid img-thumbnail"
              />
            </a>
            <div class="accordion" id="task-2">
              <div class="accordion-item">
                <div class="accordion-header">
                  <button
                    class="accordion-button collapsed"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#collapse-2"
                  >
                    Решение
                  </button>
                </div>
                <div
                  id="collapse-2"
                  class="accordion-collapse collapse"
                  data-bs-parent="#task-2"
                >
                  <div class="accordion-body">
                    <div class="code-box">
                      <pre><code><span class="psc-3">//@version=6</span>
<span class="psc-5">strategy</span>(<span class="psc-2">"Task #2"</span><span class="psc-4">,</span> calc_on_every_tick <span class="psc-4">=</span> <span class="psc-6">true</span>)

sma <span class="psc-4">=</span> <span class="psc-5">ta.sma</span>(<span class="psc-6">close</span><span class="psc-4">,</span> <span class="psc-1">3</span>)

<span class="psc-4">if</span> <span class="psc-6">barstate.isconfirmed</span>
    sma <span class="psc-4">:=</span> <span class="psc-6">na</span>

<span class="psc-5">plot</span>(sma<span class="psc-4">,</span> linewidth <span class="psc-4">=</span> <span class="psc-1">5</span><span class="psc-4">,</span> style <span class="psc-4">=</span> <span class="psc-6">plot.style_circles</span>)</code></pre>
                    </div>
                    <p>Повторяем теорию:</p>
                    <ul>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_strategy"
                          target="_blank"
                          class="underline"
                          >strategy()</a
                        >
                        определяет скрипт как стратегию и задаёт ему ряд
                        соответствующих свойств;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_ta.sma"
                          target="_blank"
                          class="underline"
                          >ta.sma()</a
                        >
                        возвращает простое скользящее среднее;
                      </li>
                      <li>
                        переменная
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#var_barstate.isconfirmed"
                          target="_blank"
                          class="underline"
                          >barstate.isconfirmed</a
                        >
                        имеет значение <em>true</em>, если скрипт выполняется
                        на последнем обновлении (закрытии) текущего бара, иначе
                        переменная имеет значение <em>false</em>.
                      </li>
                    </ul>
                    <div class="note-box">
                      <div class="note-box-header">На заметку</div>
                      <p>
                        <a
                          href="https://www.tradingview.com/pine-script-docs/language/execution-model/#calculation-based-on-realtime-bars"
                          target="_blank"
                          class="underline"
                          >Бар реального времени</a
                        >
                        — это последний бар, при условии, что в данный момент
                        по символу графика активна торговля. Другими словами,
                        это обновляемый в реальном времени бар графика.
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>
          <section id="section-3">
            <h4>Задача #3. Конвертер времени</h4>
            <p>Написать индикатор.</p>
            <h5>Ввод</h5>
            <p>Целое число N. Минимальное значение: <em>0</em>.</p>
            <h5>Основные вычисления</h5>
            <p>Количество часов, минут и секунд в числе N.</p>
            <h5>Вывод</h5>
            <p>
              Количество часов, минут и секунд объектом
              <em>label</em> на первом баре.
            </p>
            <a href="images/tasks/task-3-L.png" class="image">
              <img
                src="images/tasks/task-3-L.png"
                class="img-fluid img-thumbnail"
              />
            </a>
            <div class="accordion" id="task-3">
              <div class="accordion-item">
                <div class="accordion-header">
                  <button
                    class="accordion-button collapsed"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#collapse-3"
                  >
                    Решение
                  </button>
                </div>
                <div
                  id="collapse-3"
                  class="accordion-collapse collapse"
                  data-bs-parent="#task-3"
                >
                  <div class="accordion-body">
                    <div class="code-box">
                      <pre><code><span class="psc-3">//@version=6</span>
<span class="psc-5">indicator</span>(<span class="psc-2">"Task #3"</span>)

n <span class="psc-4">=</span> <span class="psc-5">input.int</span>(<span class="psc-1">5000</span><span class="psc-4">,</span> <span class="psc-2">"N"</span><span class="psc-4">,</span> <span class="psc-1">0</span>)

<span class="psc-4">if</span> <span class="psc-6">barstate.isfirst</span>
    hours <span class="psc-4">=</span> <span class="psc-5">int</span>(n <span class="psc-4">/</span> <span class="psc-1">60</span> <span class="psc-4">/</span> <span class="psc-1">60</span>)
    minutes <span class="psc-4">=</span> (n <span class="psc-4">-</span> n <span class="psc-4">%</span> <span class="psc-1">60</span>) <span class="psc-4">/</span> <span class="psc-1">60</span> <span class="psc-4">%</span> <span class="psc-1">60</span>
    seconds <span class="psc-4">=</span> n <span class="psc-4">%</span> <span class="psc-1">60</span>

    <span class="psc-5">label.new</span>(
      x <span class="psc-4">=</span> <span class="psc-6">bar_index</span><span class="psc-4">,</span>
      y <span class="psc-4">=</span> <span class="psc-6">close</span><span class="psc-4">,</span>
      text <span class="psc-4">=</span> <span class="psc-5">str.format</span>(<span class="psc-2">"{0} {1} {2}"</span><span class="psc-4">,</span> hours<span class="psc-4">,</span> minutes<span class="psc-4">,</span> seconds)<span class="psc-4">,</span>
      style <span class="psc-4">=</span> <span class="psc-6">label.style_label_center</span><span class="psc-4">,</span>
      textcolor <span class="psc-4">=</span> <span class="psc-6">color.white</span><span class="psc-4">,</span>
      size <span class="psc-4">=</span> <span class="psc-6">size.large</span>
      )</code></pre>
                    </div>
                    <p>Повторяем теорию:</p>
                    <ul>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_input.int"
                          target="_blank"
                          class="underline"
                          >input.int()</a
                        >
                        добавляет в настройки скрипта поле для ввода целого
                        числа;
                      </li>
                      <li>
                        переменная
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#var_barstate.isfirst"
                          target="_blank"
                          class="underline"
                          >barstate.isfirst</a
                        >
                        имеет значение <em>true</em>, если текущий бар является
                        первым баром графика, иначе переменная имеет значение
                        <em>false</em>;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_int"
                          target="_blank"
                          class="underline"
                          >int()</a
                        >
                        преобразует значение аргумента в значение типа
                        <em>int</em>;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_label.new"
                          target="_blank"
                          class="underline"
                          >label.new()</a
                        >
                        создаёт объект <em>label</em> и отображает его на
                        графике;
                      </li>
                      <li>
                        переменная
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#var_bar_index"
                          target="_blank"
                          class="underline"
                          >bar_index</a
                        >
                        содержит индекс текущего бара;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_str.format"
                          target="_blank"
                          class="underline"
                          >str.format()</a
                        >
                        форматирует строку, вставляя в указанные места значения
                        аргументов.
                      </li>
                    </ul>
                    <div class="note-box">
                      <div class="note-box-header">На заметку</div>
                      <p>
                        Pine Script поддерживает автоматическое и явное
                        <a
                          href="https://www.tradingview.com/pine-script-docs/language/type-system/#type-casting"
                          target="_blank"
                          class="underline"
                          >приведение типов</a
                        >.
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>
          <section id="section-4">
            <h4>Задача #4. Временные рамки</h4>
            <p>Написать индикатор.</p>
            <h5>Ввод</h5>
            <p>Дата и время T1.</p>
            <p>Дата и время T2.</p>
            <h5>Основные вычисления</h5>
            <p>
              Логический сигнал, принимающий значение <em>true</em>, если время
              открытия текущего бара попадает в закрытый интервал [T1; T2],
              иначе принимающий значение <em>false</em>.
            </p>
            <h5>Вывод</h5>
            <p>
              Символы Юникода над барами, на которых логический сигнал равен
              <em>true</em>.
            </p>
            <a href="images/tasks/task-4-L.png" class="image">
              <img
                src="images/tasks/task-4-L.png"
                class="img-fluid img-thumbnail"
              />
            </a>
            <div class="accordion" id="task-4">
              <div class="accordion-item">
                <div class="accordion-header">
                  <button
                    class="accordion-button collapsed"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#collapse-4"
                  >
                    Решение
                  </button>
                </div>
                <div
                  id="collapse-4"
                  class="accordion-collapse collapse"
                  data-bs-parent="#task-4"
                >
                  <div class="accordion-body">
                    <div class="code-box">
                      <pre><code><span class="psc-3">//@version=6</span>
<span class="psc-5">indicator</span>(<span class="psc-2">"Task #4"</span><span class="psc-4">,</span> overlay <span class="psc-4">=</span> <span class="psc-6">true</span>)

t1 <span class="psc-4">=</span> <span class="psc-5">input.time</span>(<span class="psc-5">timestamp</span>(<span class="psc-2">"01 Jan 2022 00:00 +0000"</span>)<span class="psc-4">,</span> <span class="psc-2">"T1"</span>)
t2 <span class="psc-4">=</span> <span class="psc-5">input.time</span>(<span class="psc-5">timestamp</span>(<span class="psc-2">"01 Oct 2023 00:00 +0000"</span>)<span class="psc-4">,</span> <span class="psc-2">"T2"</span>)

signal <span class="psc-4">=</span> t1 <span class="psc-4"><=</span> <span class="psc-6">time</span> <span class="psc-4">and</span> <span class="psc-6">time</span> <span class="psc-4"><=</span> t2

<span class="psc-5">plotchar</span>(signal<span class="psc-4">,</span> char <span class="psc-4">=</span> <span class="psc-2">"</span>💡<span class="psc-2">"</span>)</code></pre>
                    </div>
                    <p>Повторяем теорию:</p>
                    <ul>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_input.time"
                          target="_blank"
                          class="underline"
                          >input.time()</a
                        >
                        добавляет в настройки скрипта поле для ввода даты и
                        времени;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_timestamp"
                          target="_blank"
                          class="underline"
                          >timestamp()</a
                        >
                        возвращает Unix-время для указанной даты и времени;
                      </li>
                      <li>
                        переменная
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#var_time"
                          target="_blank"
                          class="underline"
                          >time</a
                        >
                        содержит время открытия текущего бара в формате Unix;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_plotchar"
                          target="_blank"
                          class="underline"
                          >plotchar()</a
                        >
                        отображает символы Юникода на графике.
                      </li>
                    </ul>
                    <div class="note-box">
                      <div class="note-box-header">На заметку</div>
                      <p>
                        Unix-время — это количество миллисекунд, прошедших с
                        полуночи (00:00:00 UTC) 1 января 1970 года.
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>
          <section id="section-5">
            <h4>Задача #5. Конъюнкция</h4>
            <p>Написать индикатор.</p>
            <h5>Ввод</h5>
            <p>Отсутствует.</p>
            <h5>Основные вычисления</h5>
            <p>Таблица истинности для бинарной конъюнкции (логическое И).</p>
            <h5>Вывод</h5>
            <p>Таблица истинности объектом <em>table</em>.</p>
            <a href="images/tasks/task-5-L.png" class="image">
              <img
                src="images/tasks/task-5-L.png"
                class="img-fluid img-thumbnail"
              />
            </a>
            <div class="accordion" id="task-5">
              <div class="accordion-item">
                <div class="accordion-header">
                  <button
                    class="accordion-button collapsed"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#collapse-5"
                  >
                    Решение
                  </button>
                </div>
                <div
                  id="collapse-5"
                  class="accordion-collapse collapse"
                  data-bs-parent="#task-5"
                >
                  <div class="accordion-body">
                    <div class="code-box">
                      <pre><code><span class="psc-3">//@version=6</span>
<span class="psc-5">indicator</span>(<span class="psc-2">"Task #5"</span><span class="psc-4">,</span> overlay <span class="psc-4">=</span> <span class="psc-6">true</span>)

<span class="psc-4">if</span> <span class="psc-6">barstate.islast</span>
    <span class="psc-4">var</span> truthTable <span class="psc-4">=</span> <span class="psc-5">table.new</span>(
      position <span class="psc-4">=</span> <span class="psc-6">position.bottom_right</span><span class="psc-4">,</span>
      columns <span class="psc-4">=</span> <span class="psc-1">3</span><span class="psc-4">,</span>
      rows <span class="psc-4">=</span> <span class="psc-1">5</span><span class="psc-4">,</span>
      bgcolor <span class="psc-4">=</span> <span class="psc-6">color.yellow</span><span class="psc-4">,</span>
      frame_color <span class="psc-4">=</span> <span class="psc-6">color.black</span><span class="psc-4">,</span>
      frame_width <span class="psc-4">=</span> <span class="psc-1">2</span><span class="psc-4">,</span>
      border_color <span class="psc-4">=</span> <span class="psc-6">color.black</span><span class="psc-4">,</span>
      border_width <span class="psc-4">=</span> <span class="psc-1">2</span>
      )

    value1 <span class="psc-4">=</span> <span class="psc-5">str.tostring</span>(<span class="psc-6">false</span> <span class="psc-4">and</span> <span class="psc-6">false</span>)
    value2 <span class="psc-4">=</span> <span class="psc-5">str.tostring</span>(<span class="psc-6">true</span> <span class="psc-4">and</span> <span class="psc-6">false</span>)
    value3 <span class="psc-4">=</span> <span class="psc-5">str.tostring</span>(<span class="psc-6">false</span> <span class="psc-4">and</span> <span class="psc-6">true</span>)
    value4 <span class="psc-4">=</span> <span class="psc-5">str.tostring</span>(<span class="psc-6">true</span> <span class="psc-4">and</span> <span class="psc-6">true</span>)

    <span class="psc-5">table.cell</span>(truthTable<span class="psc-4">,</span> <span class="psc-1">0</span><span class="psc-4">,</span> <span class="psc-1">0</span><span class="psc-4">,</span> <span class="psc-2">"a"</span><span class="psc-4">,</span> text_size <span class="psc-4">=</span> <span class="psc-6">size.huge</span>)
    <span class="psc-5">table.cell</span>(truthTable<span class="psc-4">,</span> <span class="psc-1">1</span><span class="psc-4">,</span> <span class="psc-1">0</span><span class="psc-4">,</span> <span class="psc-2">"b"</span><span class="psc-4">,</span> text_size <span class="psc-4">=</span> <span class="psc-6">size.huge</span>)
    <span class="psc-5">table.cell</span>(truthTable<span class="psc-4">,</span> <span class="psc-1">2</span><span class="psc-4">,</span> <span class="psc-1">0</span><span class="psc-4">,</span> <span class="psc-2">"a and b"</span><span class="psc-4">,</span> text_size <span class="psc-4">=</span> <span class="psc-6">size.huge</span>)
    <span class="psc-5">table.cell</span>(truthTable<span class="psc-4">,</span> <span class="psc-1">0</span><span class="psc-4">,</span> <span class="psc-1">1</span><span class="psc-4">,</span> <span class="psc-2">"false"</span><span class="psc-4">,</span> text_size <span class="psc-4">=</span> <span class="psc-6">size.huge</span>)
    <span class="psc-5">table.cell</span>(truthTable<span class="psc-4">,</span> <span class="psc-1">1</span><span class="psc-4">,</span> <span class="psc-1">1</span><span class="psc-4">,</span> <span class="psc-2">"false"</span><span class="psc-4">,</span> text_size <span class="psc-4">=</span> <span class="psc-6">size.huge</span>)
    <span class="psc-5">table.cell</span>(truthTable<span class="psc-4">,</span> <span class="psc-1">2</span><span class="psc-4">,</span> <span class="psc-1">1</span><span class="psc-4">,</span> value1<span class="psc-4">,</span> text_size <span class="psc-4">=</span> <span class="psc-6">size.huge</span>)
    <span class="psc-5">table.cell</span>(truthTable<span class="psc-4">,</span> <span class="psc-1">0</span><span class="psc-4">,</span> <span class="psc-1">2</span><span class="psc-4">,</span> <span class="psc-2">"true"</span><span class="psc-4">,</span> text_size <span class="psc-4">=</span> <span class="psc-6">size.huge</span>)
    <span class="psc-5">table.cell</span>(truthTable<span class="psc-4">,</span> <span class="psc-1">1</span><span class="psc-4">,</span> <span class="psc-1">2</span><span class="psc-4">,</span> <span class="psc-2">"false"</span><span class="psc-4">,</span> text_size <span class="psc-4">=</span> <span class="psc-6">size.huge</span>)
    <span class="psc-5">table.cell</span>(truthTable<span class="psc-4">,</span> <span class="psc-1">2</span><span class="psc-4">,</span> <span class="psc-1">2</span><span class="psc-4">,</span> value2<span class="psc-4">,</span> text_size <span class="psc-4">=</span> <span class="psc-6">size.huge</span>)
    <span class="psc-5">table.cell</span>(truthTable<span class="psc-4">,</span> <span class="psc-1">0</span><span class="psc-4">,</span> <span class="psc-1">3</span><span class="psc-4">,</span> <span class="psc-2">"false"</span><span class="psc-4">,</span> text_size <span class="psc-4">=</span> <span class="psc-6">size.huge</span>)
    <span class="psc-5">table.cell</span>(truthTable<span class="psc-4">,</span> <span class="psc-1">1</span><span class="psc-4">,</span> <span class="psc-1">3</span><span class="psc-4">,</span> <span class="psc-2">"true"</span><span class="psc-4">,</span> text_size <span class="psc-4">=</span> <span class="psc-6">size.huge</span>)
    <span class="psc-5">table.cell</span>(truthTable<span class="psc-4">,</span> <span class="psc-1">2</span><span class="psc-4">,</span> <span class="psc-1">3</span><span class="psc-4">,</span> value3<span class="psc-4">,</span> text_size <span class="psc-4">=</span> <span class="psc-6">size.huge</span>)
    <span class="psc-5">table.cell</span>(truthTable<span class="psc-4">,</span> <span class="psc-1">0</span><span class="psc-4">,</span> <span class="psc-1">4</span><span class="psc-4">,</span> <span class="psc-2">"true"</span><span class="psc-4">,</span> text_size <span class="psc-4">=</span> <span class="psc-6">size.huge</span>)
    <span class="psc-5">table.cell</span>(truthTable<span class="psc-4">,</span> <span class="psc-1">1</span><span class="psc-4">,</span> <span class="psc-1">4</span><span class="psc-4">,</span> <span class="psc-2">"true"</span><span class="psc-4">,</span> text_size <span class="psc-4">=</span> <span class="psc-6">size.huge</span>)
    <span class="psc-5">table.cell</span>(truthTable<span class="psc-4">,</span> <span class="psc-1">2</span><span class="psc-4">,</span> <span class="psc-1">4</span><span class="psc-4">,</span> value4<span class="psc-4">,</span> text_size <span class="psc-4">=</span> <span class="psc-6">size.huge</span>)</code></pre>
                    </div>
                    <p>Повторяем теорию:</p>
                    <ul>
                      <li>
                        переменная
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#var_barstate.islast"
                          target="_blank"
                          class="underline"
                          >barstate.islast</a
                        >
                        имеет значение <em>true</em>, если текущий бар является
                        последним баром графика, иначе переменная имеет
                        значение <em>false</em>;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_table.new"
                          target="_blank"
                          class="underline"
                          >table.new()</a
                        >
                        создаёт объект <em>table</em>;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_str.tostring"
                          target="_blank"
                          class="underline"
                          >str.tostring()</a
                        >
                        возвращает строковое представление аргумента;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_table.cell"
                          target="_blank"
                          class="underline"
                          >table.cell()</a
                        >
                        устанавливает свойства ячейки таблицы и отображает её
                        на графике.
                      </li>
                    </ul>
                    <div class="note-box">
                      <div class="note-box-header">На заметку</div>
                      <p>
                        Объекты
                        <a
                          href="https://www.tradingview.com/pine-script-docs/concepts/tables/"
                          target="_blank"
                          class="underline"
                          >table</a
                        >
                        отображаются на графике без привязки к барам. Поэтому,
                        в целях экономии ресурсов TradingView и ускорения
                        выполнения скриптов, таблицы рекомендуется создавать на
                        последнем баре. Кроме того, при объявлении таблиц
                        рекомендуется использовать ключевое слово
                        <a
                          href="https://www.tradingview.com/pine-script-docs/language/variable-declarations/#var"
                          target="_blank"
                          class="underline"
                          >var</a
                        >.
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>
          <section id="section-6">
            <h4>Задача #6. Строгая дизъюнкция</h4>
            <p>Написать индикатор.</p>
            <h5>Ввод</h5>
            <p>Отсутствует.</p>
            <h5>Основные вычисления</h5>
            <p>
              Таблица истинности для бинарной строгой дизъюнкции (исключающее
              ИЛИ). Логическая операция должна быть реализована одной строкой
              кода.
            </p>
            <h5>Вывод</h5>
            <p>
              Таблица истинности объектом <em>table</em>, если текущий
              таймфрейм графика является дневным или месячным.
            </p>
            <a href="images/tasks/task-6-L.png" class="image">
              <img
                src="images/tasks/task-6-L.png"
                class="img-fluid img-thumbnail"
              />
            </a>
            <div class="accordion" id="task-6">
              <div class="accordion-item">
                <div class="accordion-header">
                  <button
                    class="accordion-button collapsed"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#collapse-6"
                  >
                    Решение
                  </button>
                </div>
                <div
                  id="collapse-6"
                  class="accordion-collapse collapse"
                  data-bs-parent="#task-6"
                >
                  <div class="accordion-body">
                    <div class="code-box">
                      <pre><code><span class="psc-3">//@version=6</span>
<span class="psc-5">indicator</span>(<span class="psc-2">"Task #6"</span><span class="psc-4">,</span> overlay <span class="psc-4">=</span> <span class="psc-6">true</span>)

<span class="psc-7">xor</span>(a<span class="psc-4">,</span> b) <span class="psc-4">=></span> a <span class="psc-4">and</span> <span class="psc-4">not</span> b <span class="psc-4">or</span> <span class="psc-4">not</span> a <span class="psc-4">and</span> b

<span class="psc-4">if</span> <span class="psc-6">barstate.islast</span> <span class="psc-4">and</span> (<span class="psc-6">timeframe.isdaily</span> <span class="psc-4">or</span> <span class="psc-6">timeframe.ismonthly</span>)
    <span class="psc-4">var</span> truthTable <span class="psc-4">=</span> <span class="psc-5">table.new</span>(
      position <span class="psc-4">=</span> <span class="psc-6">position.bottom_right</span><span class="psc-4">,</span> 
      columns <span class="psc-4">=</span> <span class="psc-1">3</span><span class="psc-4">,</span>
      rows <span class="psc-4">=</span> <span class="psc-1">5</span><span class="psc-4">,</span>
      bgcolor <span class="psc-4">=</span> <span class="psc-6">color.yellow</span><span class="psc-4">,</span>
      frame_color <span class="psc-4">=</span> <span class="psc-6">color.black</span><span class="psc-4">,</span>
      frame_width <span class="psc-4">=</span> <span class="psc-1">2</span><span class="psc-4">,</span>
      border_color <span class="psc-4">=</span> <span class="psc-6">color.black</span><span class="psc-4">,</span>
      border_width <span class="psc-4">=</span> <span class="psc-1">2</span>
      )

    value1 <span class="psc-4">=</span> <span class="psc-5">str.tostring</span>(<span class="psc-7">xor</span>(<span class="psc-6">false</span><span class="psc-4">,</span> <span class="psc-6">false</span>))
    value2 <span class="psc-4">=</span> <span class="psc-5">str.tostring</span>(<span class="psc-7">xor</span>(<span class="psc-6">true</span><span class="psc-4">,</span> <span class="psc-6">false</span>))
    value3 <span class="psc-4">=</span> <span class="psc-5">str.tostring</span>(<span class="psc-7">xor</span>(<span class="psc-6">false</span><span class="psc-4">,</span> <span class="psc-6">true</span>))
    value4 <span class="psc-4">=</span> <span class="psc-5">str.tostring</span>(<span class="psc-7">xor</span>(<span class="psc-6">true</span><span class="psc-4">,</span> <span class="psc-6">true</span>))

    <span class="psc-5">table.cell</span>(truthTable<span class="psc-4">,</span> <span class="psc-1">0</span><span class="psc-4">,</span> <span class="psc-1">0</span><span class="psc-4">,</span> <span class="psc-2">"a"</span><span class="psc-4">,</span> text_size <span class="psc-4">=</span> <span class="psc-6">size.huge</span>)
    <span class="psc-5">table.cell</span>(truthTable<span class="psc-4">,</span> <span class="psc-1">1</span><span class="psc-4">,</span> <span class="psc-1">0</span><span class="psc-4">,</span> <span class="psc-2">"b"</span><span class="psc-4">,</span> text_size <span class="psc-4">=</span> <span class="psc-6">size.huge</span>)
    <span class="psc-5">table.cell</span>(truthTable<span class="psc-4">,</span> <span class="psc-1">2</span><span class="psc-4">,</span> <span class="psc-1">0</span><span class="psc-4">,</span> <span class="psc-2">"a xor b"</span><span class="psc-4">,</span> text_size <span class="psc-4">=</span> <span class="psc-6">size.huge</span>)
    <span class="psc-5">table.cell</span>(truthTable<span class="psc-4">,</span> <span class="psc-1">0</span><span class="psc-4">,</span> <span class="psc-1">1</span><span class="psc-4">,</span> <span class="psc-2">"false"</span><span class="psc-4">,</span> text_size <span class="psc-4">=</span> <span class="psc-6">size.huge</span>)
    <span class="psc-5">table.cell</span>(truthTable<span class="psc-4">,</span> <span class="psc-1">1</span><span class="psc-4">,</span> <span class="psc-1">1</span><span class="psc-4">,</span> <span class="psc-2">"false"</span><span class="psc-4">,</span> text_size <span class="psc-4">=</span> <span class="psc-6">size.huge</span>)
    <span class="psc-5">table.cell</span>(truthTable<span class="psc-4">,</span> <span class="psc-1">2</span><span class="psc-4">,</span> <span class="psc-1">1</span><span class="psc-4">,</span> value1<span class="psc-4">,</span> text_size <span class="psc-4">=</span> <span class="psc-6">size.huge</span>)
    <span class="psc-5">table.cell</span>(truthTable<span class="psc-4">,</span> <span class="psc-1">0</span><span class="psc-4">,</span> <span class="psc-1">2</span><span class="psc-4">,</span> <span class="psc-2">"true"</span><span class="psc-4">,</span> text_size <span class="psc-4">=</span> <span class="psc-6">size.huge</span>)
    <span class="psc-5">table.cell</span>(truthTable<span class="psc-4">,</span> <span class="psc-1">1</span><span class="psc-4">,</span> <span class="psc-1">2</span><span class="psc-4">,</span> <span class="psc-2">"false"</span><span class="psc-4">,</span> text_size <span class="psc-4">=</span> <span class="psc-6">size.huge</span>)
    <span class="psc-5">table.cell</span>(truthTable<span class="psc-4">,</span> <span class="psc-1">2</span><span class="psc-4">,</span> <span class="psc-1">2</span><span class="psc-4">,</span> value2<span class="psc-4">,</span> text_size <span class="psc-4">=</span> <span class="psc-6">size.huge</span>)
    <span class="psc-5">table.cell</span>(truthTable<span class="psc-4">,</span> <span class="psc-1">0</span><span class="psc-4">,</span> <span class="psc-1">3</span><span class="psc-4">,</span> <span class="psc-2">"false"</span><span class="psc-4">,</span> text_size <span class="psc-4">=</span> <span class="psc-6">size.huge</span>)
    <span class="psc-5">table.cell</span>(truthTable<span class="psc-4">,</span> <span class="psc-1">1</span><span class="psc-4">,</span> <span class="psc-1">3</span><span class="psc-4">,</span> <span class="psc-2">"true"</span><span class="psc-4">,</span> text_size <span class="psc-4">=</span> <span class="psc-6">size.huge</span>)
    <span class="psc-5">table.cell</span>(truthTable<span class="psc-4">,</span> <span class="psc-1">2</span><span class="psc-4">,</span> <span class="psc-1">3</span><span class="psc-4">,</span> value3<span class="psc-4">,</span> text_size <span class="psc-4">=</span> <span class="psc-6">size.huge</span>)
    <span class="psc-5">table.cell</span>(truthTable<span class="psc-4">,</span> <span class="psc-1">0</span><span class="psc-4">,</span> <span class="psc-1">4</span><span class="psc-4">,</span> <span class="psc-2">"true"</span><span class="psc-4">,</span> text_size <span class="psc-4">=</span> <span class="psc-6">size.huge</span>)
    <span class="psc-5">table.cell</span>(truthTable<span class="psc-4">,</span> <span class="psc-1">1</span><span class="psc-4">,</span> <span class="psc-1">4</span><span class="psc-4">,</span> <span class="psc-2">"true"</span><span class="psc-4">,</span> text_size <span class="psc-4">=</span> <span class="psc-6">size.huge</span>)
    <span class="psc-5">table.cell</span>(truthTable<span class="psc-4">,</span> <span class="psc-1">2</span><span class="psc-4">,</span> <span class="psc-1">4</span><span class="psc-4">,</span> value4<span class="psc-4">,</span> text_size <span class="psc-4">=</span> <span class="psc-6">size.huge</span>)</code></pre>
                    </div>
                    <p>Повторяем теорию:</p>
                    <ul>
                      <li>
                        переменная
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#var_timeframe.isdaily"
                          target="_blank"
                          class="underline"
                          >timeframe.isdaily</a
                        >
                        имеет значение <em>true</em>, если текущий таймфрейм
                        графика является дневным, иначе переменная имеет
                        значение <em>false</em>;
                      </li>
                      <li>
                        переменная
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#var_timeframe.ismonthly"
                          target="_blank"
                          class="underline"
                          >timeframe.ismonthly</a
                        >
                        имеет значение <em>true</em>, если текущий таймфрейм
                        графика является месячным, иначе переменная имеет
                        значение <em>false</em>.
                      </li>
                    </ul>
                    <div class="note-box">
                      <div class="note-box-header">На заметку</div>
                      <p>
                        Операторы, используемые для построения выражений, имеют
                        <a
                          href="https://www.tradingview.com/pine-script-docs/language/operators/#operator-precedence"
                          target="_blank"
                          class="underline"
                          >приоритет</a
                        >, который определяет очерёдность выполнения операций в
                        выражении. Если выражение необходимо вычислить в
                        порядке, отличном от того, который диктует приоритет
                        операторов, то части выражения можно сгруппировать
                        вместе с помощью круглых скобок. Использование скобок
                        также повышает читабельность кода.
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>
          <section id="section-7">
            <h4>Задача #7. Скользящее среднее</h4>
            <p>Написать индикатор.</p>
            <h5>Ввод</h5>
            <p>Строка с типом скользящего среднего T.</p>
            <p>Источник для расчётов S.</p>
            <p>Целое число L. Минимальное значение: <em>2</em>.</p>
            <h5>Основные вычисления</h5>
            <p>
              Скользящее среднее данных S длиной L в зависимости от типа
              скользящего среднего T. Если тип T равен <em>"EMA"</em>, то
              вычисляется экспоненциальное скользящее среднее (EMA —
              Exponential Moving Average). Если тип T равен <em>"HMA"</em>, то
              вычисляется скользящее среднее Хала (HMA — Hull Moving Average).
              Если тип T равен <em>"WMA"</em>, то вычисляется взвешенное
              скользящее среднее (WMA — Weighted Moving Average). При
              вычислении скользящего среднего должен использоваться тернарный
              условный оператор.
            </p>
            <h5>Вывод</h5>
            <p>Скользящее среднее объектом <em>plot</em>.</p>
            <a href="images/tasks/task-7-L.png" class="image">
              <img
                src="images/tasks/task-7-L.png"
                class="img-fluid img-thumbnail"
              />
            </a>
            <div class="accordion" id="task-7">
              <div class="accordion-item">
                <div class="accordion-header">
                  <button
                    class="accordion-button collapsed"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#collapse-7"
                  >
                    Решение
                  </button>
                </div>
                <div
                  id="collapse-7"
                  class="accordion-collapse collapse"
                  data-bs-parent="#task-7"
                >
                  <div class="accordion-body">
                    <div class="code-box">
                      <pre><code><span class="psc-3">//@version=6</span>
<span class="psc-5">indicator</span>(<span class="psc-2">"Task #7"</span><span class="psc-4">,</span> overlay <span class="psc-4">=</span> <span class="psc-6">true</span>)

t <span class="psc-4">=</span> <span class="psc-5">input.string</span>(<span class="psc-2">"HMA"</span><span class="psc-4">,</span> <span class="psc-2">"T"</span>)
s <span class="psc-4">=</span> <span class="psc-5">input.source</span>(<span class="psc-6">high</span><span class="psc-4">,</span> <span class="psc-2">"S"</span>)
l <span class="psc-4">=</span> <span class="psc-5">input.int</span>(<span class="psc-1">3</span><span class="psc-4">,</span> <span class="psc-2">"L"</span><span class="psc-4">,</span> <span class="psc-1">2</span>)

ma <span class="psc-4">=</span>
  t <span class="psc-4">==</span> <span class="psc-2">"EMA"</span> <span class="psc-4">?</span> <span class="psc-5">ta.ema</span>(s<span class="psc-4">,</span> l) <span class="psc-4">:</span>
  t <span class="psc-4">==</span> <span class="psc-2">"HMA"</span> <span class="psc-4">?</span> <span class="psc-5">ta.hma</span>(s<span class="psc-4">,</span> l) <span class="psc-4">:</span>
  t <span class="psc-4">==</span> <span class="psc-2">"WMA"</span> <span class="psc-4">?</span> <span class="psc-5">ta.wma</span>(s<span class="psc-4">,</span> l) <span class="psc-4">:</span>
  <span class="psc-6">na</span>

<span class="psc-5">plot</span>(ma<span class="psc-4">,</span> linewidth <span class="psc-4">=</span> <span class="psc-1">2</span>)</code></pre>
                    </div>
                    <p>Повторяем теорию:</p>
                    <ul>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_input.string"
                          target="_blank"
                          class="underline"
                          >input.string()</a
                        >
                        добавляет в настройки скрипта поле для ввода строки
                        текста;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_input.source"
                          target="_blank"
                          class="underline"
                          >input.source()</a
                        >
                        добавляет в настройки скрипта выпадающее меню,
                        позволяющее выбрать источник для расчётов, например,
                        переменную <em>close</em>;
                      </li>
                      <li>
                        переменная
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#var_high"
                          target="_blank"
                          class="underline"
                          >high</a
                        >
                        содержит цену максимума текущего бара;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_ta.ema"
                          target="_blank"
                          class="underline"
                          >ta.ema()</a
                        >
                        возвращает экспоненциальное скользящее среднее;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_ta.hma"
                          target="_blank"
                          class="underline"
                          >ta.hma()</a
                        >
                        возвращает скользящее среднее Хала;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_ta.wma"
                          target="_blank"
                          class="underline"
                          >ta.wma()</a
                        >
                        возвращает взвешенное скользящее среднее.
                      </li>
                    </ul>
                    <div class="note-box">
                      <div class="note-box-header">На заметку</div>
                      <p>
                        Длинные строки кода можно
                        <a
                          href="https://www.tradingview.com/pine-script-docs/language/script-structure/#line-wrapping"
                          target="_blank"
                          class="underline"
                          >разделить</a
                        >
                        на несколько строк. Перенесённые строки должны иметь
                        отступ, не кратный четырём пробелам (четыре пробела
                        выделяют локальные блоки).
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>
          <section id="section-8">
            <h4>Задача #8. Прошлые значения</h4>
            <p>Написать индикатор.</p>
            <h5>Ввод</h5>
            <p>Цвет C.</p>
            <h5>Основные вычисления</h5>
            <p>
              Логический сигнал, принимающий значение <em>true</em>, если
              закрытие текущего бара больше закрытия предыдущего бара и
              закрытие предыдущего бара больше его открытия, иначе принимающий
              значение <em>false</em>.
            </p>
            <h5>Вывод</h5>
            <p>
              Заливка фона баров цветом C, на которых логический сигнал равен
              <em>true</em>.
            </p>
            <a href="images/tasks/task-8-L.png" class="image">
              <img
                src="images/tasks/task-8-L.png"
                class="img-fluid img-thumbnail"
              />
            </a>
            <div class="accordion" id="task-8">
              <div class="accordion-item">
                <div class="accordion-header">
                  <button
                    class="accordion-button collapsed"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#collapse-8"
                  >
                    Решение
                  </button>
                </div>
                <div
                  id="collapse-8"
                  class="accordion-collapse collapse"
                  data-bs-parent="#task-8"
                >
                  <div class="accordion-body">
                    <div class="code-box">
                      <pre><code><span class="psc-3">//@version=6</span>
<span class="psc-5">indicator</span>(<span class="psc-2">"Task #8"</span><span class="psc-4">,</span> overlay <span class="psc-4">=</span> <span class="psc-6">true</span>)

c <span class="psc-4">=</span> <span class="psc-5">input.color</span>(<span class="psc-5">color.new</span>(<span class="psc-6">color.blue</span><span class="psc-4">,</span> <span class="psc-1">60</span>)<span class="psc-4">,</span> <span class="psc-2">"C"</span>)

signal <span class="psc-4">=</span> <span class="psc-6">close</span> <span class="psc-4">></span> <span class="psc-6">close</span>[<span class="psc-1">1</span>] <span class="psc-4">and</span> <span class="psc-6">close</span>[<span class="psc-1">1</span>] <span class="psc-4">></span> <span class="psc-6">open</span>[<span class="psc-1">1</span>]

<span class="psc-5">bgcolor</span>(signal <span class="psc-4">?</span> c <span class="psc-4">:</span> <span class="psc-6">na</span>)</code></pre>
                    </div>
                    <p>Повторяем теорию:</p>
                    <ul>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_input.color"
                          target="_blank"
                          class="underline"
                          >input.color()</a
                        >
                        добавляет в настройки скрипта виджет для выбора цвета;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_color.new"
                          target="_blank"
                          class="underline"
                          >color.new()</a
                        >
                        добавляет цвету прозрачность;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_bgcolor"
                          target="_blank"
                          class="underline"
                          >bgcolor()</a
                        >
                        закрашивает фон баров указанным цветом.
                      </li>
                    </ul>
                    <div class="note-box">
                      <div class="note-box-header">На заметку</div>
                      <p>
                        <a
                          href="https://www.tradingview.com/pine-script-docs/language/operators/#--history-referencing-operator"
                          target="_blank"
                          class="underline"
                          >Оператор обращения к истории []</a
                        >
                        позволяет обращаться к пяти тысячам последним значениям
                        временного ряда. То есть максимально возможное значение
                        внутри скобок равно <em>4999</em>.
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>
          <section id="section-9">
            <h4>Задача #9. Счётчик пересечений</h4>
            <p>Написать индикатор.</p>
            <h5>Ввод</h5>
            <p>Источник для расчётов S.</p>
            <p>Целое число L. Минимальное значение: <em>1</em>.</p>
            <h5>Основные вычисления</h5>
            <p>Объёмно-взвешенное скользящее среднее данных S длиной L.</p>
            <p>
              Счётчик, увеличивающийся на единицу, если серия цен закрытия
              баров пересеклась с серией значений скользящего среднего. Счётчик
              должен содержать число случившихся пересечений.
            </p>
            <h5>Вывод</h5>
            <p>Значение счётчика объектом <em>label</em> на последнем баре.</p>
            <p>Скользящее среднее объектом <em>plot</em>.</p>
            <a href="images/tasks/task-9-L.png" class="image">
              <img
                src="images/tasks/task-9-L.png"
                class="img-fluid img-thumbnail"
              />
            </a>
            <div class="accordion" id="task-9">
              <div class="accordion-item">
                <div class="accordion-header">
                  <button
                    class="accordion-button collapsed"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#collapse-9"
                  >
                    Решение
                  </button>
                </div>
                <div
                  id="collapse-9"
                  class="accordion-collapse collapse"
                  data-bs-parent="#task-9"
                >
                  <div class="accordion-body">
                    <div class="code-box">
                      <pre><code><span class="psc-3">//@version=6</span>
<span class="psc-5">indicator</span>(<span class="psc-2">"Task #9"</span><span class="psc-4">,</span> overlay <span class="psc-4">=</span> <span class="psc-6">true</span>)

s <span class="psc-4">=</span> <span class="psc-5">input.source</span>(<span class="psc-6">low</span><span class="psc-4">,</span> <span class="psc-2">"S"</span>)
l <span class="psc-4">=</span> <span class="psc-5">input.int</span>(<span class="psc-1">3</span><span class="psc-4">,</span> <span class="psc-2">"L"</span><span class="psc-4">,</span> <span class="psc-1">1</span>)

<span class="psc-4">var</span> counter <span class="psc-4">=</span> <span class="psc-1">0</span>
vwma <span class="psc-4">=</span> <span class="psc-5">ta.vwma</span>(s<span class="psc-4">,</span> l)

<span class="psc-4">if</span> <span class="psc-5">ta.cross</span>(<span class="psc-6">close</span><span class="psc-4">,</span> vwma)
    counter <span class="psc-4">+=</span> <span class="psc-1">1</span>

<span class="psc-4">if</span> <span class="psc-6">barstate.islast</span>
    <span class="psc-5">label.new</span>(
      x <span class="psc-4">=</span> <span class="psc-6">bar_index</span><span class="psc-4">,</span>
      y <span class="psc-4">=</span> <span class="psc-6">na</span><span class="psc-4">,</span>
      text <span class="psc-4">=</span> <span class="psc-5">str.tostring</span>(counter)<span class="psc-4">,</span>
      yloc <span class="psc-4">=</span> <span class="psc-6">yloc.abovebar</span><span class="psc-4">,</span>
      style <span class="psc-4">=</span> <span class="psc-6">label.style_label_center</span><span class="psc-4">,</span>
      textcolor <span class="psc-4">=</span> <span class="psc-6">color.white</span><span class="psc-4">,</span>
      size <span class="psc-4">=</span> <span class="psc-6">size.large</span>
      )

<span class="psc-5">plot</span>(vwma<span class="psc-4">,</span> linewidth <span class="psc-4">=</span> <span class="psc-1">2</span>)</code></pre>
                    </div>
                    <p>Повторяем теорию:</p>
                    <ul>
                      <li>
                        переменная
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#var_low"
                          target="_blank"
                          class="underline"
                          >low</a
                        >
                        содержит цену минимума текущего бара;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_ta.vwma"
                          target="_blank"
                          class="underline"
                          >ta.vwma()</a
                        >
                        возвращает объёмно-взвешенное скользящее среднее;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_ta.cross"
                          target="_blank"
                          class="underline"
                          >ta.cross()</a
                        >
                        возвращает значение <em>true</em>, если серии значений
                        двух указанных аргументов пересеклись, иначе возвращает
                        значение <em>false</em>.
                      </li>
                    </ul>
                    <div class="note-box">
                      <div class="note-box-header">На заметку</div>
                      <p>
                        Для присвоения значения ранее объявленной переменной,
                        вместо
                        <a
                          href="https://www.tradingview.com/pine-script-docs/language/operators/#-reassignment-operator"
                          target="_blank"
                          class="underline"
                          >оператора переназначения :=</a
                        >, можно использовать операторы, которые выполняют
                        арифметическую операцию и присваивают результат
                        переменной. Например,
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#op_+="
                          target="_blank"
                          class="underline"
                          >оператор увеличения +=</a
                        >. Это делает код компактнее.
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>
          <section id="section-10">
            <h4>Задача #10. Счётчик обновлений</h4>
            <p>Написать индикатор.</p>
            <h5>Ввод</h5>
            <p>Отсутствует.</p>
            <h5>Основные вычисления</h5>
            <p>
              Счётчик, увеличивающийся на единицу в случае обновления бара
              реального времени. Появление бара реального времени считается
              первым обновлением. Счётчик должен содержать число случившихся
              обновлений.
            </p>
            <p>
              Геометрическая фигура для объекта <em>label</em> в зависимости от
              значения счётчика. Если значение счётчика кратно трём, то
              геометрическая фигура — круг. Если значение счётчика кратно пяти,
              то геометрическая фигура — квадрат. Если значение счётчика кратно
              трём и пяти, то геометрическая фигура — треугольник.
            </p>
            <h5>Вывод</h5>
            <p>Значение счётчика объектом <em>label</em>.</p>
            <p>Геометрическая фигура объектом <em>label</em>.</p>
            <a href="images/tasks/task-10-L.png" class="image">
              <img
                src="images/tasks/task-10-L.png"
                class="img-fluid img-thumbnail"
              />
            </a>
            <div class="accordion" id="task-10">
              <div class="accordion-item">
                <div class="accordion-header">
                  <button
                    class="accordion-button collapsed"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#collapse-10"
                  >
                    Решение
                  </button>
                </div>
                <div
                  id="collapse-10"
                  class="accordion-collapse collapse"
                  data-bs-parent="#task-10"
                >
                  <div class="accordion-body">
                    <div class="code-box">
                      <pre><code><span class="psc-3">//@version=6</span>
<span class="psc-5">indicator</span>(<span class="psc-2">"Task #10"</span><span class="psc-4">,</span> overlay <span class="psc-4">=</span> <span class="psc-6">true</span>)

<span class="psc-4">varip</span> counter <span class="psc-4">=</span> <span class="psc-5">int</span>(<span class="psc-6">na</span>)
labelStyle <span class="psc-4">=</span> <span class="psc-5">string</span>(<span class="psc-6">na</span>)

<span class="psc-4">if</span> <span class="psc-6">barstate.isnew</span>
    counter <span class="psc-4">:=</span> <span class="psc-1">1</span>
<span class="psc-4">else</span>
    counter <span class="psc-4">+=</span> <span class="psc-1">1</span>

<span class="psc-4">if</span> <span class="psc-6">barstate.islast</span>
    <span class="psc-4">if</span> counter <span class="psc-4">%</span> <span class="psc-1">3</span> <span class="psc-4">==</span> <span class="psc-1">0</span> <span class="psc-4">and</span> counter <span class="psc-4">%</span> <span class="psc-1">5</span> <span class="psc-4">==</span> <span class="psc-1">0</span>
        labelStyle <span class="psc-4">:=</span> <span class="psc-6">label.style_triangleup</span>
    <span class="psc-4">else</span> <span class="psc-4">if</span> counter <span class="psc-4">%</span> <span class="psc-1">3</span> <span class="psc-4">==</span> <span class="psc-1">0</span>
        labelStyle <span class="psc-4">:=</span> <span class="psc-6">label.style_circle</span>
    <span class="psc-4">else</span> <span class="psc-4">if</span> counter <span class="psc-4">%</span> <span class="psc-1">5</span> <span class="psc-4">==</span> <span class="psc-1">0</span>
        labelStyle <span class="psc-4">:=</span> <span class="psc-6">label.style_square</span>
    <span class="psc-4">else</span>
        labelStyle <span class="psc-4">:=</span> <span class="psc-6">label.style_none</span>

    <span class="psc-5">label.new</span>(
      x <span class="psc-4">=</span> <span class="psc-6">bar_index</span><span class="psc-4">,</span>
      y <span class="psc-4">=</span> <span class="psc-6">na</span><span class="psc-4">,</span>
      text <span class="psc-4">=</span> <span class="psc-5">str.tostring</span>(counter)<span class="psc-4">,</span>
      yloc <span class="psc-4">=</span> <span class="psc-6">yloc.belowbar</span><span class="psc-4">,</span>
      style <span class="psc-4">=</span> <span class="psc-6">label.style_label_center</span><span class="psc-4">,</span>
      textcolor <span class="psc-4">=</span> <span class="psc-6">color.white</span><span class="psc-4">,</span>
      size <span class="psc-4">=</span> <span class="psc-6">size.large</span>
      )
    <span class="psc-5">label.new</span>(
      x <span class="psc-4">=</span> <span class="psc-6">bar_index</span><span class="psc-4">,</span>
      y <span class="psc-4">=</span> <span class="psc-6">na</span><span class="psc-4">,</span>
      yloc <span class="psc-4">=</span> <span class="psc-6">yloc.abovebar</span><span class="psc-4">,</span>
      style <span class="psc-4">=</span> labelStyle<span class="psc-4">,</span>
      size <span class="psc-4">=</span> <span class="psc-6">size.large</span>
      )</code></pre>
                    </div>
                    <p>Повторяем теорию:</p>
                    <ul>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_string"
                          target="_blank"
                          class="underline"
                          >string()</a
                        >
                        преобразует значение аргумента в значение типа
                        <em>string</em>;
                      </li>
                      <li>
                        переменная
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#var_barstate.isnew"
                          target="_blank"
                          class="underline"
                          >barstate.isnew</a
                        >
                        имеет значение <em>true</em>, если текущий бар является
                        историческим баром или новым (первое обновление) баром
                        реального времени, иначе переменная имеет значение
                        <em>false</em>.
                      </li>
                    </ul>
                    <div class="note-box">
                      <div class="note-box-header">На заметку</div>
                      <p>
                        Порядок условий в
                        <a
                          href="https://www.tradingview.com/pine-script-docs/language/conditional-structures/"
                          target="_blank"
                          class="underline"
                          >условных конструкциях</a
                        >
                        часто имеет большое значение.
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>
          <section id="section-11">
            <h4>Задача #11. Калькулятор</h4>
            <p>Написать индикатор.</p>
            <h5>Ввод</h5>
            <p>
              Строка с типом арифметической операции T. Значения списка опций:
              <em>"+"</em>, <em>"-"</em>, <em>"/"</em>, <em>"*"</em>,
              <em>"%"</em>, <em>"^"</em>, <em>"//"</em>.
            </p>
            <p>Вещественное число N1.</p>
            <p>Вещественное число N2.</p>
            <h5>Основные вычисления</h5>
            <p>
              Арифметическая операция T с числами N1 и N2. Поддерживаемые типы
              операций: сложение (+), вычитание (-), деление (/), умножение
              (*), взятие остатка от деления (%), возведение в степень (^),
              целочисленное деление (//). Деление на ноль должно приводить к
              ошибке времени выполнения с сообщением «division by zero».
            </p>
            <h5>Вывод</h5>
            <p>Результат арифметической операции объектом <em>label</em>.</p>
            <a href="images/tasks/task-11-L.png" class="image">
              <img
                src="images/tasks/task-11-L.png"
                class="img-fluid img-thumbnail"
              />
            </a>
            <div class="accordion" id="task-11">
              <div class="accordion-item">
                <div class="accordion-header">
                  <button
                    class="accordion-button collapsed"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#collapse-11"
                  >
                    Решение
                  </button>
                </div>
                <div
                  id="collapse-11"
                  class="accordion-collapse collapse"
                  data-bs-parent="#task-11"
                >
                  <div class="accordion-body">
                    <div class="code-box">
                      <pre><code><span class="psc-3">//@version=6</span>
<span class="psc-5">indicator</span>(<span class="psc-2">"Task #11"</span><span class="psc-4">,</span> overlay <span class="psc-4">=</span> <span class="psc-6">true</span>)

t <span class="psc-4">=</span> <span class="psc-5">input.string</span>(<span class="psc-2">"+"</span><span class="psc-4">,</span> <span class="psc-2">"T"</span><span class="psc-4">,</span> [<span class="psc-2">"+"</span><span class="psc-4">,</span> <span class="psc-2">"-"</span><span class="psc-4">,</span> <span class="psc-2">"/"</span><span class="psc-4">,</span> <span class="psc-2">"*"</span><span class="psc-4">,</span> <span class="psc-2">"%"</span><span class="psc-4">,</span> <span class="psc-2">"^"</span><span class="psc-4">,</span> <span class="psc-2">"//"</span>])
n1 <span class="psc-4">=</span> <span class="psc-5">input.float</span>(<span class="psc-1">10.0</span><span class="psc-4">,</span> <span class="psc-2">"N1"</span>)
n2 <span class="psc-4">=</span> <span class="psc-5">input.float</span>(<span class="psc-1">5.0</span><span class="psc-4">,</span> <span class="psc-2">"N2"</span>)

<span class="psc-7">createLabel</span>(txt) <span class="psc-4">=></span>
    <span class="psc-5">label.new</span>(
      x <span class="psc-4">=</span> <span class="psc-6">bar_index</span><span class="psc-4">,</span>
      y <span class="psc-4">=</span> <span class="psc-6">na</span><span class="psc-4">,</span>
      text <span class="psc-4">=</span> <span class="psc-5">str.tostring</span>(txt)<span class="psc-4">,</span>
      yloc <span class="psc-4">=</span> <span class="psc-6">yloc.abovebar</span><span class="psc-4">,</span>
      style <span class="psc-4">=</span> <span class="psc-6">label.style_label_center</span><span class="psc-4">,</span>
      textcolor <span class="psc-4">=</span> <span class="psc-6">color.white</span><span class="psc-4">,</span>
      size <span class="psc-4">=</span> <span class="psc-6">size.large</span>
      )

<span class="psc-4">if</span> <span class="psc-6">barstate.islast</span>
    <span class="psc-4">switch</span>
        (t <span class="psc-4">==</span> <span class="psc-2">"/"</span> <span class="psc-4">or</span> t <span class="psc-4">==</span> <span class="psc-2">"%"</span> <span class="psc-4">or</span> t <span class="psc-4">==</span> <span class="psc-2">"//"</span>) <span class="psc-4">and</span> n2 <span class="psc-4">==</span> <span class="psc-1">0</span> <span class="psc-4">=></span>
            <span class="psc-5">runtime.error</span>(<span class="psc-2">"division by zero"</span>)
        t <span class="psc-4">==</span> <span class="psc-2">"+"</span> <span class="psc-4">=></span> <span class="psc-7">createLabel</span>(n1 <span class="psc-4">+</span> n2)
        t <span class="psc-4">==</span> <span class="psc-2">"-"</span> <span class="psc-4">=></span> <span class="psc-7">createLabel</span>(n1 <span class="psc-4">-</span> n2)
        t <span class="psc-4">==</span> <span class="psc-2">"/"</span> <span class="psc-4">=></span> <span class="psc-7">createLabel</span>(n1 <span class="psc-4">/</span> n2)
        t <span class="psc-4">==</span> <span class="psc-2">"*"</span> <span class="psc-4">=></span> <span class="psc-7">createLabel</span>(n1 <span class="psc-4">*</span> n2)
        t <span class="psc-4">==</span> <span class="psc-2">"%"</span> <span class="psc-4">=></span> <span class="psc-7">createLabel</span>(n1 <span class="psc-4">%</span> n2)
        t <span class="psc-4">==</span> <span class="psc-2">"^"</span> <span class="psc-4">=></span> <span class="psc-7">createLabel</span>(<span class="psc-5">math.pow</span>(n1<span class="psc-4">,</span> n2))
        t <span class="psc-4">==</span> <span class="psc-2">"//"</span> <span class="psc-4">=></span> <span class="psc-7">createLabel</span>(<span class="psc-5">int</span>(n1 <span class="psc-4">/</span> n2))</code></pre>
                    </div>
                    <p>Повторяем теорию:</p>
                    <ul>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_input.float"
                          target="_blank"
                          class="underline"
                          >input.float()</a
                        >
                        добавляет в настройки скрипта поле для ввода
                        вещественного числа;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_runtime.error"
                          target="_blank"
                          class="underline"
                          >runtime.error()</a
                        >
                        вызывает ошибку времени выполнения;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_math.pow"
                          target="_blank"
                          class="underline"
                          >math.pow()</a
                        >
                        возводит число в степень.
                      </li>
                    </ul>
                    <div class="note-box">
                      <div class="note-box-header">На заметку</div>
                      <p>
                        Конструкция
                        <a
                          href="https://www.tradingview.com/pine-script-docs/language/conditional-structures/#switch-structure"
                          target="_blank"
                          class="underline"
                          >switch</a
                        >
                        бывает двух видов: с выражением и без выражения.
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>
          <section id="section-12">
            <h4>Задача #12. Среднее значение</h4>
            <p>Написать индикатор.</p>
            <h5>Ввод</h5>
            <p>Целое число N1.</p>
            <p>Целое число N2.</p>
            <h5>Основные вычисления</h5>
            <p>
              Среднее арифметическое чисел из закрытого интервала [N1; N2],
              которые кратны трём.
            </p>
            <h5>Вывод</h5>
            <p>
              Среднее арифметическое объектом <em>label</em> на последнем
              историческом баре, если текущий таймфрейм графика является
              дневным, недельным или месячным.
            </p>
            <a href="images/tasks/task-12-L.png" class="image">
              <img
                src="images/tasks/task-12-L.png"
                class="img-fluid img-thumbnail"
              />
            </a>
            <div class="accordion" id="task-12">
              <div class="accordion-item">
                <div class="accordion-header">
                  <button
                    class="accordion-button collapsed"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#collapse-12"
                  >
                    Решение
                  </button>
                </div>
                <div
                  id="collapse-12"
                  class="accordion-collapse collapse"
                  data-bs-parent="#task-12"
                >
                  <div class="accordion-body">
                    <div class="code-box">
                      <pre><code><span class="psc-3">//@version=6</span>
<span class="psc-5">indicator</span>(<span class="psc-2">"Task #12"</span><span class="psc-4">,</span> overlay <span class="psc-4">=</span> <span class="psc-6">true</span>)

n1 <span class="psc-4">=</span> <span class="psc-5">input.int</span>(<span class="psc-1">-6</span><span class="psc-4">,</span> <span class="psc-2">"N1"</span>)
n2 <span class="psc-4">=</span> <span class="psc-5">input.int</span>(<span class="psc-1">15</span><span class="psc-4">,</span> <span class="psc-2">"N2"</span>)

<span class="psc-4">if</span> <span class="psc-6">barstate.islastconfirmedhistory</span> <span class="psc-4">and</span> <span class="psc-6">timeframe.isdwm</span>
    sum <span class="psc-4">=</span> <span class="psc-1">0</span>
    n <span class="psc-4">=</span> <span class="psc-1">0</span>

    <span class="psc-4">for</span> i <span class="psc-4">=</span> n1 <span class="psc-4">to</span> n2
        <span class="psc-4">if</span> i <span class="psc-4">%</span> <span class="psc-1">3</span> <span class="psc-4">==</span> <span class="psc-1">0</span>
            sum <span class="psc-4">+=</span> i
            n <span class="psc-4">+=</span> <span class="psc-1">1</span>

    avg <span class="psc-4">=</span> <span class="psc-4">if</span> n <span class="psc-4">!=</span> <span class="psc-1">0</span>
        sum <span class="psc-4">/</span> n
    <span class="psc-4">else</span>
        <span class="psc-5">float</span>(<span class="psc-6">na</span>)
    
    <span class="psc-5">label.new</span>(
      x <span class="psc-4">=</span> <span class="psc-6">bar_index</span><span class="psc-4">,</span>
      y <span class="psc-4">=</span> <span class="psc-6">na</span><span class="psc-4">,</span>
      text <span class="psc-4">=</span> <span class="psc-5">str.tostring</span>(avg)<span class="psc-4">,</span>
      yloc <span class="psc-4">=</span> <span class="psc-6">yloc.abovebar</span><span class="psc-4">,</span>
      style <span class="psc-4">=</span> <span class="psc-6">label.style_label_center</span><span class="psc-4">,</span>
      textcolor <span class="psc-4">=</span> <span class="psc-6">color.white</span><span class="psc-4">,</span>
      size <span class="psc-4">=</span> <span class="psc-6">size.large</span>
      )</code></pre>
                    </div>
                    <p>Повторяем теорию:</p>
                    <ul>
                      <li>
                        переменная
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#var_barstate.islastconfirmedhistory"
                          target="_blank"
                          class="underline"
                          >barstate.islastconfirmedhistory</a
                        >
                        имеет значение <em>true</em>, если текущий бар является
                        последним историческим баром графика, иначе переменная
                        имеет значение <em>false</em>;
                      </li>
                      <li>
                        переменная
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#var_timeframe.isdwm"
                          target="_blank"
                          class="underline"
                          >timeframe.isdwm</a
                        >
                        имеет значение <em>true</em>, если текущий таймфрейм
                        графика является дневным, недельным или месячным, иначе
                        переменная имеет значение <em>false</em>.
                      </li>
                    </ul>
                    <div class="note-box">
                      <div class="note-box-header">На заметку</div>
                      <p>
                        <a
                          href="https://www.tradingview.com/pine-script-docs/language/loops/"
                          target="_blank"
                          class="underline"
                          >Циклы</a
                        >
                        следует использовать в случае отсутствия подходящих
                        встроенных функций.
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>
          <section id="section-13">
            <h4>Задача #13. Сумма цен</h4>
            <p>Написать индикатор.</p>
            <h5>Ввод</h5>
            <p>Цена P. Значение интерактивного режима: <em>true</em>.</p>
            <p>Целое число N. Минимальное значение: <em>1</em>.</p>
            <h5>Основные вычисления</h5>
            <p>
              Сумма цен закрытия баров. Вычисление должно начаться на последнем
              историческом баре и выполняться до тех пор, пока вычисляемая
              сумма цен меньше цены P. Если при вычислении суммы встречается N
              баров подряд, у которых цена закрытия меньше цены открытия, то
              вычисление суммы завершается. Цены закрытия баров, у которых цена
              закрытия меньше цены открытия, не должны учитываться при
              вычислении суммы.
            </p>
            <h5>Вывод</h5>
            <p>
              Сумма цен закрытия баров объектом
              <em>label</em> на баре, на котором завершилось вычисление суммы,
              если текущий таймфрейм графика является минутным или секундным.
            </p>
            <a href="images/tasks/task-13-L.png" class="image">
              <img
                src="images/tasks/task-13-L.png"
                class="img-fluid img-thumbnail"
              />
            </a>
            <div class="accordion" id="task-13">
              <div class="accordion-item">
                <div class="accordion-header">
                  <button
                    class="accordion-button collapsed"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#collapse-13"
                  >
                    Решение
                  </button>
                </div>
                <div
                  id="collapse-13"
                  class="accordion-collapse collapse"
                  data-bs-parent="#task-13"
                >
                  <div class="accordion-body">
                    <div class="code-box">
                      <pre><code><span class="psc-3">//@version=6</span>
<span class="psc-5">indicator</span>(<span class="psc-2">"Task #13"</span><span class="psc-4">,</span> overlay <span class="psc-4">=</span> <span class="psc-6">true</span>)

p <span class="psc-4">=</span> <span class="psc-5">input.price</span>(<span class="psc-1">0</span><span class="psc-4">,</span> <span class="psc-2">"P"</span><span class="psc-4">,</span> confirm <span class="psc-4">=</span> <span class="psc-6">true</span>)
n <span class="psc-4">=</span> <span class="psc-5">input.int</span>(<span class="psc-1">3</span><span class="psc-4">,</span> <span class="psc-2">"N"</span><span class="psc-4">,</span> <span class="psc-1">1</span>)

<span class="psc-4">if</span> <span class="psc-6">barstate.islastconfirmedhistory</span> <span class="psc-4">and</span> <span class="psc-6">timeframe.isintraday</span>
    sum <span class="psc-4">=</span> <span class="psc-1">0.0</span>
    index <span class="psc-4">=</span> <span class="psc-1">0</span>
    counter <span class="psc-4">=</span> <span class="psc-1">0</span>

    <span class="psc-4">while</span> sum <span class="psc-4"><</span> p
        <span class="psc-4">if</span> <span class="psc-6">close</span>[index] <span class="psc-4"><</span> <span class="psc-6">open</span>[index]
            index <span class="psc-4">+=</span> <span class="psc-1">1</span>
            counter <span class="psc-4">+=</span> <span class="psc-1">1</span>

            <span class="psc-4">if</span> counter <span class="psc-4">==</span> n
                <span class="psc-4">break</span>
            <span class="psc-4">else</span>
                <span class="psc-4">continue</span>

        sum <span class="psc-4">+=</span> <span class="psc-6">close</span>[index]
        index <span class="psc-4">+=</span> <span class="psc-1">1</span>
        counter <span class="psc-4">:=</span> <span class="psc-1">0</span>

    <span class="psc-5">label.new</span>(
      x <span class="psc-4">=</span> <span class="psc-6">bar_index</span>[index <span class="psc-4">></span> <span class="psc-1">0</span> <span class="psc-4">?</span> index <span class="psc-4">-</span> <span class="psc-1">1</span> <span class="psc-4">:</span> <span class="psc-1">0</span>]<span class="psc-4">,</span>
      y <span class="psc-4">=</span> <span class="psc-6">high</span>[index <span class="psc-4">></span> <span class="psc-1">0</span> <span class="psc-4">?</span> index <span class="psc-4">-</span> <span class="psc-1">1</span> <span class="psc-4">:</span> <span class="psc-1">0</span>]<span class="psc-4">,</span>
      text <span class="psc-4">=</span> <span class="psc-5">str.tostring</span>(sum)<span class="psc-4">,</span>
      style <span class="psc-4">=</span> <span class="psc-6">label.style_label_down</span><span class="psc-4">,</span>
      textcolor <span class="psc-4">=</span> <span class="psc-6">color.white</span><span class="psc-4">,</span>
      size <span class="psc-4">=</span> <span class="psc-6">size.large</span>
      )</code></pre>
                    </div>
                    <p>Повторяем теорию:</p>
                    <ul>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_input.price"
                          target="_blank"
                          class="underline"
                          >input.price()</a
                        >
                        добавляет в настройки скрипта поле для ввода цены;
                      </li>
                      <li>
                        переменная
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#var_timeframe.isintraday"
                          target="_blank"
                          class="underline"
                          >timeframe.isintraday</a
                        >
                        имеет значение <em>true</em>, если текущий таймфрейм
                        графика является внутридневным (минутным или
                        секундным), иначе переменная имеет значение
                        <em>false</em>.
                      </li>
                    </ul>
                    <div class="note-box">
                      <div class="note-box-header">На заметку</div>
                      <p>
                        Инструкции <em>continue</em> и <em>break</em> всегда
                        следует добавлять в циклы, логика которых это
                        позволяет. Такой подход экономит вычислительные ресурсы
                        и ускоряет выполнение скриптов.
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>
          <section id="section-14">
            <h4>Задача #14. Старший таймфрейм</h4>
            <p>Написать индикатор.</p>
            <h5>Ввод</h5>
            <p>Таймфрейм T.</p>
            <h5>Основные вычисления</h5>
            <p>
              Запрос цен открытия, максимума, минимума и закрытия баров с
              таймфрейма T. Введённый таймфрейм должен быть больше текущего
              таймфрейма графика. При этом ввод текущего или меньшего
              таймфрейма должен приводить к ошибке времени выполнения с
              сообщением «invalid timeframe».
            </p>
            <h5>Вывод</h5>
            <p>OHLC-бары с таймфрейма T.</p>
            <a href="images/tasks/task-14-L.png" class="image">
              <img
                src="images/tasks/task-14-L.png"
                class="img-fluid img-thumbnail"
              />
            </a>
            <div class="accordion" id="task-14">
              <div class="accordion-item">
                <div class="accordion-header">
                  <button
                    class="accordion-button collapsed"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#collapse-14"
                  >
                    Решение
                  </button>
                </div>
                <div
                  id="collapse-14"
                  class="accordion-collapse collapse"
                  data-bs-parent="#task-14"
                >
                  <div class="accordion-body">
                    <div class="code-box">
                      <pre><code><span class="psc-3">//@version=6</span>
<span class="psc-5">indicator</span>(<span class="psc-2">"Task #14"</span>)

t <span class="psc-4">=</span> <span class="psc-5">input.timeframe</span>(<span class="psc-2">"12M"</span><span class="psc-4">,</span> <span class="psc-2">"T"</span>)

<span class="psc-4">if</span> <span class="psc-5">timeframe.in_seconds</span>(t) <span class="psc-4"><=</span> <span class="psc-5">timeframe.in_seconds</span>()
    <span class="psc-5">runtime.error</span>(<span class="psc-2">"invalid timeframe"</span>)

[o<span class="psc-4">,</span> h<span class="psc-4">,</span> l<span class="psc-4">,</span> c] <span class="psc-4">=</span> <span class="psc-5">request.security</span>(
  symbol <span class="psc-4">=</span> <span class="psc-6">syminfo.tickerid</span><span class="psc-4">,</span> 
  timeframe <span class="psc-4">=</span> t<span class="psc-4">,</span> 
  expression <span class="psc-4">=</span> [<span class="psc-6">open</span>[<span class="psc-1">1</span>]<span class="psc-4">,</span> <span class="psc-6">high</span>[<span class="psc-1">1</span>]<span class="psc-4">,</span> <span class="psc-6">low</span>[<span class="psc-1">1</span>]<span class="psc-4">,</span> <span class="psc-6">close</span>[<span class="psc-1">1</span>]]<span class="psc-4">,</span>
  gaps <span class="psc-4">=</span> <span class="psc-6">barmerge.gaps_on</span><span class="psc-4">,</span>
  lookahead <span class="psc-4">=</span> <span class="psc-6">barmerge.lookahead_on</span>
  )

<span class="psc-5">plotbar</span>(o<span class="psc-4">,</span> h<span class="psc-4">,</span> l<span class="psc-4">,</span> c<span class="psc-4">,</span> color <span class="psc-4">=</span> c <span class="psc-4">>=</span> o <span class="psc-4">?</span> <span class="psc-6">color.teal</span> <span class="psc-4">:</span> <span class="psc-6">color.red</span>)</code></pre>
                    </div>
                    <p>Повторяем теорию:</p>
                    <ul>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_input.timeframe"
                          target="_blank"
                          class="underline"
                          >input.timeframe()</a
                        >
                        добавляет в настройки скрипта выпадающее меню для
                        выбора таймфрейма;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_timeframe.in_seconds"
                          target="_blank"
                          class="underline"
                          >timeframe.in_seconds()</a
                        >
                        преобразует строку таймфрейма в секунды;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_request.security"
                          target="_blank"
                          class="underline"
                          >request.security()</a
                        >
                        запрашивает данные по указанному символу и таймфрейму;
                      </li>
                      <li>
                        переменная
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#var_syminfo.tickerid"
                          target="_blank"
                          class="underline"
                          >syminfo.tickerid</a
                        >
                        содержит полную форму идентификатора тикера текущего
                        символа;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_plotbar"
                          target="_blank"
                          class="underline"
                          >plotbar()</a
                        >
                        отображает OHLC-бары на графике.
                      </li>
                    </ul>
                    <div class="note-box">
                      <div class="note-box-header">На заметку</div>
                      <p>
                        Использование функции
                        <a
                          href="https://www.tradingview.com/pine-script-docs/concepts/other-timeframes-and-data/#requestsecurity"
                          target="_blank"
                          class="underline"
                          >request.security()</a
                        >
                        может приводить скрипт к
                        <a
                          href="https://www.tradingview.com/pine-script-docs/concepts/repainting/"
                          target="_blank"
                          class="underline"
                          >перерисовке</a
                        >.
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>
          <section id="section-15">
            <h4>Задача #15. Младший таймфрейм</h4>
            <p>Написать индикатор.</p>
            <h5>Ввод</h5>
            <p>Таймфрейм T.</p>
            <p>Целое число N. Минимальное значение: <em>0</em>.</p>
            <h5>Основные вычисления</h5>
            <p>
              Запрос цен открытия, максимума, минимума и закрытия баров с
              таймфрейма T. Введённый таймфрейм должен быть меньше или равен
              текущему таймфрейму графика. При этом ввод большего таймфрейма не
              должен приводить к ошибке времени выполнения.
            </p>
            <p>
              Уменьшение числа N, если на текущем баре не существует бара под
              номером N (отсчёт начинается с нуля) с таймфрейма T. В таком
              случае число N приравнивается к номеру последнего бара с
              таймфрейма T.
            </p>
            <h5>Вывод</h5>
            <p>OHLC-бары с таймфрейма T под номером N.</p>
            <a href="images/tasks/task-15-L.png" class="image">
              <img
                src="images/tasks/task-15-L.png"
                class="img-fluid img-thumbnail"
              />
            </a>
            <div class="accordion" id="task-15">
              <div class="accordion-item">
                <div class="accordion-header">
                  <button
                    class="accordion-button collapsed"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#collapse-15"
                  >
                    Решение
                  </button>
                </div>
                <div
                  id="collapse-15"
                  class="accordion-collapse collapse"
                  data-bs-parent="#task-15"
                >
                  <div class="accordion-body">
                    <div class="code-box">
                      <pre><code><span class="psc-3">//@version=6</span>
<span class="psc-5">indicator</span>(<span class="psc-2">"Task #15"</span>)

t <span class="psc-4">=</span> <span class="psc-5">input.timeframe</span>(<span class="psc-2">"1D"</span><span class="psc-4">,</span> <span class="psc-2">"T"</span>)
n <span class="psc-4">=</span> <span class="psc-5">input.int</span>(<span class="psc-1">0</span><span class="psc-4">,</span> <span class="psc-2">"N"</span><span class="psc-4">,</span> <span class="psc-1">0</span>)

[o<span class="psc-4">,</span> h<span class="psc-4">,</span> l<span class="psc-4">,</span> c] <span class="psc-4">=</span> <span class="psc-5">request.security_lower_tf</span>(
  symbol <span class="psc-4">=</span> <span class="psc-6">syminfo.tickerid</span><span class="psc-4">,</span> 
  timeframe <span class="psc-4">=</span> t<span class="psc-4">,</span> 
  expression <span class="psc-4">=</span> [<span class="psc-6">open</span><span class="psc-4">,</span> <span class="psc-6">high</span><span class="psc-4">,</span> <span class="psc-6">low</span><span class="psc-4">,</span> <span class="psc-6">close</span>]<span class="psc-4">,</span>
  ignore_invalid_timeframe <span class="psc-4">=</span> <span class="psc-6">true</span>
  )

<span class="psc-4">if</span> <span class="psc-5">na</span>(c)
    o <span class="psc-4">:=</span> <span class="psc-5">array.new_float</span>(<span class="psc-1">1</span>)
    h <span class="psc-4">:=</span> <span class="psc-5">array.new_float</span>(<span class="psc-1">1</span>)
    l <span class="psc-4">:=</span> <span class="psc-5">array.new_float</span>(<span class="psc-1">1</span>)
    c <span class="psc-4">:=</span> <span class="psc-5">array.new_float</span>(<span class="psc-1">1</span>)

<span class="psc-4">if</span> n <span class="psc-4">>=</span> <span class="psc-5">array.size</span>(c)
    n <span class="psc-4">:=</span> <span class="psc-5">array.size</span>(c) <span class="psc-4">-</span> <span class="psc-1">1</span>

<span class="psc-5">plotbar</span>(
  open <span class="psc-4">=</span> <span class="psc-5">array.get</span>(o<span class="psc-4">,</span> n)<span class="psc-4">,</span>
  high <span class="psc-4">=</span> <span class="psc-5">array.get</span>(h<span class="psc-4">,</span> n)<span class="psc-4">,</span>
  low <span class="psc-4">=</span> <span class="psc-5">array.get</span>(l<span class="psc-4">,</span> n)<span class="psc-4">,</span>
  close <span class="psc-4">=</span> <span class="psc-5">array.get</span>(c<span class="psc-4">,</span> n)<span class="psc-4">,</span>
  color <span class="psc-4">=</span> <span class="psc-5">array.get</span>(c<span class="psc-4">,</span> n) <span class="psc-4">>=</span> <span class="psc-5">array.get</span>(o<span class="psc-4">,</span> n) <span class="psc-4">?</span> <span class="psc-6">color.teal</span> <span class="psc-4">:</span> <span class="psc-6">color.red</span>
  )</code></pre>
                    </div>
                    <p>Повторяем теорию:</p>
                    <ul>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_request.security_lower_tf"
                          target="_blank"
                          class="underline"
                          >request.security_lower_tf()</a
                        >
                        запрашивает данные по указанному символу и таймфрейму,
                        меньшему или равному текущему таймфрейму графика;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_na"
                          target="_blank"
                          class="underline"
                          >na()</a
                        >
                        возвращает значение <em>true</em>, если аргумент равен
                        <em>na</em>, иначе возвращает значение <em>false</em>;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_array.new_float"
                          target="_blank"
                          class="underline"
                          >array.new_float()</a
                        >
                        создаёт объект <em>array</em>, предназначенный для
                        хранения элементов типа <em>float</em>;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_array.size"
                          target="_blank"
                          class="underline"
                          >array.size()</a
                        >
                        возвращает число элементов в объекте
                        <em>array</em>;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_array.get"
                          target="_blank"
                          class="underline"
                          >array.get()</a
                        >
                        возвращает значение элемента объекта <em>array</em> по
                        указанному индексу.
                      </li>
                    </ul>
                    <div class="note-box">
                      <div class="note-box-header">На заметку</div>
                      <p>
                        Для запроса данных с меньшего таймфрейма следует
                        использовать функцию
                        <a
                          href="https://www.tradingview.com/pine-script-docs/concepts/other-timeframes-and-data/#requestsecurity_lower_tf"
                          target="_blank"
                          class="underline"
                          >request.security_lower_tf()</a
                        >. Запрос таких данных функцией
                        <a
                          href="https://www.tradingview.com/pine-script-docs/concepts/other-timeframes-and-data/#lower-timeframes"
                          target="_blank"
                          class="underline"
                          >request.security()</a
                        >
                        приведёт к потери данных и перерисовке.
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>
          <section id="section-16">
            <h4>Задача #16. Мультипликатор</h4>
            <p>Написать индикатор.</p>
            <h5>Ввод</h5>
            <p>Тикер акций с префиксом биржи S.</p>
            <h5>Основные вычисления</h5>
            <p>
              Мультипликатор P/E (Price/Earnings per share) эмитента акций S.
            </p>
            <h5>Вывод</h5>
            <p>
              Значения мультипликатора P/E объектом <em>plot</em> в виде
              столбцов.
            </p>
            <a href="images/tasks/task-16-L.png" class="image">
              <img
                src="images/tasks/task-16-L.png"
                class="img-fluid img-thumbnail"
              />
            </a>
            <div class="accordion" id="task-16">
              <div class="accordion-item">
                <div class="accordion-header">
                  <button
                    class="accordion-button collapsed"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#collapse-16"
                  >
                    Решение
                  </button>
                </div>
                <div
                  id="collapse-16"
                  class="accordion-collapse collapse"
                  data-bs-parent="#task-16"
                >
                  <div class="accordion-body">
                    <div class="code-box">
                      <pre><code><span class="psc-3">//@version=6</span>
<span class="psc-5">indicator</span>(<span class="psc-2">"Task #16"</span>)

s <span class="psc-4">=</span> <span class="psc-5">input.symbol</span>(<span class="psc-2">"AAPL"</span><span class="psc-4">,</span> <span class="psc-2">"S"</span>)

price <span class="psc-4">=</span> <span class="psc-5">request.security</span>(
  symbol <span class="psc-4">=</span> s<span class="psc-4">,</span> 
  timeframe <span class="psc-4">=</span> <span class="psc-6">timeframe.period</span><span class="psc-4">,</span> 
  expression <span class="psc-4">=</span> <span class="psc-6">close</span>
  )
eps <span class="psc-4">=</span> <span class="psc-5">request.financial</span>(
  symbol <span class="psc-4">=</span> s<span class="psc-4">,</span>
  financial_id <span class="psc-4">=</span> <span class="psc-2">"EARNINGS_PER_SHARE_DILUTED"</span><span class="psc-4">,</span>
  period <span class="psc-4">=</span> <span class="psc-2">"TTM"</span>
  )
pe <span class="psc-4">=</span> price <span class="psc-4">/</span> eps

<span class="psc-5">plot</span>(pe<span class="psc-4">,</span> style <span class="psc-4">=</span> <span class="psc-6">plot.style_columns</span>)</code></pre>
                    </div>
                    <p>Повторяем теорию:</p>
                    <ul>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_input.symbol"
                          target="_blank"
                          class="underline"
                          >input.symbol()</a
                        >
                        добавляет в настройки скрипта поле для выбора символа;
                      </li>
                      <li>
                        переменная
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#var_timeframe.period"
                          target="_blank"
                          class="underline"
                          >timeframe.period</a
                        >
                        содержит строковое представление текущего таймфрейма;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_request.financial"
                          target="_blank"
                          class="underline"
                          >request.financial()</a
                        >
                        запрашивает финансовые данные по указанному символу.
                      </li>
                    </ul>
                    <div class="note-box">
                      <div class="note-box-header">На заметку</div>
                      <p>
                        Скрипт может содержать не больше 40 вызовов функций
                        пространства имён
                        <a
                          href="https://www.tradingview.com/pine-script-docs/writing/limitations/#request-calls"
                          target="_blank"
                          class="underline"
                          >request</a
                        >.
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>
          <section id="section-17">
            <h4>Задача #17. Cтрелки</h4>
            <p>Написать индикатор.</p>
            <h5>Ввод</h5>
            <p>Целое число L1. Минимальное значение: <em>1</em>.</p>
            <p>Целое число L2. Минимальное значение: <em>1</em>.</p>
            <p>Целое число L3. Минимальное значение: <em>1</em>.</p>
            <h5>Основные вычисления</h5>
            <p>
              Схождение/расхождение скользящих средних (MACD — Moving Average
              Convergence/Divergence), вычисляемое на основе цен закрытия баров
              с параметрами L1 (короткий период EMA), L2 (длинный период EMA) и
              L3 (период EMA от разницы двух других EMA — сигнальная линия
              MACD).
            </p>
            <p>
              Счётчик, который в случае пересечения серии значений основной
              линии MACD и серии значений сигнальной линии MACD фиксирует число
              баров с момента последнего противоположного пересечения.
            </p>
            <h5>Вывод</h5>
            <p>
              Стрелки на барах, на которых серия значений основной линии MACD
              пересеклась с серией значений сигнальной линии MACD. Если
              основная линия пересекла сигнальную линию снизу вверх, то стрелка
              направлена вверх. Если основная линия пересекла сигнальную линию
              сверху вниз, то стрелка направлена вниз. Длина стрелки должна
              зависеть от значения счётчика. Цвет стрелки должен зависеть от
              направления стрелки.
            </p>
            <a href="images/tasks/task-17-L.png" class="image">
              <img
                src="images/tasks/task-17-L.png"
                class="img-fluid img-thumbnail"
              />
            </a>
            <div class="accordion" id="task-17">
              <div class="accordion-item">
                <div class="accordion-header">
                  <button
                    class="accordion-button collapsed"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#collapse-17"
                  >
                    Решение
                  </button>
                </div>
                <div
                  id="collapse-17"
                  class="accordion-collapse collapse"
                  data-bs-parent="#task-17"
                >
                  <div class="accordion-body">
                    <div class="code-box">
                      <pre><code><span class="psc-3">//@version=6</span>
<span class="psc-5">indicator</span>(<span class="psc-2">"Task #17"</span><span class="psc-4">,</span> overlay <span class="psc-4">=</span> <span class="psc-6">true</span>)

l1 <span class="psc-4">=</span> <span class="psc-5">input.int</span>(<span class="psc-1">2</span><span class="psc-4">,</span> <span class="psc-2">"L1"</span><span class="psc-4">,</span> <span class="psc-1">1</span>)
l2 <span class="psc-4">=</span> <span class="psc-5">input.int</span>(<span class="psc-1">4</span><span class="psc-4">,</span> <span class="psc-2">"L2"</span><span class="psc-4">,</span> <span class="psc-1">1</span>)
l3 <span class="psc-4">=</span> <span class="psc-5">input.int</span>(<span class="psc-1">6</span><span class="psc-4">,</span> <span class="psc-2">"L3"</span><span class="psc-4">,</span> <span class="psc-1">1</span>)

[macdLine<span class="psc-4">,</span> signalLine<span class="psc-4">,</span> _] = <span class="psc-5">ta.macd</span>(<span class="psc-6">close</span><span class="psc-4">,</span> l1<span class="psc-4">,</span> l2<span class="psc-4">,</span> l3)
cross1 <span class="psc-4">=</span> <span class="psc-5">ta.crossover</span>(macdLine<span class="psc-4">,</span> signalLine)
cross2 <span class="psc-4">=</span> <span class="psc-5">ta.crossunder</span>(macdLine<span class="psc-4">,</span> signalLine)
bars1 <span class="psc-4">=</span> <span class="psc-5">ta.barssince</span>(cross1)
bars2 <span class="psc-4">=</span> <span class="psc-5">ta.barssince</span>(cross2)

counter <span class="psc-4">=</span> <span class="psc-4">if</span> cross1
    bars2
<span class="psc-4">else</span> <span class="psc-4">if</span> cross2
    <span class="psc-4">-</span>bars1

<span class="psc-5">plotarrow</span>(counter<span class="psc-4">,</span> colorup <span class="psc-4">=</span> <span class="psc-6">color.teal</span><span class="psc-4">,</span> colordown <span class="psc-4">=</span> <span class="psc-6">color.red</span>)</code></pre>
                    </div>
                    <p>Повторяем теорию:</p>
                    <ul>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_ta.macd"
                          target="_blank"
                          class="underline"
                          >ta.macd()</a
                        >
                        возвращает кортеж из трёх серий индикатора MACD:
                        основной линии MACD, сигнальной линии MACD и
                        гистограммы разности;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_ta.crossover"
                          target="_blank"
                          class="underline"
                          >ta.crossover()</a
                        >
                        возвращает значение <em>true</em>, если на текущем баре
                        значение первой серии больше значения второй серии, а
                        на предыдущем баре значение первой серии меньше или
                        равно значению второй серии, иначе возвращает значение
                        <em>false</em>;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_ta.crossunder"
                          target="_blank"
                          class="underline"
                          >ta.crossunder()</a
                        >
                        возвращает значение <em>true</em>, если на текущем баре
                        значение первой серии меньше значения второй серии, а
                        на предыдущем баре значение первой серии больше или
                        равно значению второй серии, иначе возвращает значение
                        <em>false</em>;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_ta.barssince"
                          target="_blank"
                          class="underline"
                          >ta.barssince()</a
                        >
                        возвращает число баров с момента выполнения указанного
                        условия;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_plotarrow"
                          target="_blank"
                          class="underline"
                          >plotarrow()</a
                        >
                        отображает на графике стрелки, направленные вверх или
                        вниз.
                      </li>
                    </ul>
                    <div class="note-box">
                      <div class="note-box-header">На заметку</div>
                      <p>
                        Идентификаторы ненужных переменных
                        <a
                          href="https://www.tradingview.com/pine-script-docs/language/type-system/#tuples"
                          target="_blank"
                          class="underline"
                          >кортежа</a
                        >
                        можно заменить плейсхолдером «_».
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>
          <section id="section-18">
            <h4>Задача #18. Счастливый билет</h4>
            <p>Написать индикатор.</p>
            <h5>Ввод</h5>
            <p>Строка из шести цифр S.</p>
            <h5>Основные вычисления</h5>
            <p>
              Две суммы цифр: сумма первых трёх цифр строки S и сумма последних
              трёх цифр строки S.
            </p>
            <p>
              Строка из двух слов в зависимости от сумм цифр:
              <em>"happy ticket"</em>, если суммы равны, иначе —
              <em>"regular ticket"</em>.
            </p>
            <h5>Вывод</h5>
            <p>Строка из двух слов объектом <em>label</em>.</p>
            <a href="images/tasks/task-18-L.png" class="image">
              <img
                src="images/tasks/task-18-L.png"
                class="img-fluid img-thumbnail"
              />
            </a>
            <div class="accordion" id="task-18">
              <div class="accordion-item">
                <div class="accordion-header">
                  <button
                    class="accordion-button collapsed"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#collapse-18"
                  >
                    Решение
                  </button>
                </div>
                <div
                  id="collapse-18"
                  class="accordion-collapse collapse"
                  data-bs-parent="#task-18"
                >
                  <div class="accordion-body">
                    <div class="code-box">
                      <pre><code><span class="psc-3">//@version=6</span>
<span class="psc-5">indicator</span>(<span class="psc-2">"Task #18"</span><span class="psc-4">,</span> overlay <span class="psc-4">=</span> <span class="psc-6">true</span>)

s <span class="psc-4">=</span> <span class="psc-5">input.string</span>(<span class="psc-2">"123321"</span><span class="psc-4">,</span> <span class="psc-2">"S"</span>)

<span class="psc-4">if</span> <span class="psc-6">barstate.islast</span>
    sum1 <span class="psc-4">=</span> <span class="psc-1">0.0</span>
    sum2 <span class="psc-4">=</span> <span class="psc-1">0.0</span>

    <span class="psc-4">for</span> i <span class="psc-4">=</span> <span class="psc-1">0</span> <span class="psc-4">to</span> <span class="psc-1">2</span>
        sum1 <span class="psc-4">+=</span> <span class="psc-5">str.tonumber</span>(<span class="psc-5">str.substring</span>(s<span class="psc-4">,</span> i<span class="psc-4">,</span> i <span class="psc-4">+</span> <span class="psc-1">1</span>))
        sum2 <span class="psc-4">+=</span> <span class="psc-5">str.tonumber</span>(<span class="psc-5">str.substring</span>(s<span class="psc-4">,</span> i <span class="psc-4">+</span> <span class="psc-1">3</span><span class="psc-4">,</span> i <span class="psc-4">+</span> <span class="psc-1">4</span>))

    ticketType <span class="psc-4">=</span> <span class="psc-4">switch</span>
        sum1 <span class="psc-4">==</span> sum2 <span class="psc-4">=></span> <span class="psc-2">"happy"</span>
        <span class="psc-4">=></span> <span class="psc-2">"regular"</span>

    <span class="psc-5">label.new</span>(
      x <span class="psc-4">=</span> <span class="psc-6">bar_index</span><span class="psc-4">,</span>
      y <span class="psc-4">=</span> <span class="psc-6">na</span><span class="psc-4">,</span>
      text <span class="psc-4">=</span> ticketType <span class="psc-4">+</span> <span class="psc-2">" ticket"</span><span class="psc-4">,</span>
      yloc <span class="psc-4">=</span> <span class="psc-6">yloc.abovebar</span><span class="psc-4">,</span>
      style <span class="psc-4">=</span> <span class="psc-6">label.style_label_center</span><span class="psc-4">,</span>
      textcolor <span class="psc-4">=</span> <span class="psc-6">color.white</span><span class="psc-4">,</span>
      size <span class="psc-4">=</span> <span class="psc-6">size.large</span>
      )</code></pre>
                    </div>
                    <p>Повторяем теорию:</p>
                    <ul>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_str.tonumber"
                          target="_blank"
                          class="underline"
                          >str.tonumber()</a
                        >
                        преобразует значение аргумента типа <em>string</em> в
                        значение типа <em>float</em>;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_str.substring"
                          target="_blank"
                          class="underline"
                          >str.substring()</a
                        >
                        возвращает подстроку указанной строки.
                      </li>
                    </ul>
                    <div class="note-box">
                      <div class="note-box-header">На заметку</div>
                      <p>Операция сложения строк называется конкатенацией.</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>
          <section id="section-19">
            <h4>Задача #19. GC-состав</h4>
            <p>Написать индикатор.</p>
            <h5>Ввод</h5>
            <p>Строка из нуклеотидов (символы A, G, C и T) S.</p>
            <h5>Основные вычисления</h5>
            <p>
              GC-состав (процентное содержание гуанина (G) и цитозина (C) в
              нуклеотидной последовательности) строки S. Результат не должен
              зависеть от регистра вводимых символов.
            </p>
            <h5>Вывод</h5>
            <p>GC-состав объектом <em>label</em>.</p>
            <a href="images/tasks/task-19-L.png" class="image">
              <img
                src="images/tasks/task-19-L.png"
                class="img-fluid img-thumbnail"
              />
            </a>
            <div class="accordion" id="task-19">
              <div class="accordion-item">
                <div class="accordion-header">
                  <button
                    class="accordion-button collapsed"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#collapse-19"
                  >
                    Решение
                  </button>
                </div>
                <div
                  id="collapse-19"
                  class="accordion-collapse collapse"
                  data-bs-parent="#task-19"
                >
                  <div class="accordion-body">
                    <div class="code-box">
                      <pre><code><span class="psc-3">//@version=6</span>
<span class="psc-5">indicator</span>(<span class="psc-2">"Task #19"</span><span class="psc-4">,</span> overlay <span class="psc-4">=</span> <span class="psc-6">true</span>)

s <span class="psc-4">=</span> <span class="psc-5">input.string</span>(<span class="psc-2">"AgGaTgCcGt"</span><span class="psc-4">,</span> <span class="psc-2">"S"</span>)

<span class="psc-4">if</span> <span class="psc-6">barstate.islast</span>
    s <span class="psc-4">:=</span> <span class="psc-5">str.lower</span>(s)
    g <span class="psc-4">=</span> <span class="psc-5">str.length</span>(s) <span class="psc-4">-</span> <span class="psc-5">str.length</span>(<span class="psc-5">str.replace_all</span>(s<span class="psc-4">,</span> <span class="psc-2">"g"</span><span class="psc-4">,</span> <span class="psc-2">""</span>))
    c <span class="psc-4">=</span> <span class="psc-5">str.length</span>(s) <span class="psc-4">-</span> <span class="psc-5">str.length</span>(<span class="psc-5">str.replace_all</span>(s<span class="psc-4">,</span> <span class="psc-2">"c"</span><span class="psc-4">,</span> <span class="psc-2">""</span>))
    gc <span class="psc-4">=</span> (g <span class="psc-4">+</span> c) <span class="psc-4">/</span> <span class="psc-5">str.length</span>(s) <span class="psc-4">*</span> <span class="psc-1">100</span>

    <span class="psc-5">label.new</span>(
      x <span class="psc-4">=</span> <span class="psc-6">bar_index</span><span class="psc-4">,</span>
      y <span class="psc-4">=</span> <span class="psc-6">na</span><span class="psc-4">,</span>
      text <span class="psc-4">=</span> <span class="psc-5">str.tostring</span>(gc)<span class="psc-4">,</span>
      yloc <span class="psc-4">=</span> <span class="psc-6">yloc.abovebar</span><span class="psc-4">,</span>
      style <span class="psc-4">=</span> <span class="psc-6">label.style_label_center</span><span class="psc-4">,</span>
      textcolor <span class="psc-4">=</span> <span class="psc-6">color.white</span><span class="psc-4">,</span>
      size <span class="psc-4">=</span> <span class="psc-6">size.large</span>
      )</code></pre>
                    </div>
                    <p>Повторяем теорию:</p>
                    <ul>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_str.lower"
                          target="_blank"
                          class="underline"
                          >str.lower()</a
                        >
                        возвращает копию строки с символами в нижнем регистре;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_str.length"
                          target="_blank"
                          class="underline"
                          >str.length()</a
                        >
                        возвращает число символов строки;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_str.replace_all"
                          target="_blank"
                          class="underline"
                          >str.replace_all()</a
                        >
                        возвращает строку, в которой каждая целевая подстрока в
                        исходной строке заменена указанной подстрокой.
                      </li>
                    </ul>
                    <div class="note-box">
                      <div class="note-box-header">На заметку</div>
                      <p>
                        <a
                          href="https://www.tradingview.com/pine-script-docs/language/type-system/#string"
                          target="_blank"
                          class="underline"
                          >Строки</a
                        >
                        в Pine Script поддерживают несколько управляющих
                        символов. Особенно полезен символ переноса строки
                        <em>"\n"</em>, позволяющий создавать многострочные
                        строки.
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>
          <section id="section-20">
            <h4>Задача #20. Числовой ряд</h4>
            <p>Написать индикатор.</p>
            <h5>Ввод</h5>
            <p>Целое число N. Минимальное значение: <em>1</em>.</p>
            <h5>Основные вычисления</h5>
            <p>
              Числовой ряд из N чисел, являющийся частью последовательности 1 2
              2 3 3 3 4 4 4 4 5 5 5 5 5 … (каждое число встречается в ряду
              столько раз, чему оно равно). Числа в ряду должны быть разделены
              пробелом.
            </p>
            <h5>Вывод</h5>
            <p>Числовой ряд объектом <em>label</em>.</p>
            <a href="images/tasks/task-20-L.png" class="image">
              <img
                src="images/tasks/task-20-L.png"
                class="img-fluid img-thumbnail"
              />
            </a>
            <div class="accordion" id="task-20">
              <div class="accordion-item">
                <div class="accordion-header">
                  <button
                    class="accordion-button collapsed"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#collapse-20"
                  >
                    Решение
                  </button>
                </div>
                <div
                  id="collapse-20"
                  class="accordion-collapse collapse"
                  data-bs-parent="#task-20"
                >
                  <div class="accordion-body">
                    <div class="code-box">
                      <pre><code><span class="psc-3">//@version=6</span>
<span class="psc-5">indicator</span>(<span class="psc-2">"Task #20"</span><span class="psc-4">,</span> overlay <span class="psc-4">=</span> <span class="psc-6">true</span>)

n <span class="psc-4">=</span> <span class="psc-5">input.int</span>(<span class="psc-1">7</span><span class="psc-4">,</span> <span class="psc-2">"N"</span><span class="psc-4">,</span> <span class="psc-1">1</span>)

<span class="psc-4">if</span> <span class="psc-6">barstate.islast</span>
    numberSequence <span class="psc-4">=</span> <span class="psc-5">array.new_int</span>()

    <span class="psc-4">for</span> i <span class="psc-4">=</span> <span class="psc-1">1</span> <span class="psc-4">to</span> n
        <span class="psc-4">for</span> j <span class="psc-4">=</span> <span class="psc-1">1</span> <span class="psc-4">to</span> i
            <span class="psc-4">if</span> <span class="psc-5">array.size</span>(numberSequence) <span class="psc-4"><</span> n
                <span class="psc-5">array.push</span>(numberSequence<span class="psc-4">,</span> i)
            <span class="psc-4">else</span>
                <span class="psc-4">break</span>

    <span class="psc-5">label.new</span>(
      x <span class="psc-4">=</span> <span class="psc-6">bar_index</span><span class="psc-4">,</span>
      y <span class="psc-4">=</span> <span class="psc-6">na</span><span class="psc-4">,</span>
      text <span class="psc-4">=</span> <span class="psc-5">array.join</span>(numberSequence<span class="psc-4">,</span> <span class="psc-2">" "</span>)<span class="psc-4">,</span>
      yloc <span class="psc-4">=</span> <span class="psc-6">yloc.abovebar</span><span class="psc-4">,</span>
      style <span class="psc-4">=</span> <span class="psc-6">label.style_label_center</span><span class="psc-4">,</span>
      textcolor <span class="psc-4">=</span> <span class="psc-6">color.white</span><span class="psc-4">,</span>
      size <span class="psc-4">=</span> <span class="psc-6">size.large</span>
      )</code></pre>
                    </div>
                    <p>Повторяем теорию:</p>
                    <ul>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_array.new_int"
                          target="_blank"
                          class="underline"
                          >array.new_int()</a
                        >
                        создаёт объект <em>array</em>, предназначенный для
                        хранения элементов типа <em>int</em>;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_array.push"
                          target="_blank"
                          class="underline"
                          >array.push()</a
                        >
                        добавляет элемент в конец объекта
                        <em>array</em>;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_array.join"
                          target="_blank"
                          class="underline"
                          >array.join()</a
                        >
                        возвращает строку, созданную путём объединения всех
                        элементов объекта
                        <em>array</em>.
                      </li>
                    </ul>
                    <div class="note-box">
                      <div class="note-box-header">На заметку</div>
                      <p>
                        Параметры функций принимают значения строго
                        определённых
                        <a
                          href="https://www.tradingview.com/pine-script-docs/language/type-system/#qualifiers"
                          target="_blank"
                          class="underline"
                          >квалификаторов</a
                        >
                        и
                        <a
                          href="https://www.tradingview.com/pine-script-docs/language/type-system/#types"
                          target="_blank"
                          class="underline"
                          >типов</a
                        >.
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>
          <section id="section-21">
            <h4>Задача #21. Повторения</h4>
            <p>Написать индикатор.</p>
            <h5>Ввод</h5>
            <p>Строка из чисел S.</p>
            <h5>Основные вычисления</h5>
            <p>
              Массив чисел, которые встречаются в строке S более одного раза.
              Числа в массиве не должны повторяться. Массив может содержать
              строковые представления чисел.
            </p>
            <h5>Вывод</h5>
            <p>Строка из чисел массива объектом <em>label</em>.</p>
            <a href="images/tasks/task-21-L.png" class="image">
              <img
                src="images/tasks/task-21-L.png"
                class="img-fluid img-thumbnail"
              />
            </a>
            <div class="accordion" id="task-21">
              <div class="accordion-item">
                <div class="accordion-header">
                  <button
                    class="accordion-button collapsed"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#collapse-21"
                  >
                    Решение
                  </button>
                </div>
                <div
                  id="collapse-21"
                  class="accordion-collapse collapse"
                  data-bs-parent="#task-21"
                >
                  <div class="accordion-body">
                    <div class="code-box">
                      <pre><code><span class="psc-3">//@version=6</span>
<span class="psc-5">indicator</span>(<span class="psc-2">"Task #21"</span><span class="psc-4">,</span> overlay <span class="psc-4">=</span> <span class="psc-6">true</span>)

s <span class="psc-4">=</span> <span class="psc-5">input.string</span>(<span class="psc-2">"1 2 3 1 3 4 1"</span><span class="psc-4">,</span> <span class="psc-2">"S"</span>)

<span class="psc-4">if</span> <span class="psc-6">barstate.islast</span>
    repetitions <span class="psc-4">=</span> <span class="psc-5">array.new_string</span>()
    numbers <span class="psc-4">=</span> <span class="psc-5">str.split</span>(s<span class="psc-4">,</span> <span class="psc-2">" "</span>)

    <span class="psc-4">while</span> <span class="psc-5">array.size</span>(numbers) <span class="psc-4">></span> <span class="psc-1">0</span>
        element <span class="psc-4">=</span> <span class="psc-5">array.shift</span>(numbers)

        <span class="psc-4">if</span> <span class="psc-5">array.includes</span>(numbers<span class="psc-4">,</span> element)
            <span class="psc-4">if</span> <span class="psc-4">not</span> <span class="psc-5">array.includes</span>(repetitions<span class="psc-4">,</span> element)
                <span class="psc-5">array.push</span>(repetitions<span class="psc-4">,</span> element)

    <span class="psc-5">label.new</span>(
      x <span class="psc-4">=</span> <span class="psc-6">bar_index</span><span class="psc-4">,</span>
      y <span class="psc-4">=</span> <span class="psc-6">na</span><span class="psc-4">,</span>
      text <span class="psc-4">=</span> <span class="psc-5">array.join</span>(repetitions<span class="psc-4">,</span> <span class="psc-2">" "</span>)<span class="psc-4">,</span>
      yloc <span class="psc-4">=</span> <span class="psc-6">yloc.abovebar</span><span class="psc-4">,</span>
      style <span class="psc-4">=</span> <span class="psc-6">label.style_label_center</span><span class="psc-4">,</span>
      textcolor <span class="psc-4">=</span> <span class="psc-6">color.white</span><span class="psc-4">,</span>
      size <span class="psc-4">=</span> <span class="psc-6">size.large</span>
      )</code></pre>
                    </div>
                    <p>Повторяем теорию:</p>
                    <ul>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_array.new_string"
                          target="_blank"
                          class="underline"
                          >array.new_string()</a
                        >
                        создаёт объект <em>array</em>, предназначенный для
                        хранения элементов типа <em>string</em>;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_str.split"
                          target="_blank"
                          class="underline"
                          >str.split()</a
                        >
                        создаёт объект <em>array</em>, созданный путём
                        разделения исходной строки на подстроки;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_array.shift"
                          target="_blank"
                          class="underline"
                          >array.shift()</a
                        >
                        удаляет из объекта <em>array</em> первый элемент и
                        возвращает его значение;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_array.includes"
                          target="_blank"
                          class="underline"
                          >array.includes()</a
                        >
                        возвращает значение <em>true</em>, если объект
                        <em>array</em> содержит значение аргумента, иначе
                        возвращает значение <em>false</em>.
                      </li>
                    </ul>
                    <div class="note-box">
                      <div class="note-box-header">На заметку</div>
                      <p>
                        Объект
                        <a
                          href="https://www.tradingview.com/pine-script-docs/language/arrays/#arrays"
                          target="_blank"
                          class="underline"
                          >array</a
                        >
                        может содержать до 100,000 элементов.
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>
          <section id="section-22">
            <h4>Задача #22. Бычьи бары</h4>
            <p>Написать индикатор.</p>
            <h5>Ввод</h5>
            <p>Целое число N. Минимальное значение: <em>1</em>.</p>
            <h5>Основные вычисления</h5>
            <p>
              Логический сигнал, принимающий значение <em>true</em>, если N
              баров подряд закрылось выше своего открытия, иначе принимающий
              значение <em>false</em>.
            </p>
            <h5>Вывод</h5>
            <p>
              Четырёхугольники под барами, на которых логический сигнал равен
              <em>true</em>.
            </p>
            <a href="images/tasks/task-22-L.png" class="image">
              <img
                src="images/tasks/task-22-L.png"
                class="img-fluid img-thumbnail"
              />
            </a>
            <div class="accordion" id="task-22">
              <div class="accordion-item">
                <div class="accordion-header">
                  <button
                    class="accordion-button collapsed"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#collapse-22"
                  >
                    Решение
                  </button>
                </div>
                <div
                  id="collapse-22"
                  class="accordion-collapse collapse"
                  data-bs-parent="#task-22"
                >
                  <div class="accordion-body">
                    <div class="code-box">
                      <pre><code><span class="psc-3">//@version=6</span>
<span class="psc-5">indicator</span>(<span class="psc-2">"Task #22"</span><span class="psc-4">,</span> overlay <span class="psc-4">=</span> <span class="psc-6">true</span>)

n <span class="psc-4">=</span> <span class="psc-5">input.int</span>(<span class="psc-1">3</span><span class="psc-4">,</span> <span class="psc-2">"N"</span><span class="psc-4">,</span> <span class="psc-1">1</span>)

<span class="psc-4">var</span> greenBars <span class="psc-4">=</span> <span class="psc-5">array.new_bool</span>(n<span class="psc-4">,</span> <span class="psc-6">false</span>)
signal <span class="psc-4">=</span> <span class="psc-5">bool</span>(<span class="psc-6">na</span>)

<span class="psc-5">array.push</span>(greenBars<span class="psc-4">,</span> <span class="psc-6">close</span> <span class="psc-4">></span> <span class="psc-6">open</span>)
<span class="psc-5">array.remove</span>(greenBars<span class="psc-4">,</span> <span class="psc-1">0</span>)
signal <span class="psc-4">:=</span> <span class="psc-5">array.every</span>(greenBars)

<span class="psc-5">plotshape</span>(signal<span class="psc-4">,</span> style <span class="psc-4">=</span> <span class="psc-6">shape.diamond</span><span class="psc-4">,</span> location <span class="psc-4">=</span> <span class="psc-6">location.belowbar</span>)</code></pre>
                    </div>
                    <p>Повторяем теорию:</p>
                    <ul>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_array.new_bool"
                          target="_blank"
                          class="underline"
                          >array.new_bool()</a
                        >
                        создаёт объект <em>array</em>, предназначенный для
                        хранения элементов типа <em>bool</em>;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_bool"
                          target="_blank"
                          class="underline"
                          >bool()</a
                        >
                        преобразует значение аргумента в значение типа
                        <em>bool</em>;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_array.remove"
                          target="_blank"
                          class="underline"
                          >array.remove()</a
                        >
                        удаляет из объекта <em>array</em> элемент по указанному
                        индексу;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_array.every"
                          target="_blank"
                          class="underline"
                          >array.every()</a
                        >
                        возвращает значение <em>true</em>, если все элементы
                        объекта <em>array</em> имеют значение <em>true</em>,
                        иначе возвращает значение <em>false</em>;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_plotshape"
                          target="_blank"
                          class="underline"
                          >plotshape()</a
                        >
                        отображает визуальные фигуры на графике.
                      </li>
                    </ul>
                    <div class="note-box">
                      <div class="note-box-header">На заметку</div>
                      <p>
                        Функция
                        <a
                          href="https://www.tradingview.com/pine-script-docs/concepts/text-and-shapes/#plotshape"
                          target="_blank"
                          class="underline"
                          >plotshape()</a
                        >
                        позволяет частично заменить функцию
                        <a
                          href="https://www.tradingview.com/pine-script-docs/concepts/text-and-shapes/#labels"
                          target="_blank"
                          class="underline"
                          >label.new()</a
                        >, а количество отображаемых данной функцией визуальных
                        фигур неограниченно.
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>
          <section id="section-23">
            <h4>Задача #23. Прямоугольники</h4>
            <p>Написать индикатор.</p>
            <h5>Ввод</h5>
            <p>Целое число N. Минимальное значение: <em>0</em>.</p>
            <h5>Основные вычисления</h5>
            <p>
              Модель из трёх баров. Правила формирования модели: закрытие
              первого бара меньше его открытия, закрытие второго бара больше
              максимума первого бара, минимум третьего бара больше максимума
              первого бара.
            </p>
            <h5>Вывод</h5>
            <p>
              Объекты <em>box</em>, выделяющие на графике не более N моделей
              баров. Верхняя граница объекта
              <em>box</em>
              должна быть равна наибольшей цене модели, а нижняя граница
              объекта
              <em>box</em> — наименьшей цене модели.
            </p>
            <a href="images/tasks/task-23-L.png" class="image">
              <img
                src="images/tasks/task-23-L.png"
                class="img-fluid img-thumbnail"
              />
            </a>
            <div class="accordion" id="task-23">
              <div class="accordion-item">
                <div class="accordion-header">
                  <button
                    class="accordion-button collapsed"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#collapse-23"
                  >
                    Решение
                  </button>
                </div>
                <div
                  id="collapse-23"
                  class="accordion-collapse collapse"
                  data-bs-parent="#task-23"
                >
                  <div class="accordion-body">
                    <div class="code-box">
                      <pre><code><span class="psc-3">//@version=6</span>
<span class="psc-5">indicator</span>(<span class="psc-2">"Task #23"</span><span class="psc-4">,</span> overlay <span class="psc-4">=</span> <span class="psc-6">true</span>)

n <span class="psc-4">=</span> <span class="psc-5">input.int</span>(<span class="psc-1">2</span><span class="psc-4">,</span> <span class="psc-2">"N"</span><span class="psc-4">,</span> <span class="psc-1">0</span>)

<span class="psc-4">var</span> patterns <span class="psc-4">=</span> <span class="psc-5">array.new_box</span>()

<span class="psc-4">if</span>  <span class="psc-6">close</span>[<span class="psc-1">2</span>] <span class="psc-4"><</span> <span class="psc-6">open</span>[<span class="psc-1">2</span>] <span class="psc-4">and</span> <span class="psc-6">close</span>[<span class="psc-1">1</span>] <span class="psc-4">></span> <span class="psc-6">high</span>[<span class="psc-1">2</span>] <span class="psc-4">and</span> <span class="psc-6">low</span> <span class="psc-4">></span> <span class="psc-6">high</span>[<span class="psc-1">2</span>]
    pattern <span class="psc-4">=</span> <span class="psc-5">box.new</span>(
      left <span class="psc-4">=</span> <span class="psc-6">bar_index</span>[<span class="psc-1">2</span>]<span class="psc-4">,</span>
      top <span class="psc-4">=</span> <span class="psc-5">math.max</span>(<span class="psc-6">high</span><span class="psc-4">,</span> <span class="psc-6">high</span>[<span class="psc-1">1</span>])<span class="psc-4">,</span>
      right <span class="psc-4">=</span> <span class="psc-6">bar_index</span><span class="psc-4">,</span>
      bottom <span class="psc-4">=</span> <span class="psc-5">math.min</span>(<span class="psc-6">low</span>[<span class="psc-1">1</span>]<span class="psc-4">,</span> <span class="psc-6">low</span>[<span class="psc-1">2</span>])<span class="psc-4">,</span>
      border_width <span class="psc-4">=</span> <span class="psc-1">2</span><span class="psc-4">,</span>
      bgcolor <span class="psc-4">=</span> <span class="psc-6">na</span>
      )
    <span class="psc-5">array.push</span>(patterns<span class="psc-4">,</span> pattern)

    <span class="psc-4">if</span> <span class="psc-5">array.size</span>(patterns) <span class="psc-4">></span> n
        <span class="psc-5">box.delete</span>(<span class="psc-5">array.shift</span>(patterns))</code></pre>
                    </div>
                    <p>Повторяем теорию:</p>
                    <ul>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_array.new_box"
                          target="_blank"
                          class="underline"
                          >array.new_box()</a
                        >
                        создаёт объект <em>array</em>, предназначенный для
                        хранения элементов типа <em>box</em>;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_box.new"
                          target="_blank"
                          class="underline"
                          >box.new()</a
                        >
                        создаёт объект <em>box</em> и отображает его на
                        графике;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_math.min"
                          target="_blank"
                          class="underline"
                          >math.min()</a
                        >
                        возвращает наименьшее из нескольких значений
                        аргументов;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_box.delete"
                          target="_blank"
                          class="underline"
                          >box.delete()</a
                        >
                        удаляет объект <em>box</em>.
                      </li>
                    </ul>
                    <div class="note-box">
                      <div class="note-box-header">На заметку</div>
                      <p>
                        Параметры <em>max_lines_count</em>,
                        <em>max_labels_count</em>, <em>max_boxes_count</em> и
                        <em>max_polylines_count</em> функций
                        <em>indicator()</em> и <em>strategy()</em> позволяют
                        настраивать
                        <a
                          href="https://www.tradingview.com/pine-script-docs/writing/limitations/#line-box-polyline-and-label-limits"
                          target="_blank"
                          class="underline"
                          >число отображаемых объектов line, label, box и
                          polyline</a
                        >.
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>
          <section id="section-24">
            <h4>Задача #24. Зигзаг</h4>
            <p>Написать индикатор.</p>
            <h5>Ввод</h5>
            <p>Целое число N. Минимальное значение: <em>1</em>.</p>
            <h5>Основные вычисления</h5>
            <p>
              Верхние точки разворота максимумов баров. Максимум бара считается
              верхней точкой разворота, если слева и справа от бара закрыто N
              баров с более низкими максимумами.
            </p>
            <p>
              Нижние точки разворота минимумов баров. Минимум бара считается
              нижней точкой разворота, если слева и справа от бара закрыто N
              баров с более высокими минимумами.
            </p>
            <p>
              Массив точек разворота. Точки разворота должны чередоваться. При
              образовании двух верхних или нижних точек разворота подряд в
              массиве должна сохраниться только последняя точка разворота.
            </p>
            <h5>Вывод</h5>
            <p>
              Объект <em>polyline</em>, соединяющий точки разворота массива.
            </p>
            <a href="images/tasks/task-24-L.png" class="image">
              <img
                src="images/tasks/task-24-L.png"
                class="img-fluid img-thumbnail"
              />
            </a>
            <div class="accordion" id="task-24">
              <div class="accordion-item">
                <div class="accordion-header">
                  <button
                    class="accordion-button collapsed"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#collapse-24"
                  >
                    Решение
                  </button>
                </div>
                <div
                  id="collapse-24"
                  class="accordion-collapse collapse"
                  data-bs-parent="#task-24"
                >
                  <div class="accordion-body">
                    <div class="code-box">
                      <pre><code><span class="psc-3">//@version=6</span>
<span class="psc-5">indicator</span>(<span class="psc-2">"Task #24"</span><span class="psc-4">,</span> overlay <span class="psc-4">=</span> <span class="psc-6">true</span>)

n <span class="psc-4">=</span> <span class="psc-5">input.int</span>(<span class="psc-1">2</span><span class="psc-4">,</span> <span class="psc-2">"N"</span><span class="psc-4">,</span> <span class="psc-1">1</span>)

<span class="psc-4">var</span> pivots <span class="psc-4">=</span> <span class="psc-5">array.new</span><<span class="psc-4">chart.point</span>>()
<span class="psc-4">var</span> lastPivot <span class="psc-4">=</span> <span class="psc-5">string</span>(<span class="psc-6">na</span>)

pivotHigh <span class="psc-4">=</span> <span class="psc-5">ta.pivothigh</span>(n<span class="psc-4">,</span> n)
pivotLow <span class="psc-4">=</span> <span class="psc-5">ta.pivotlow</span>(n<span class="psc-4">,</span> n)

<span class="psc-4">if</span> <span class="psc-4">not</span> <span class="psc-5">na</span>(pivotHigh)
    <span class="psc-4">if</span> lastPivot <span class="psc-4">==</span> <span class="psc-2">"high"</span>
        <span class="psc-5">array.pop</span>(pivots)

    cp <span class="psc-4">=</span> <span class="psc-5">chart.point.from_time</span>(<span class="psc-6">time</span>[n]<span class="psc-4">,</span> pivotHigh)
    <span class="psc-5">array.push</span>(pivots<span class="psc-4">,</span> cp)
    lastPivot <span class="psc-4">:=</span> <span class="psc-2">"high"</span>
<span class="psc-4">else</span> <span class="psc-4">if</span> <span class="psc-4">not</span> <span class="psc-5">na</span>(pivotLow)
    <span class="psc-4">if</span> lastPivot <span class="psc-4">==</span> <span class="psc-2">"low"</span>
        <span class="psc-5">array.pop</span>(pivots)

    cp <span class="psc-4">=</span> <span class="psc-5">chart.point.from_time</span>(<span class="psc-6">time</span>[n]<span class="psc-4">,</span> pivotLow)
    <span class="psc-5">array.push</span>(pivots<span class="psc-4">,</span> cp)
    lastPivot <span class="psc-4">:=</span> <span class="psc-2">"low"</span>

<span class="psc-4">if</span> <span class="psc-6">barstate.islast</span>
    <span class="psc-5">polyline.new</span>(pivots<span class="psc-4">,</span> xloc <span class="psc-4">=</span> <span class="psc-6">xloc.bar_time</span><span class="psc-4">,</span> line_width <span class="psc-4">=</span> <span class="psc-1">2</span>)</code></pre>
                    </div>
                    <p>Повторяем теорию:</p>
                    <ul>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_array.new%3Ctype%3E"
                          target="_blank"
                          class="underline"
                          >array.new&lt;type&gt;()</a
                        >
                        создаёт объект <em>array</em>, предназначенный для
                        хранения элементов типа <em>type</em>;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_ta.pivothigh"
                          target="_blank"
                          class="underline"
                          >ta.pivothigh()</a
                        >
                        возвращает цену верхней точки разворота, либо
                        <em>na</em>, если точка отсутствует;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_ta.pivotlow"
                          target="_blank"
                          class="underline"
                          >ta.pivotlow()</a
                        >
                        возвращает цену нижней точки разворота, либо
                        <em>na</em>, если точка отсутствует;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_array.pop"
                          target="_blank"
                          class="underline"
                          >array.pop()</a
                        >
                        удаляет из объекта <em>array</em> последний элемент и
                        возвращает его значение;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_chart.point.from_time"
                          target="_blank"
                          class="underline"
                          >chart.point.from_time()</a
                        >
                        создаёт объект <em>chart.point</em> с Unix-временем в
                        качестве координаты X и ценой в качестве координаты Y;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_polyline.new"
                          target="_blank"
                          class="underline"
                          >polyline.new()</a
                        >
                        создаёт объект <em>polyline</em> и отображает его на
                        графике.
                      </li>
                    </ul>
                    <div class="note-box">
                      <div class="note-box-header">На заметку</div>
                      <p>
                        Объект
                        <a
                          href="https://www.tradingview.com/pine-script-docs/concepts/lines-and-boxes/#polylines"
                          target="_blank"
                          class="underline"
                          >polyline</a
                        >
                        может соединить на графике до 10,000 точек.
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>
          <section id="section-25">
            <h4>Задача #25. Спираль</h4>
            <p>Написать индикатор.</p>
            <h5>Ввод</h5>
            <p>Целое число N. Минимальное значение: <em>1</em>.</p>
            <h5>Основные вычисления</h5>
            <p>
              Матрица размером N x N, заполненная числами от 1 до N<sup>2</sup>
              по спирали. Спираль из чисел должна выходить из левого верхнего
              угла матрицы и закручиваться по часовой стрелке.
            </p>
            <h5>Вывод</h5>
            <p>Матрица объектом <em>label</em>.</p>
            <a href="images/tasks/task-25-L.png" class="image">
              <img
                src="images/tasks/task-25-L.png"
                class="img-fluid img-thumbnail"
              />
            </a>
            <div class="accordion" id="task-25">
              <div class="accordion-item">
                <div class="accordion-header">
                  <button
                    class="accordion-button collapsed"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#collapse-25"
                  >
                    Решение
                  </button>
                </div>
                <div
                  id="collapse-25"
                  class="accordion-collapse collapse"
                  data-bs-parent="#task-25"
                >
                  <div class="accordion-body">
                    <div class="code-box">
                      <pre><code><span class="psc-3">//@version=6</span>
<span class="psc-5">indicator</span>(<span class="psc-2">"Task #25"</span>)

n <span class="psc-4">=</span> <span class="psc-5">input.int</span>(<span class="psc-1">5</span><span class="psc-4">,</span> <span class="psc-2">"N"</span><span class="psc-4">,</span> <span class="psc-1">1</span>)

<span class="psc-4">if</span> <span class="psc-6">barstate.islast</span>
    m <span class="psc-4">=</span> <span class="psc-5">matrix.new</span><<span class="psc-4">int</span>>(n<span class="psc-4">,</span> n)
    i <span class="psc-4">=</span> <span class="psc-1">0</span>
    j <span class="psc-4">=</span> <span class="psc-1">0</span>

    <span class="psc-4">for</span> k <span class="psc-4">=</span> <span class="psc-1">1</span> <span class="psc-4">to</span> n <span class="psc-4">*</span> n
        <span class="psc-5">matrix.set</span>(m<span class="psc-4">,</span> i<span class="psc-4">,</span> j<span class="psc-4">,</span> k)

        <span class="psc-4">if</span> k <span class="psc-4">==</span> n <span class="psc-4">*</span> n
            <span class="psc-4">break</span>

        <span class="psc-4">if</span> i <span class="psc-4"><=</span> j <span class="psc-4">+</span> <span class="psc-1">1</span> <span class="psc-4">and</span> i <span class="psc-4">+</span> j <span class="psc-4"><</span> n <span class="psc-4">-</span> <span class="psc-1">1</span>
            j <span class="psc-4">+=</span> <span class="psc-1">1</span>
        <span class="psc-4">else</span> <span class="psc-4">if</span> i <span class="psc-4"><</span> j <span class="psc-4">and</span> i <span class="psc-4">+</span> j <span class="psc-4">>=</span> n <span class="psc-4">-</span> <span class="psc-1">1</span>
            i <span class="psc-4">+=</span> <span class="psc-1">1</span>
        <span class="psc-4">else</span> <span class="psc-4">if</span> i <span class="psc-4">>=</span> j <span class="psc-4">and</span> i <span class="psc-4">+</span> j <span class="psc-4">></span> n <span class="psc-4">-</span> <span class="psc-1">1</span>
            j <span class="psc-4">-=</span> <span class="psc-1">1</span>
        <span class="psc-4">else</span> <span class="psc-4">if</span> i <span class="psc-4">></span> j <span class="psc-4">+</span> <span class="psc-1">1</span> <span class="psc-4">and</span> i <span class="psc-4">+</span> j <span class="psc-4"><=</span> n <span class="psc-4">-</span> <span class="psc-1">1</span>
            i <span class="psc-4">-=</span> <span class="psc-1">1</span>

    <span class="psc-5">label.new</span>(
      x <span class="psc-4">=</span> <span class="psc-6">bar_index</span><span class="psc-4">,</span>
      y <span class="psc-4">=</span> <span class="psc-1">0</span><span class="psc-4">,</span>
      text <span class="psc-4">=</span> <span class="psc-5">str.tostring</span>(m)<span class="psc-4">,</span>
      style <span class="psc-4">=</span> <span class="psc-6">label.style_label_center</span><span class="psc-4">,</span>
      textcolor <span class="psc-4">=</span> <span class="psc-6">color.white</span><span class="psc-4">,</span>
      size <span class="psc-4">=</span> <span class="psc-6">size.large</span><span class="psc-4">,</span>
      textalign <span class="psc-4">=</span> <span class="psc-6">text.align_left</span>
      )</code></pre>
                    </div>
                    <p>Повторяем теорию:</p>
                    <ul>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_matrix.new%3Ctype%3E"
                          target="_blank"
                          class="underline"
                          >matrix.new&lt;type&gt;()</a
                        >
                        создаёт объект <em>matrix</em>, предназначенный для
                        хранения элементов типа <em>type</em>;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_matrix.set"
                          target="_blank"
                          class="underline"
                          >matrix.set()</a
                        >
                        присваивает значение элементу объекта
                        <em>matrix</em> по указанным индексам.
                      </li>
                    </ul>
                    <div class="note-box">
                      <div class="note-box-header">На заметку</div>
                      <p>
                        Объект
                        <a
                          href="https://www.tradingview.com/pine-script-docs/language/matrices/#matrices"
                          target="_blank"
                          class="underline"
                          >matrix</a
                        >
                        может содержать до 100,000 элементов.
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>
          <section id="section-26">
            <h4>Задача #26. Линейная регрессия</h4>
            <p>Написать индикатор.</p>
            <h5>Ввод</h5>
            <p>Источник для расчётов S.</p>
            <p>Целое число N. Минимальное значение: <em>2</em>.</p>
            <h5>Основные вычисления</h5>
            <p>
              Модель однофакторной линейной регрессии на основе N последних
              значений данных S. В скрипте должен быть определён тип
              <em>LinearRegression</em>, представляющий модель линейной
              регрессии, метод <em>fit</em>, вычисляющий параметры модели
              регрессии, и метод <em>predict</em>, вычисляющий прогноз по
              модели регрессии. Параметры модели регрессии должны вычисляться
              матричным методом.
            </p>
            <h5>Вывод</h5>
            <p>
              Объект <em>line</em> на последнем баре, соединяющий прогнозные
              значения по модели регрессии.
            </p>
            <a href="images/tasks/task-26-L.png" class="image">
              <img
                src="images/tasks/task-26-L.png"
                class="img-fluid img-thumbnail"
              />
            </a>
            <div class="accordion" id="task-26">
              <div class="accordion-item">
                <div class="accordion-header">
                  <button
                    class="accordion-button collapsed"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#collapse-26"
                  >
                    Решение
                  </button>
                </div>
                <div
                  id="collapse-26"
                  class="accordion-collapse collapse"
                  data-bs-parent="#task-26"
                >
                  <div class="accordion-body">
                    <div class="code-box">
                      <pre><code><span class="psc-3">//@version=6</span>
<span class="psc-5">indicator</span>(<span class="psc-2">"Task #26"</span><span class="psc-4">,</span> overlay <span class="psc-4">=</span> <span class="psc-6">true</span>)

s <span class="psc-4">=</span> <span class="psc-5">input.source</span>(<span class="psc-6">close</span><span class="psc-4">,</span> <span class="psc-2">"S"</span>)
n <span class="psc-4">=</span> <span class="psc-5">input.int</span>(<span class="psc-1">20</span><span class="psc-4">,</span> <span class="psc-2">"N"</span><span class="psc-4">,</span> <span class="psc-1">2</span>)

<span class="psc-4">type</span> <span class="psc-4">LinearRegression</span>
    <span class="psc-4">matrix</span><<span class="psc-4">float</span>> b <span class="psc-4">=</span> <span class="psc-6">na</span>

<span class="psc-4">method</span> <span class="psc-7">fit</span>(<span class="psc-4">LinearRegression</span> this<span class="psc-4">,</span> X<span class="psc-4">,</span> y) <span class="psc-4">=></span>
    this.b <span class="psc-4">:=</span> <span class="psc-5">matrix.mult</span>(
      id1 <span class="psc-4">=</span> <span class="psc-5">matrix.mult</span>(
         id1 <span class="psc-4">=</span> <span class="psc-5">matrix.inv</span>(
           id <span class="psc-4">=</span> <span class="psc-5">matrix.mult</span>(
              id1 <span class="psc-4">=</span> <span class="psc-5">matrix.transpose</span>(X)<span class="psc-4">,</span> 
              id2 <span class="psc-4">=</span> X
              )
           )<span class="psc-4">,</span> 
         id2 <span class="psc-4">=</span> <span class="psc-5">matrix.transpose</span>(X)
         )<span class="psc-4">,</span> 
      id2 <span class="psc-4">=</span> y
      )

<span class="psc-4">method</span> <span class="psc-7">predict</span>(<span class="psc-4">LinearRegression</span> this<span class="psc-4">,</span> x) <span class="psc-4">=></span>
    <span class="psc-5">matrix.get</span>(this.b<span class="psc-4">,</span> <span class="psc-1">0</span><span class="psc-4">,</span> <span class="psc-1">0</span>) <span class="psc-4">+</span> <span class="psc-5">matrix.get</span>(this.b<span class="psc-4">,</span> <span class="psc-1">1</span><span class="psc-4">,</span> <span class="psc-1">0</span>) <span class="psc-4">*</span> x

<span class="psc-4">if</span> <span class="psc-6">barstate.islast</span>
    X <span class="psc-4">=</span> <span class="psc-5">matrix.new</span><<span class="psc-4">float</span>>(n<span class="psc-4">,</span> <span class="psc-1">2</span>)
    y <span class="psc-4">=</span> <span class="psc-5">matrix.new</span><<span class="psc-4">float</span>>(n<span class="psc-4">,</span> <span class="psc-1">1</span>)

    <span class="psc-4">for</span> i <span class="psc-4">=</span> <span class="psc-1">0</span> <span class="psc-4">to</span> n <span class="psc-4">-</span> <span class="psc-1">1</span>
        <span class="psc-5">matrix.set</span>(X<span class="psc-4">,</span> i<span class="psc-4">,</span> <span class="psc-1">0</span><span class="psc-4">,</span> <span class="psc-1">1</span>)
        <span class="psc-5">matrix.set</span>(X<span class="psc-4">,</span> i<span class="psc-4">,</span> <span class="psc-1">1</span><span class="psc-4">,</span> i)
        <span class="psc-5">matrix.set</span>(y<span class="psc-4">,</span> i<span class="psc-4">,</span> <span class="psc-1">0</span><span class="psc-4">,</span> s[n <span class="psc-4">-</span> i <span class="psc-4">-</span> <span class="psc-1">1</span>])

    model <span class="psc-4">=</span> <span class="psc-7">LinearRegression.new</span>()
    model.<span class="psc-7">fit</span>(X<span class="psc-4">,</span> y)

    cp1 <span class="psc-4">=</span> <span class="psc-5">chart.point.from_index</span>(
      index <span class="psc-4">=</span> <span class="psc-6">bar_index</span>[n <span class="psc-4">-</span> <span class="psc-1">1</span>]<span class="psc-4">,</span> 
      price <span class="psc-4">=</span> model.<span class="psc-7">predict</span>(<span class="psc-5">matrix.get</span>(X<span class="psc-4">,</span> <span class="psc-1">0</span><span class="psc-4">,</span> <span class="psc-1">1</span>))
      )
    cp2 <span class="psc-4">=</span> <span class="psc-5">chart.point.from_index</span>(
      index <span class="psc-4">=</span> <span class="psc-6">bar_index</span><span class="psc-4">,</span> 
      price <span class="psc-4">=</span> model.<span class="psc-7">predict</span>(<span class="psc-5">matrix.get</span>(X<span class="psc-4">,</span> n <span class="psc-4">-</span> <span class="psc-1">1</span><span class="psc-4">,</span> <span class="psc-1">1</span>))
      )
    <span class="psc-5">line.new</span>(cp1<span class="psc-4">,</span> cp2<span class="psc-4">,</span> extend <span class="psc-4">=</span> <span class="psc-6">extend.right</span><span class="psc-4">,</span> width <span class="psc-4">=</span> <span class="psc-1">2</span>)</code></pre>
                    </div>
                    <p>Повторяем теорию:</p>
                    <ul>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_matrix.mult"
                          target="_blank"
                          class="underline"
                          >matrix.mult()</a
                        >
                        возвращает объект <em>matrix</em>, являющийся
                        произведением двух матриц, матрицы и вектора (массива
                        значений) или матрицы и скаляра (числового значения);
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_matrix.inv"
                          target="_blank"
                          class="underline"
                          >matrix.inv()</a
                        >
                        возвращает объект <em>matrix</em>, являющийся обратной
                        матрицей;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_matrix.transpose"
                          target="_blank"
                          class="underline"
                          >matrix.transpose()</a
                        >
                        возвращает объект <em>matrix</em>, являющийся
                        транспонированной матрицей;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_matrix.get"
                          target="_blank"
                          class="underline"
                          >matrix.get()</a
                        >
                        возвращает значение элемента объекта <em>matrix</em> по
                        указанным индексам;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_chart.point.from_index"
                          target="_blank"
                          class="underline"
                          >chart.point.from_index()</a
                        >
                        создаёт объект <em>chart.point</em> с индексом бара в
                        качестве координаты X и ценой в качестве координаты Y;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_line.new"
                          target="_blank"
                          class="underline"
                          >line.new()</a
                        >
                        создаёт объект <em>line</em> и отображает его на
                        графике.
                      </li>
                    </ul>
                    <div class="note-box">
                      <div class="note-box-header">На заметку</div>
                      <p>
                        В отличие от функций,
                        <a
                          href="https://www.tradingview.com/pine-script-docs/language/methods/#methods"
                          target="_blank"
                          class="underline"
                          >методы</a
                        >
                        имеют более короткий и удобный синтаксис.
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>
          <section id="section-27">
            <h4>Задача #27. Матрица корреляций</h4>
            <p>Написать индикатор.</p>
            <h5>Ввод</h5>
            <p>Тикер с префиксом биржи S1.</p>
            <p>Тикер с префиксом биржи S2.</p>
            <p>Тикер с префиксом биржи S3.</p>
            <p>Целое число N. Минимальное значение: <em>3</em>.</p>
            <h5>Основные вычисления</h5>
            <p>
              Матрица корреляций между N последними ценами закрытия баров
              символов S1, S2 и S3.
            </p>
            <h5>Вывод</h5>
            <p>Матрица корреляций объектом <em>label</em>.</p>
            <a href="images/tasks/task-27-L.png" class="image">
              <img
                src="images/tasks/task-27-L.png"
                class="img-fluid img-thumbnail"
              />
            </a>
            <div class="accordion" id="task-27">
              <div class="accordion-item">
                <div class="accordion-header">
                  <button
                    class="accordion-button collapsed"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#collapse-27"
                  >
                    Решение
                  </button>
                </div>
                <div
                  id="collapse-27"
                  class="accordion-collapse collapse"
                  data-bs-parent="#task-27"
                >
                  <div class="accordion-body">
                    <div class="code-box">
                      <pre><code><span class="psc-3">//@version=6</span>
<span class="psc-5">indicator</span>(<span class="psc-2">"Task #27"</span>)

s1 <span class="psc-4">=</span> <span class="psc-5">input.symbol</span>(<span class="psc-2">"BTCUSDT"</span><span class="psc-4">,</span> <span class="psc-2">"S1"</span>)
s2 <span class="psc-4">=</span> <span class="psc-5">input.symbol</span>(<span class="psc-2">"ETHUSDT"</span><span class="psc-4">,</span> <span class="psc-2">"S2"</span>)
s3 <span class="psc-4">=</span> <span class="psc-5">input.symbol</span>(<span class="psc-2">"SOLUSDT"</span><span class="psc-4">,</span> <span class="psc-2">"S3"</span>)
n <span class="psc-4">=</span> <span class="psc-5">input.int</span>(<span class="psc-1">10</span><span class="psc-4">,</span> <span class="psc-2">"N"</span><span class="psc-4">,</span> <span class="psc-1">3</span>)

price1 <span class="psc-4">=</span> <span class="psc-5">request.security</span>(
  symbol <span class="psc-4">=</span> s1<span class="psc-4">,</span> 
  timeframe <span class="psc-4">=</span> <span class="psc-6">timeframe.period</span><span class="psc-4">,</span> 
  expression <span class="psc-4">=</span> <span class="psc-6">close</span>
  )
price2 <span class="psc-4">=</span> <span class="psc-5">request.security</span>(
  symbol <span class="psc-4">=</span> s2<span class="psc-4">,</span> 
  timeframe <span class="psc-4">=</span> <span class="psc-6">timeframe.period</span><span class="psc-4">,</span> 
  expression <span class="psc-4">=</span> <span class="psc-6">close</span>
  )
price3 <span class="psc-4">=</span> <span class="psc-5">request.security</span>(
  symbol <span class="psc-4">=</span> s3<span class="psc-4">,</span> 
  timeframe <span class="psc-4">=</span> <span class="psc-6">timeframe.period</span><span class="psc-4">,</span> 
  expression <span class="psc-4">=</span> <span class="psc-6">close</span>
  )

<span class="psc-4">if</span> <span class="psc-6">barstate.islast</span>
    correlations <span class="psc-4">=</span> <span class="psc-5">matrix.new</span><<span class="psc-4">float</span>>(<span class="psc-1">3</span><span class="psc-4">,</span> <span class="psc-1">3</span>)
    prices <span class="psc-4">=</span> <span class="psc-5">matrix.new</span><<span class="psc-4">float</span>>(<span class="psc-1">3</span><span class="psc-4">,</span> n)

    <span class="psc-4">for</span> i <span class="psc-4">=</span> <span class="psc-1">0</span> <span class="psc-4">to</span> n <span class="psc-4">-</span> <span class="psc-1">1</span>
        <span class="psc-5">matrix.set</span>(prices<span class="psc-4">,</span> <span class="psc-1">0</span><span class="psc-4">,</span> i<span class="psc-4">,</span> price1[i])
        <span class="psc-5">matrix.set</span>(prices<span class="psc-4">,</span> <span class="psc-1">1</span><span class="psc-4">,</span> i<span class="psc-4">,</span> price2[i])
        <span class="psc-5">matrix.set</span>(prices<span class="psc-4">,</span> <span class="psc-1">2</span><span class="psc-4">,</span> i<span class="psc-4">,</span> price3[i])

    <span class="psc-4">for</span> i <span class="psc-4">=</span> <span class="psc-1">0</span> <span class="psc-4">to</span> <span class="psc-1">2</span>
        <span class="psc-4">for</span> j <span class="psc-4">=</span> <span class="psc-1">0</span> <span class="psc-4">to</span> <span class="psc-1">2</span>
            prices1 <span class="psc-4">=</span> <span class="psc-5">matrix.row</span>(prices<span class="psc-4">,</span> i)
            prices2 <span class="psc-4">=</span> <span class="psc-5">matrix.row</span>(prices<span class="psc-4">,</span> j)
            cov <span class="psc-4">=</span> <span class="psc-5">array.covariance</span>(prices1<span class="psc-4">,</span> prices2)
            std1 <span class="psc-4">=</span> <span class="psc-5">array.stdev</span>(prices1)
            std2 <span class="psc-4">=</span> <span class="psc-5">array.stdev</span>(prices2)
            corr <span class="psc-4">=</span> <span class="psc-5">math.round</span>(cov <span class="psc-4">/</span> (std1 <span class="psc-4">*</span> std2)<span class="psc-4">,</span> <span class="psc-1">2</span>)
            <span class="psc-5">matrix.set</span>(correlations<span class="psc-4">,</span> j<span class="psc-4">,</span> i<span class="psc-4">,</span> corr)

    <span class="psc-5">label.new</span>(
      x <span class="psc-4">=</span> <span class="psc-6">bar_index</span><span class="psc-4">,</span>
      y <span class="psc-4">=</span> <span class="psc-1">0</span><span class="psc-4">,</span>
      text <span class="psc-4">=</span> <span class="psc-5">str.tostring</span>(correlations)<span class="psc-4">,</span>
      style <span class="psc-4">=</span> <span class="psc-6">label.style_label_center</span><span class="psc-4">,</span>
      textcolor <span class="psc-4">=</span> <span class="psc-6">color.white</span><span class="psc-4">,</span>
      size <span class="psc-4">=</span> <span class="psc-6">size.large</span>
      )</code></pre>
                    </div>
                    <p>Повторяем теорию:</p>
                    <ul>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_matrix.row"
                          target="_blank"
                          class="underline"
                          >matrix.row()</a
                        >
                        возвращает объект <em>array</em> из элементов строки
                        исходного объекта <em>matrix</em>;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_array.covariance"
                          target="_blank"
                          class="underline"
                          >array.covariance()</a
                        >
                        возвращает ковариацию между элементами двух объектов
                        <em>array</em>;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_array.stdev"
                          target="_blank"
                          class="underline"
                          >array.stdev()</a
                        >
                        возвращает стандартное отклонение элементов объекта
                        <em>array</em>;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_math.round"
                          target="_blank"
                          class="underline"
                          >math.round()</a
                        >
                        округляет число с заданной точностью.
                      </li>
                    </ul>
                    <div class="note-box">
                      <div class="note-box-header">На заметку</div>
                      <p>
                        Цикл, размещённый внутри тела другого цикла, называется
                        вложенным циклом.
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>
          <section id="section-28">
            <h4>Задача #28. Частота слов</h4>
            <p>Написать индикатор.</p>
            <h5>Ввод</h5>
            <p>Строка из слов S.</p>
            <h5>Основные вычисления</h5>
            <p>Частота каждого слова в строке S.</p>
            <h5>Вывод</h5>
            <p>Частота каждого слова объектом <em>label</em>.</p>
            <a href="images/tasks/task-28-L.png" class="image">
              <img
                src="images/tasks/task-28-L.png"
                class="img-fluid img-thumbnail"
              />
            </a>
            <div class="accordion" id="task-28">
              <div class="accordion-item">
                <div class="accordion-header">
                  <button
                    class="accordion-button collapsed"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#collapse-28"
                  >
                    Решение
                  </button>
                </div>
                <div
                  id="collapse-28"
                  class="accordion-collapse collapse"
                  data-bs-parent="#task-28"
                >
                  <div class="accordion-body">
                    <div class="code-box">
                      <pre><code><span class="psc-3">//@version=6</span>
<span class="psc-5">indicator</span>(<span class="psc-2">"Task #28"</span>)

s <span class="psc-4">=</span> <span class="psc-5">input.string</span>(<span class="psc-2">"a ab ABC ab"</span><span class="psc-4">,</span> <span class="psc-2">"S"</span>)

<span class="psc-4">if</span> <span class="psc-6">barstate.islast</span>
    frequencies <span class="psc-4">=</span> <span class="psc-5">map.new</span><<span class="psc-4">string</span><span class="psc-4">,</span> <span class="psc-4">int</span>>()
    words <span class="psc-4">=</span> <span class="psc-5">str.split</span>(s<span class="psc-4">,</span> <span class="psc-2">" "</span>)
    labelText <span class="psc-4">=</span> <span class="psc-5">string</span>(<span class="psc-6">na</span>)

    <span class="psc-4">for</span> word <span class="psc-4">in</span> words
        <span class="psc-4">if</span> <span class="psc-5">map.contains</span>(frequencies<span class="psc-4">,</span> word)
            <span class="psc-5">map.put</span>(frequencies<span class="psc-4">,</span> word<span class="psc-4">,</span> <span class="psc-5">map.get</span>(frequencies<span class="psc-4">,</span> word) <span class="psc-4">+</span> <span class="psc-1">1</span>)
        <span class="psc-4">else</span>
            <span class="psc-5">map.put</span>(frequencies<span class="psc-4">,</span> word<span class="psc-4">,</span> <span class="psc-1">1</span>)

    <span class="psc-4">for</span> [key<span class="psc-4">,</span> value] <span class="psc-4">in</span> frequencies
        labelText <span class="psc-4">+=</span> <span class="psc-5">str.format</span>(<span class="psc-2">"{0} {1}\n"</span><span class="psc-4">,</span> key<span class="psc-4">,</span> value)

    <span class="psc-5">label.new</span>(
      x <span class="psc-4">=</span> <span class="psc-6">bar_index</span><span class="psc-4">,</span>
      y <span class="psc-4">=</span> <span class="psc-1">0</span><span class="psc-4">,</span>
      text <span class="psc-4">=</span> <span class="psc-5">str.trim</span>(labelText)<span class="psc-4">,</span>
      style <span class="psc-4">=</span> <span class="psc-6">label.style_label_center</span><span class="psc-4">,</span>
      textcolor <span class="psc-4">=</span> <span class="psc-6">color.white</span><span class="psc-4">,</span>
      size <span class="psc-4">=</span> <span class="psc-6">size.large</span><span class="psc-4">,</span>
      textalign <span class="psc-4">=</span> <span class="psc-6">text.align_left</span>
      )</code></pre>
                    </div>
                    <p>Повторяем теорию:</p>
                    <ul>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_map.new%3Ctype,type%3E"
                          target="_blank"
                          class="underline"
                          >map.new&ltkeyType, valueType&gt()</a
                        >
                        создаёт объект <em>map</em>, предназначенный для
                        хранения пар «ключ-значение», где все ключи имеют тип
                        <em>keyType</em>, а все значения — тип
                        <em>valueType</em>;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_map.contains"
                          target="_blank"
                          class="underline"
                          >map.contains()</a
                        >
                        возвращает значение <em>true</em>, если в объекте
                        <em>map</em>
                        присутствует указанный ключ, иначе возвращает значение
                        <em>false</em>;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_map.put"
                          target="_blank"
                          class="underline"
                          >map.put()</a
                        >
                        добавляет в объект <em>map</em> новую пару
                        «ключ-значение»;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_map.get"
                          target="_blank"
                          class="underline"
                          >map.get()</a
                        >
                        возвращает значение объекта <em>map</em>,
                        ассоциированное с указанным ключом;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_str.trim"
                          target="_blank"
                          class="underline"
                          >str.trim()</a
                        >
                        возвращает строку на основе указанной строки, в начале
                        и в конце которой удалены все пробелы и управляющие
                        символы, например,
                        <em>"\n"</em>.
                      </li>
                    </ul>
                    <div class="note-box">
                      <div class="note-box-header">На заметку</div>
                      <p>
                        Цикл
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#kw_for...in"
                          target="_blank"
                          class="underline"
                          >for…in</a
                        >
                        предоставляет удобный способ перебора элементов
                        коллекции.
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>
          <section id="section-29">
            <h4>Задача #29. Шифр подстановки</h4>
            <p>Написать индикатор.</p>
            <h5>Ввод</h5>
            <p>Строка с ключом шифрования S1.</p>
            <p>Строка с открытым текстом S2.</p>
            <p>Строка с зашифрованным текстом S3.</p>
            <h5>Основные вычисления</h5>
            <p>
              Шифрование открытого текста строки S2 с помощью ключа, указанного
              в строке S1. Например, строка S1 равна
              <nobr><em>"a* bd c% d#"</em></nobr
              >. Значит, символы <em>"a"</em> текста заменяются на символы
              <em>"*"</em>, символы <em>"b"</em> — на символы <em>"d"</em> и
              т.д.
            </p>
            <p>
              Расшифровка зашифрованного текста строки S3 с помощью ключа,
              указанного в строке S1. Например, строка S1 равна
              <nobr><em>"a* bd c% d#"</em></nobr
              >. Значит, символы <em>"*"</em> текста заменяются на символы
              <em>"a"</em>, символы <em>"d"</em> — на символы <em>"b"</em> и
              т.д.
            </p>
            <h5>Вывод</h5>
            <p>
              Зашифрованный и расшифрованный текст объектом <em>label</em>.
            </p>
            <a href="images/tasks/task-29-L.png" class="image">
              <img
                src="images/tasks/task-29-L.png"
                class="img-fluid img-thumbnail"
              />
            </a>
            <div class="accordion" id="task-29">
              <div class="accordion-item">
                <div class="accordion-header">
                  <button
                    class="accordion-button collapsed"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#collapse-29"
                  >
                    Решение
                  </button>
                </div>
                <div
                  id="collapse-29"
                  class="accordion-collapse collapse"
                  data-bs-parent="#task-29"
                >
                  <div class="accordion-body">
                    <div class="code-box">
                      <pre><code><span class="psc-3">//@version=6</span>
<span class="psc-5">indicator</span>(<span class="psc-2">"Task #29"</span><span class="psc-4">,</span> overlay <span class="psc-4">=</span> <span class="psc-6">true</span>)

s1 <span class="psc-4">=</span> <span class="psc-5">input.string</span>(<span class="psc-2">"a* bd c% d#"</span><span class="psc-4">,</span> <span class="psc-2">"S1"</span>)
s2 <span class="psc-4">=</span> <span class="psc-5">input.string</span>(<span class="psc-2">"abacd, acbd."</span><span class="psc-4">,</span> <span class="psc-2">"S2"</span>)
s3 <span class="psc-4">=</span> <span class="psc-5">input.string</span>(<span class="psc-2">"*d*%#, *%d#."</span><span class="psc-4">,</span> <span class="psc-2">"S3"</span>)

<span class="psc-4">if</span> <span class="psc-6">barstate.islast</span>
    privateKey <span class="psc-4">=</span> <span class="psc-5">map.new</span><<span class="psc-4">string</span><span class="psc-4">,</span> <span class="psc-4">string</span>>()
    encryptedText <span class="psc-4">=</span> <span class="psc-5">string</span>(<span class="psc-6">na</span>)
    decryptedText <span class="psc-4">=</span> <span class="psc-5">string</span>(<span class="psc-6">na</span>)

    <span class="psc-4">for</span> symbols <span class="psc-4">in</span> <span class="psc-5">str.split</span>(s1<span class="psc-4">,</span> <span class="psc-2">" "</span>)
        <span class="psc-5">map.put</span>(
          id <span class="psc-4">=</span> privateKey<span class="psc-4">,</span> 
          key <span class="psc-4">=</span> <span class="psc-5">str.substring</span>(symbols<span class="psc-4">,</span> <span class="psc-1">0</span><span class="psc-4">,</span> <span class="psc-1">1</span>)<span class="psc-4">,</span>
          value <span class="psc-4">=</span> <span class="psc-5">str.substring</span>(symbols<span class="psc-4">,</span> <span class="psc-1">1</span><span class="psc-4">,</span> <span class="psc-1">2</span>)
          )

    keys <span class="psc-4">=</span> <span class="psc-5">map.keys</span>(privateKey)
    values <span class="psc-4">=</span> <span class="psc-5">map.values</span>(privateKey)

    <span class="psc-4">for</span> symbol <span class="psc-4">in</span> <span class="psc-5">str.split</span>(s2<span class="psc-4">,</span> <span class="psc-2">""</span>)
        index <span class="psc-4">=</span> <span class="psc-5">array.indexof</span>(keys<span class="psc-4">,</span> symbol)

        <span class="psc-4">if</span> index <span class="psc-4">!=</span> <span class="psc-1">-1</span>
            encryptedText <span class="psc-4">+=</span> <span class="psc-5">array.get</span>(values<span class="psc-4">,</span> index)
        <span class="psc-4">else</span>
            encryptedText <span class="psc-4">+=</span> symbol

    <span class="psc-4">for</span> symbol <span class="psc-4">in</span> <span class="psc-5">str.split</span>(s3<span class="psc-4">,</span> <span class="psc-2">""</span>)
        index <span class="psc-4">=</span> <span class="psc-5">array.indexof</span>(values<span class="psc-4">,</span> symbol)

        <span class="psc-4">if</span> index <span class="psc-4">!=</span> <span class="psc-1">-1</span>
            decryptedText <span class="psc-4">+=</span> <span class="psc-5">array.get</span>(keys<span class="psc-4">,</span> index)
        <span class="psc-4">else</span>
            decryptedText <span class="psc-4">+=</span> symbol

    <span class="psc-5">label.new</span>(
      x <span class="psc-4">=</span> <span class="psc-6">bar_index</span><span class="psc-4">,</span>
      y <span class="psc-4">=</span> <span class="psc-6">na</span><span class="psc-4">,</span>
      text <span class="psc-4">=</span> <span class="psc-5">str.format</span>(<span class="psc-2">"{0}\n{1}"</span><span class="psc-4">,</span> encryptedText<span class="psc-4">,</span> decryptedText)<span class="psc-4">,</span>
      yloc <span class="psc-4">=</span> <span class="psc-6">yloc.abovebar</span><span class="psc-4">,</span>
      style <span class="psc-4">=</span> <span class="psc-6">label.style_label_center</span><span class="psc-4">,</span>
      textcolor <span class="psc-4">=</span> <span class="psc-6">color.white</span><span class="psc-4">,</span>
      size <span class="psc-4">=</span> <span class="psc-6">size.large</span><span class="psc-4">,</span>
      textalign <span class="psc-4">=</span> <span class="psc-6">text.align_left</span>
      )</code></pre>
                    </div>
                    <p>Повторяем теорию:</p>
                    <ul>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_map.keys"
                          target="_blank"
                          class="underline"
                          >map.keys()</a
                        >
                        возвращает объект <em>array</em>, содержащий все ключи
                        указанного объекта <em>map</em>;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_map.values"
                          target="_blank"
                          class="underline"
                          >map.values()</a
                        >
                        возвращает объект <em>array</em>, содержащий все
                        значения указанного объекта <em>map</em>;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_array.indexof"
                          target="_blank"
                          class="underline"
                          >array.indexof()</a
                        >
                        возвращает индекс первого найденного в объекте
                        <em>array</em> указанного значения, либо возвращает
                        <em>-1</em>, если значение не найдено.
                      </li>
                    </ul>
                    <div class="note-box">
                      <div class="note-box-header">На заметку</div>
                      <p>
                        Объект
                        <a
                          href="https://www.tradingview.com/pine-script-docs/language/maps/#maps"
                          target="_blank"
                          class="underline"
                          >map</a
                        >
                        может содержать до 50,000 пар «ключ-значение».
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>
          <section id="section-30">
            <h4>Задача #30. Рост цен</h4>
            <p>Написать индикатор.</p>
            <h5>Ввод</h5>
            <p>Целое число N. Минимальное значение: <em>1</em>.</p>
            <h5>Основные вычисления</h5>
            <p>
              Логический сигнал, принимающий значение <em>true</em>, если цены
              закрытия баров увеличиваются N баров подряд и текущий бар
              является закрытым, иначе принимающий значение <em>false</em>.
            </p>
            <h5>Вывод</h5>
            <p>
              Оповещение, содержащее цену открытия, максимума, минимума и
              закрытия последнего бара. Оповещение должно сработать только один
              раз при значении <em>true</em> логического сигнала.
            </p>
            <a href="images/tasks/task-30-2-L.png" class="image">
              <img
                src="images/tasks/task-30-2-L.png"
                class="img-fluid img-thumbnail"
              />
            </a>
            <div class="accordion" id="task-30">
              <div class="accordion-item">
                <div class="accordion-header">
                  <button
                    class="accordion-button collapsed"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#collapse-30"
                  >
                    Решение
                  </button>
                </div>
                <div
                  id="collapse-30"
                  class="accordion-collapse collapse"
                  data-bs-parent="#task-30"
                >
                  <div class="accordion-body">
                    <a href="images/tasks/task-30-1-L.png" class="image">
                      <img
                        src="images/tasks/task-30-1-L.png"
                        class="img-fluid img-thumbnail mt-0"
                      />
                    </a>
                    <div class="code-box">
                      <pre><code><span class="psc-3">//@version=6</span>
<span class="psc-5">indicator</span>(<span class="psc-2">"Task #30"</span><span class="psc-4">,</span> overlay <span class="psc-4">=</span> <span class="psc-6">true</span>)

n <span class="psc-4">=</span> <span class="psc-5">input.int</span>(<span class="psc-1">2</span><span class="psc-4">,</span> <span class="psc-2">"N"</span><span class="psc-4">,</span> <span class="psc-1">1</span>)

signal <span class="psc-4">=</span> <span class="psc-5">ta.rising</span>(<span class="psc-6">close</span><span class="psc-4">,</span> n) <span class="psc-4">and</span> <span class="psc-6">barstate.isconfirmed</span>

<span class="psc-5">alertcondition</span>(
  condition <span class="psc-4">=</span> signal<span class="psc-4">,</span> 
  title <span class="psc-4">=</span> <span class="psc-2">"Rising prices"</span><span class="psc-4">,</span> 
  message <span class="psc-4">=</span> <span class="psc-2">"O: {{open}}, H: {{high}}, L: {{low}}, C: {{close}}"</span>
  )</code></pre>
                    </div>
                    <p>Повторяем теорию:</p>
                    <ul>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_ta.rising"
                          target="_blank"
                          class="underline"
                          >ta.rising()</a
                        >
                        возвращает значение <em>true</em>, если серия значений
                        аргумента увеличивается заданное число баров подряд,
                        иначе возвращает значение <em>false</em>;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_alertcondition"
                          target="_blank"
                          class="underline"
                          >alertcondition()</a
                        >
                        создаёт условие оповещения, доступное в диалоговом окне
                        создания оповещения, на основе которого можно создать
                        оповещение.
                      </li>
                    </ul>
                    <div class="note-box">
                      <div class="note-box-header">На заметку</div>
                      <p>
                        Для вывода с помощью оповещений динамических значений
                        (могут меняться от бара к бару) существуют различные
                        <a
                          href="https://www.tradingview.com/pine-script-docs/concepts/alerts/#placeholders"
                          target="_blank"
                          class="underline"
                          >плейсхолдеры</a
                        >, которые указываются в сообщении оповещения.
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>
          <section id="section-31">
            <h4>Задача #31. Случайная сумма</h4>
            <p>Написать стратегию.</p>
            <h5>Ввод</h5>
            <p>Целое число N.</p>
            <h5>Основные вычисления</h5>
            <p>
              Сумма псевдослучайных целых чисел из открытого интервала (-N; N).
              Псевдослучайное число должно генерироваться при каждом обновлении
              бара реального времени.
            </p>
            <h5>Вывод</h5>
            <p>
              Оповещение при закрытии баров реального времени, содержащее сумму
              псевдослучайных чисел.
            </p>
            <a href="images/tasks/task-31-2-L.png" class="image">
              <img
                src="images/tasks/task-31-2-L.png"
                class="img-fluid img-thumbnail"
              />
            </a>
            <div class="accordion" id="task-31">
              <div class="accordion-item">
                <div class="accordion-header">
                  <button
                    class="accordion-button collapsed"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#collapse-31"
                  >
                    Решение
                  </button>
                </div>
                <div
                  id="collapse-31"
                  class="accordion-collapse collapse"
                  data-bs-parent="#task-31"
                >
                  <div class="accordion-body">
                    <a href="images/tasks/task-31-1-L.png" class="image">
                      <img
                        src="images/tasks/task-31-1-L.png"
                        class="img-fluid img-thumbnail mt-0"
                      />
                    </a>
                    <div class="code-box">
                      <pre><code><span class="psc-3">//@version=6</span>
<span class="psc-5">strategy</span>(<span class="psc-2">"Task #31"</span><span class="psc-4">,</span> overlay <span class="psc-4">=</span> <span class="psc-6">true</span><span class="psc-4">,</span> calc_on_every_tick <span class="psc-4">=</span> <span class="psc-6">true</span>)

n <span class="psc-4">=</span> <span class="psc-5">input.int</span>(<span class="psc-1">10</span><span class="psc-4">,</span> <span class="psc-2">"N"</span>)

<span class="psc-4">varip</span> sum <span class="psc-4">=</span> <span class="psc-1">0</span>

<span class="psc-4">if</span> <span class="psc-6">barstate.isconfirmed</span>
    <span class="psc-5">alert</span>(<span class="psc-2">"Random sum: "</span> <span class="psc-4">+</span> <span class="psc-5">str.tostring</span>(sum))
    sum <span class="psc-4">:=</span> <span class="psc-1">0</span>
<span class="psc-4">else</span> <span class="psc-4">if</span> <span class="psc-6">barstate.isrealtime</span>
    sum <span class="psc-4">+=</span> <span class="psc-5">int</span>(<span class="psc-5">math.random</span>(<span class="psc-4">-</span>n<span class="psc-4">,</span> n))</code></pre>
                    </div>
                    <p>Повторяем теорию:</p>
                    <ul>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_alert"
                          target="_blank"
                          class="underline"
                          >alert()</a
                        >
                        создаёт оповещение при вызове на баре реального
                        времени;
                      </li>
                      <li>
                        переменная
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#var_barstate.isrealtime"
                          target="_blank"
                          class="underline"
                          >barstate.isrealtime</a
                        >
                        имеет значение <em>true</em>, если текущий бар является
                        баром реального времени, иначе переменная имеет
                        значение <em>false</em>;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_math.random"
                          target="_blank"
                          class="underline"
                          >math.random()</a
                        >
                        возвращает псевдослучайное вещественное число.
                      </li>
                    </ul>
                    <div class="note-box">
                      <div class="note-box-header">На заметку</div>
                      <p>
                        По сравнению с функцией
                        <a
                          href="https://www.tradingview.com/pine-script-docs/concepts/alerts/#alertcondition-events"
                          target="_blank"
                          class="underline"
                          >alertcondition()</a
                        >, функция
                        <a
                          href="https://www.tradingview.com/pine-script-docs/concepts/alerts/#alert-function-events"
                          target="_blank"
                          class="underline"
                          >alert()</a
                        >
                        является более универсальной: функция может
                        использоваться в скриптах стратегий, вызов функции
                        может располагаться в локальной области видимости, а
                        также функция может выводить динамические значения без
                        плейсхолдеров.
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>
          <section id="section-32">
            <h4>Задача #32. Сессия</h4>
            <p>Написать индикатор.</p>
            <h5>Ввод</h5>
            <p>Сессия S.</p>
            <p>Цвет C.</p>
            <h5>Основные вычисления</h5>
            <p>
              Логический сигнал, принимающий значение <em>true</em>, если время
              открытия текущего бара находится в пределах сессии S, иначе
              принимающий значение <em>false</em>.
            </p>
            <h5>Вывод</h5>
            <p>
              Перекраска баров в цвет C, на которых логический сигнал равен
              <em>false</em>.
            </p>
            <a href="images/tasks/task-32-L.png" class="image">
              <img
                src="images/tasks/task-32-L.png"
                class="img-fluid img-thumbnail"
              />
            </a>
            <div class="accordion" id="task-32">
              <div class="accordion-item">
                <div class="accordion-header">
                  <button
                    class="accordion-button collapsed"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#collapse-32"
                  >
                    Решение
                  </button>
                </div>
                <div
                  id="collapse-32"
                  class="accordion-collapse collapse"
                  data-bs-parent="#task-32"
                >
                  <div class="accordion-body">
                    <div class="code-box">
                      <pre><code><span class="psc-3">//@version=6</span>
<span class="psc-5">indicator</span>(<span class="psc-2">"Task #32"</span><span class="psc-4">,</span> overlay <span class="psc-4">=</span> <span class="psc-6">true</span>)

s <span class="psc-4">=</span> <span class="psc-5">input.session</span>(<span class="psc-2">"0600-1800"</span><span class="psc-4">,</span> <span class="psc-2">"S"</span>)
c <span class="psc-4">=</span> <span class="psc-5">input.color</span>(<span class="psc-5">color.new</span>(<span class="psc-6">color.black</span><span class="psc-4">,</span> <span class="psc-1">100</span>)<span class="psc-4">,</span> <span class="psc-2">"C"</span>)

signal <span class="psc-4">=</span> <span class="psc-5">bool</span>(<span class="psc-5">time</span>(<span class="psc-6">timeframe.period</span><span class="psc-4">,</span> s))

<span class="psc-5">barcolor</span>(<span class="psc-4">not</span> signal <span class="psc-4">?</span> c <span class="psc-4">:</span> <span class="psc-6">na</span>)</code></pre>
                    </div>
                    <p>Повторяем теорию:</p>
                    <ul>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_input.session"
                          target="_blank"
                          class="underline"
                          >input.session()</a
                        >
                        добавляет в настройки скрипта два выпадающих меню,
                        которые позволяют выбрать время начала и конца сессии;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_time"
                          target="_blank"
                          class="underline"
                          >time()</a
                        >
                        возвращает Unix-время открытия текущего бара для
                        заданного таймфрейма и сессии, либо возвращает
                        <em>na</em>, если Unix-время бара находится вне сессии;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_barcolor"
                          target="_blank"
                          class="underline"
                          >barcolor()</a
                        >
                        задаёт цвет баров.
                      </li>
                    </ul>
                    <div class="note-box">
                      <div class="note-box-header">На заметку</div>
                      <p>
                        <a
                          href="https://www.tradingview.com/pine-script-docs/concepts/sessions/#session-strings"
                          target="_blank"
                          class="underline"
                          >Строки сессии</a
                        >, содержащие время начала и конца сессии, также могут
                        включать дни недели, в которые сессия действительна.
                        Например, строка <em>"0950-1850:23456"</em> означает,
                        что сессия начинается в 09:50 и заканчивается в 18:50 с
                        понедельника по пятницу. Нумерация дней начинается с
                        воскресенья (1).
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>
          <section id="section-33">
            <h4>Задача #33. Экстремальные цены</h4>
            <p>Написать индикатор.</p>
            <h5>Ввод</h5>
            <p>Целое число N.</p>
            <p>Вещественное число P1.</p>
            <p>Вещественное число P2.</p>
            <p>Цвет с прозрачностью 0 % C1.</p>
            <p>Цвет с прозрачностью 0 % C2.</p>
            <p>Цвет с прозрачностью 0 % C3.</p>
            <h5>Основные вычисления</h5>
            <p>
              Индекс относительной силы (RSI — Relative Strength Index),
              вычисляемый на основе N цен закрытия баров.
            </p>
            <h5>Вывод</h5>
            <p>
              Горизонтальная линия на уровне цены P1 объектом <em>hline</em>.
            </p>
            <p>
              Горизонтальная линия на уровне цены P2 объектом <em>hline</em>.
            </p>
            <p>
              Индекс относительной силы объектом <em>plot</em> с цветом C1.
            </p>
            <p>
              Заливка фона между объектами <em>hline</em> цветом C1 с
              прозрачностью 90 %.
            </p>
            <p>
              Заливка фона между объектом <em>plot</em> и объектом
              <em>hline</em> на уровне цены P1 градиентом, основанным на цветах
              C2 и C2 с прозрачностью 100 %. Цвет градиента должен плавно
              переходить к цвету C2 сверху вниз.
            </p>
            <p>
              Заливка фона между объектом <em>plot</em> и объектом
              <em>hline</em> на уровне цены P2 градиентом, основанным на цветах
              C3 и C3 с прозрачностью 100 %. Цвет градиента должен плавно
              переходить к цвету C3 снизу вверх.
            </p>
            <a href="images/tasks/task-33-L.png" class="image">
              <img
                src="images/tasks/task-33-L.png"
                class="img-fluid img-thumbnail"
              />
            </a>
            <div class="accordion" id="task-33">
              <div class="accordion-item">
                <div class="accordion-header">
                  <button
                    class="accordion-button collapsed"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#collapse-33"
                  >
                    Решение
                  </button>
                </div>
                <div
                  id="collapse-33"
                  class="accordion-collapse collapse"
                  data-bs-parent="#task-33"
                >
                  <div class="accordion-body">
                    <div class="code-box">
                      <pre><code><span class="psc-3">//@version=6</span>
<span class="psc-5">indicator</span>(<span class="psc-2">"Task #33"</span>)

n <span class="psc-4">=</span> <span class="psc-5">input.int</span>(<span class="psc-1">7</span><span class="psc-4">,</span> <span class="psc-2">"N"</span>)
p1 <span class="psc-4">=</span> <span class="psc-5">input.float</span>(<span class="psc-1">30.0</span><span class="psc-4">,</span> <span class="psc-2">"P1"</span>)
p2 <span class="psc-4">=</span> <span class="psc-5">input.float</span>(<span class="psc-1">70.0</span><span class="psc-4">,</span> <span class="psc-2">"P2"</span>)
c1 <span class="psc-4">=</span> <span class="psc-5">input.color</span>(<span class="psc-6">color.blue</span><span class="psc-4">,</span> <span class="psc-2">"C1"</span>)
c2 <span class="psc-4">=</span> <span class="psc-5">input.color</span>(<span class="psc-6">color.red</span><span class="psc-4">,</span> <span class="psc-2">"C2"</span>)
c3 <span class="psc-4">=</span> <span class="psc-5">input.color</span>(<span class="psc-6">color.green</span><span class="psc-4">,</span> <span class="psc-2">"C3"</span>)

rsi <span class="psc-4">=</span> <span class="psc-5">ta.rsi</span>(<span class="psc-6">close</span><span class="psc-4">,</span> n)
c1r <span class="psc-4">=</span> <span class="psc-5">color.r</span>(c1)
c2r <span class="psc-4">=</span> <span class="psc-5">color.r</span>(c2)
c3r <span class="psc-4">=</span> <span class="psc-5">color.r</span>(c3)
c1g <span class="psc-4">=</span> <span class="psc-5">color.g</span>(c1)
c2g <span class="psc-4">=</span> <span class="psc-5">color.g</span>(c2)
c3g <span class="psc-4">=</span> <span class="psc-5">color.g</span>(c3)
c1b <span class="psc-4">=</span> <span class="psc-5">color.b</span>(c1)
c2b <span class="psc-4">=</span> <span class="psc-5">color.b</span>(c2)
c3b <span class="psc-4">=</span> <span class="psc-5">color.b</span>(c3)

hline1 <span class="psc-4">=</span> <span class="psc-5">hline</span>(p1)
hline2 <span class="psc-4">=</span> <span class="psc-5">hline</span>(p2)

plot1 <span class="psc-4">=</span> <span class="psc-5">plot</span>(rsi<span class="psc-4">,</span> color <span class="psc-4">=</span> c1<span class="psc-4">,</span> linewidth <span class="psc-4">=</span> <span class="psc-1">2</span>)
plot2 <span class="psc-4">=</span> <span class="psc-5">plot</span>(p1<span class="psc-4">,</span> editable <span class="psc-4">=</span> <span class="psc-6">false</span><span class="psc-4">,</span> display <span class="psc-4">=</span> <span class="psc-6">display.none</span>)
plot3 <span class="psc-4">=</span> <span class="psc-5">plot</span>(p2<span class="psc-4">,</span> editable <span class="psc-4">=</span> <span class="psc-6">false</span><span class="psc-4">,</span> display <span class="psc-4">=</span> <span class="psc-6">display.none</span>)

<span class="psc-5">fill</span>(hline1<span class="psc-4">,</span> hline2<span class="psc-4">,</span> <span class="psc-5">color.rgb</span>(c1r<span class="psc-4">,</span> c1g<span class="psc-4">,</span> c1b<span class="psc-4">,</span> <span class="psc-1">90</span>))
<span class="psc-5">fill</span>(plot1<span class="psc-4">,</span> plot2<span class="psc-4">,</span> p1<span class="psc-4">,</span> <span class="psc-1">0</span><span class="psc-4">,</span> <span class="psc-5">color.rgb</span>(c2r<span class="psc-4">,</span> c2g<span class="psc-4">,</span> c2b<span class="psc-4">,</span> <span class="psc-1">100</span>)<span class="psc-4">,</span> c2)
<span class="psc-5">fill</span>(plot1<span class="psc-4">,</span> plot3<span class="psc-4">,</span> <span class="psc-1">100</span><span class="psc-4">,</span> p2<span class="psc-4">,</span> c3<span class="psc-4">,</span> <span class="psc-5">color.rgb</span>(c3r<span class="psc-4">,</span> c3g<span class="psc-4">,</span> c3b<span class="psc-4">,</span> <span class="psc-1">100</span>))</code></pre>
                    </div>
                    <p>Повторяем теорию:</p>
                    <ul>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_ta.rsi"
                          target="_blank"
                          class="underline"
                          >ta.rsi()</a
                        >
                        возвращает индекс относительной силы;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_color.r"
                          target="_blank"
                          class="underline"
                          >color.r()</a
                        >
                        возвращает значение красного компонента цвета;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_color.g"
                          target="_blank"
                          class="underline"
                          >color.g()</a
                        >
                        возвращает значение зелёного компонента цвета;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_color.b"
                          target="_blank"
                          class="underline"
                          >color.b()</a
                        >
                        возвращает значение синего компонента цвета;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_hline"
                          target="_blank"
                          class="underline"
                          >hline()</a
                        >
                        создаёт объект <em>hline</em> и отображает его на
                        графике;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_fill"
                          target="_blank"
                          class="underline"
                          >fill()</a
                        >
                        закрашивает фон между двумя объектами <em>plot</em> или
                        <em>hline</em> указанным цветом;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_color.rgb"
                          target="_blank"
                          class="underline"
                          >color.rgb()</a
                        >
                        создаёт цвет на основе значений компонентов модели RGB
                        и прозрачности.
                      </li>
                    </ul>
                    <div class="note-box">
                      <div class="note-box-header">На заметку</div>
                      <p>
                        Pine Script поддерживает перегрузку
                        <a
                          href="https://www.tradingview.com/pine-script-docs/release-notes/#function-overloads"
                          target="_blank"
                          class="underline"
                          >функций</a
                        >
                        и
                        <a
                          href="https://www.tradingview.com/pine-script-docs/language/methods/#method-overloading"
                          target="_blank"
                          class="underline"
                          >методов</a
                        >. Эта возможность позволяет определять одноимённые
                        пользовательские функции или методы с разными
                        параметрами.
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>
          <section id="section-34">
            <h4>Задача #34. Полином</h4>
            <p>Написать библиотеку и индикатор.</p>
            <h5>Ввод</h5>
            <p>Источник для расчётов S.</p>
            <p>Целое число N1. Минимальное значение: <em>2</em>.</p>
            <p>Целое число N2. Минимальное значение: <em>0</em>.</p>
            <p>Целое число D. Минимальное значение: <em>1</em>.</p>
            <h5>Основные вычисления</h5>
            <p>
              Модель однофакторной полиномиальной регрессии степени D на основе
              N1 последних значений данных S. В библиотеке должна быть
              определена пользовательская функция <em>polyreg</em>, вычисляющая
              параметры модели регрессии и прогнозные значения,
              аппроксимирующие N1 последних и N2 будущих значений данных S.
              Параметры регрессии должны вычисляться матричным методом.
            </p>
            <h5>Вывод</h5>
            <p>
              Объект <em>polyline</em> на последнем баре, соединяющий
              прогнозные значения по модели регрессии. Вычисление массива
              объектов <em>chart.point</em> и вывод объекта
              <em>polyline</em> должны быть реализованы в индикаторе.
            </p>
            <a href="images/tasks/task-34-L.png" class="image">
              <img
                src="images/tasks/task-34-L.png"
                class="img-fluid img-thumbnail"
              />
            </a>
            <div class="accordion" id="task-34">
              <div class="accordion-item">
                <div class="accordion-header">
                  <button
                    class="accordion-button collapsed"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#collapse-34"
                  >
                    Решение
                  </button>
                </div>
                <div
                  id="collapse-34"
                  class="accordion-collapse collapse"
                  data-bs-parent="#task-34"
                >
                  <div class="accordion-body">
                    <div class="code-box mb-2-5">
                      <pre><code><span class="psc-3">//@version=6</span>
<span class="psc-5">library</span>(<span class="psc-2">"PolynomialRegression"</span><span class="psc-4">,</span> overlay <span class="psc-4">=</span> <span class="psc-6">true</span>)

<span class="psc-4">export</span> <span class="psc-7">polyreg</span>(<span class="psc-4">float</span> source<span class="psc-4">,</span> <span class="psc-4">int</span> length<span class="psc-4">,</span> <span class="psc-4">int</span> degree<span class="psc-4">,</span> <span class="psc-4">int</span> extrapolate) <span class="psc-4">=></span>
    X1 <span class="psc-4">=</span> <span class="psc-5">matrix.new</span><<span class="psc-4">float</span>>(length <span class="psc-4">+</span> extrapolate<span class="psc-4">,</span> degree <span class="psc-4">+</span> <span class="psc-1">1</span>)
    y <span class="psc-4">=</span> <span class="psc-5">matrix.new</span><<span class="psc-4">float</span>>(length<span class="psc-4">,</span> <span class="psc-1">1</span>)

    <span class="psc-4">for</span> i <span class="psc-4">=</span> <span class="psc-1">0</span> <span class="psc-4">to</span> length <span class="psc-4">+</span> extrapolate <span class="psc-4">-</span> <span class="psc-1">1</span>
        <span class="psc-4">for</span> j <span class="psc-4">=</span> <span class="psc-1">0</span> <span class="psc-4">to</span> degree
            <span class="psc-5">matrix.set</span>(X1<span class="psc-4">,</span> i<span class="psc-4">,</span> j<span class="psc-4">,</span> <span class="psc-5">math.pow</span>(i<span class="psc-4">,</span> j))

    <span class="psc-4">for</span> i <span class="psc-4">=</span> <span class="psc-1">0</span> <span class="psc-4">to</span> length <span class="psc-4">-</span> <span class="psc-1">1</span>
        <span class="psc-5">matrix.set</span>(y<span class="psc-4">,</span> i<span class="psc-4">,</span> <span class="psc-1">0</span><span class="psc-4">,</span> source[length <span class="psc-4">-</span> i <span class="psc-4">-</span> <span class="psc-1">1</span>])

    X2 <span class="psc-4">=</span> <span class="psc-5">matrix.submatrix</span>(
      id <span class="psc-4">=</span> X1<span class="psc-4">,</span>
      from_row <span class="psc-4">=</span> <span class="psc-1">0</span><span class="psc-4">,</span>
      to_row <span class="psc-4">=</span> <span class="psc-5">matrix.rows</span>(X1) <span class="psc-4">-</span> extrapolate<span class="psc-4">,</span>
      from_column <span class="psc-4">=</span> <span class="psc-1">0</span><span class="psc-4">,</span>
      to_column <span class="psc-4">=</span> <span class="psc-5">matrix.columns</span>(X1)
      )
    b <span class="psc-4">=</span> <span class="psc-5">matrix.mult</span>(
      id1 <span class="psc-4">=</span> <span class="psc-5">matrix.mult</span>(
         id1 <span class="psc-4">=</span> <span class="psc-5">matrix.inv</span>(
           id <span class="psc-4">=</span> <span class="psc-5">matrix.mult</span>(
              id1 <span class="psc-4">=</span> <span class="psc-5">matrix.transpose</span>(X2)<span class="psc-4">,</span> 
              id2 <span class="psc-4">=</span> X2
              )
           )<span class="psc-4">,</span> 
         id2 <span class="psc-4">=</span> <span class="psc-5">matrix.transpose</span>(X2)
         )<span class="psc-4">,</span> 
      id2 <span class="psc-4">=</span> y
      )
    predictions <span class="psc-4">=</span> <span class="psc-5">matrix.mult</span>(X1<span class="psc-4">,</span> <span class="psc-5">matrix.col</span>(b<span class="psc-4">,</span> <span class="psc-1">0</span>))
    predictions</code></pre>
                    </div>
                    <div class="code-box">
                      <pre><code><span class="psc-3">//@version=6</span>
<span class="psc-5">indicator</span>(<span class="psc-2">"Task #34"</span><span class="psc-4">,</span> overlay <span class="psc-4">=</span> <span class="psc-6">true</span>)

<span class="psc-4">import</span> <span class="psc-5">kitoboynaya/PolynomialRegression/1</span> <span class="psc-4">as</span> <span class="psc-8">pr</span>

s <span class="psc-4">=</span> <span class="psc-5">input.source</span>(<span class="psc-6">close</span><span class="psc-4">,</span> <span class="psc-2">"S"</span>)
n1 <span class="psc-4">=</span> <span class="psc-5">input.int</span>(<span class="psc-1">25</span><span class="psc-4">,</span> <span class="psc-2">"N1"</span><span class="psc-4">,</span> <span class="psc-1">2</span>)
n2 <span class="psc-4">=</span> <span class="psc-5">input.int</span>(<span class="psc-1">10</span><span class="psc-4">,</span> <span class="psc-2">"N2"</span><span class="psc-4">,</span> <span class="psc-1">0</span>)
d <span class="psc-4">=</span> <span class="psc-5">input.int</span>(<span class="psc-1">3</span><span class="psc-4">,</span> <span class="psc-2">"D"</span><span class="psc-4">,</span> <span class="psc-1">1</span>)

predictions <span class="psc-4">=</span> <span class="psc-8">pr.polyreg</span>(s<span class="psc-4">,</span> n1<span class="psc-4">,</span> d<span class="psc-4">,</span> n2)

<span class="psc-4">if</span> <span class="psc-6">barstate.islast</span>
    chartPoints <span class="psc-4">=</span> <span class="psc-5">array.new</span><<span class="psc-4">chart.point</span>>()

    <span class="psc-4">for</span> [index<span class="psc-4">,</span> prediction] <span class="psc-4">in</span> predictions
        <span class="psc-5">array.push</span>(
          id <span class="psc-4">=</span> chartPoints<span class="psc-4">,</span>
          value <span class="psc-4">=</span> <span class="psc-5">chart.point.from_index</span>(
             index <span class="psc-4">=</span> <span class="psc-6">bar_index</span> <span class="psc-4">+</span> index <span class="psc-4">-</span> n1 <span class="psc-4">+</span> <span class="psc-1">1</span><span class="psc-4">,</span>
             price <span class="psc-4">=</span> prediction
             )
          )

    <span class="psc-5">polyline.new</span>(chartPoints<span class="psc-4">,</span> line_width <span class="psc-4">=</span> <span class="psc-1">2</span>)</code></pre>
                    </div>
                    <p>Повторяем теорию:</p>
                    <ul>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_library"
                          target="_blank"
                          class="underline"
                          >library()</a
                        >
                        определяет скрипт как библиотеку;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_matrix.submatrix"
                          target="_blank"
                          class="underline"
                          >matrix.submatrix()</a
                        >
                        возвращает объект <em>matrix</em>, являющийся
                        подматрицей исходного объекта <em>matrix</em> в
                        пределах указанных индексов;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_matrix.rows"
                          target="_blank"
                          class="underline"
                          >matrix.rows()</a
                        >
                        возвращает число строк в объекте <em>matrix</em>;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_matrix.columns"
                          target="_blank"
                          class="underline"
                          >matrix.columns()</a
                        >
                        возвращает число столбцов в объекте
                        <em>matrix</em>;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_matrix.col"
                          target="_blank"
                          class="underline"
                          >matrix.col()</a
                        >
                        возвращает объект <em>array</em> из элементов столбца
                        исходного объекта <em>matrix</em>.
                      </li>
                    </ul>
                    <div class="note-box">
                      <div class="note-box-header">На заметку</div>
                      <p>
                        Часто используемые пользовательские типы, методы и
                        функции удобно определять в
                        <a
                          href="https://www.tradingview.com/pine-script-docs/concepts/libraries/"
                          target="_blank"
                          class="underline"
                          >библиотеках</a
                        >.
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>
          <section id="section-35">
            <h4>Задача #35. Зоны поддержки</h4>
            <p>Написать индикатор.</p>
            <h5>Ввод</h5>
            <p>Целое число N1. Минимальное значение: <em>1</em>.</p>
            <p>Целое число N2. Минимальное значение: <em>1</em>.</p>
            <p>
              Вещественное число N3. Минимальное значение: <em>0</em>. Значение
              шага: <em>0.1</em>.
            </p>
            <p>Целое число N4. Минимальное значение: <em>0</em>.</p>
            <h5>Основные вычисления</h5>
            <p>
              Нижние точки разворота минимумов баров. Минимум бара считается
              нижней точкой разворота, если слева и справа от бара закрыто N1
              баров с более высокими минимумами.
            </p>
            <p>
              Массив зон поддержки. Каждая зона поддержки может быть
              потенциальной или подтверждённой. Потенциальная зона поддержки
              формируется при образовании нижней точки разворота вне границ
              других зон. Если между границами потенциальной зоны образовалось
              N2 точек разворота, то зона становится подтверждённой. Границы
              зоны должны вычисляться следующим образом: максимум зоны равен
              цене точки разворота плюс N3 %, а минимум зоны равен цене точки
              разворота минус N3 %. Если минимум закрытого бара меньше нижней
              границы зоны, то такая зона удаляется. Если размер массива больше
              числа N4, то первая зона массива удаляется.
            </p>
            <h5>Вывод</h5>
            <p>Объект <em>label</em> в начале каждой зоны поддержки.</p>
            <p>
              Подтверждённые зоны поддержки объектами <em>line</em> и
              <em>linefill</em>.
            </p>
            <a href="images/tasks/task-35-L.png" class="image">
              <img
                src="images/tasks/task-35-L.png"
                class="img-fluid img-thumbnail"
              />
            </a>
            <div class="accordion" id="task-35">
              <div class="accordion-item">
                <div class="accordion-header">
                  <button
                    class="accordion-button collapsed"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#collapse-35"
                  >
                    Решение
                  </button>
                </div>
                <div
                  id="collapse-35"
                  class="accordion-collapse collapse"
                  data-bs-parent="#task-35"
                >
                  <div class="accordion-body">
                    <div class="code-box mb-2-5">
                      <pre><code><span class="psc-3">//@version=6</span>
<span class="psc-5">indicator</span>(<span class="psc-2">"Task #35"</span><span class="psc-4">,</span> overlay <span class="psc-4">=</span> <span class="psc-6">true</span>)

n1 <span class="psc-4">=</span> <span class="psc-5">input.int</span>(<span class="psc-1">3</span><span class="psc-4">,</span> <span class="psc-2">"N1"</span><span class="psc-4">,</span> <span class="psc-1">1</span>)
n2 <span class="psc-4">=</span> <span class="psc-5">input.int</span>(<span class="psc-1">2</span><span class="psc-4">,</span> <span class="psc-2">"N2"</span><span class="psc-4">,</span> <span class="psc-1">1</span>)
n3 <span class="psc-4">=</span> <span class="psc-5">input.float</span>(<span class="psc-1">6.0</span><span class="psc-4">,</span> <span class="psc-2">"N3"</span><span class="psc-4"><span class="psc-4">,</span> <span class="psc-1">0</span>,</span> step <span class="psc-4">=</span> <span class="psc-1">0.1</span>)
n4 <span class="psc-4">=</span> <span class="psc-5">input.int</span>(<span class="psc-1">5</span><span class="psc-4">,</span> <span class="psc-2">"N4"</span><span class="psc-4">,</span> <span class="psc-1">0</span>)

<span class="psc-4">type</span> <span class="psc-4">Zone</span>
    <span class="psc-4">label</span> start <span class="psc-4">=</span> <span class="psc-6">na</span>
    <span class="psc-4">int</span> counter <span class="psc-4">=</span> <span class="psc-6">na</span>
    <span class="psc-4">float</span> price1 <span class="psc-4">=</span> <span class="psc-6">na</span>
    <span class="psc-4">float</span> price2 <span class="psc-4">=</span> <span class="psc-6">na</span>
    <span class="psc-4">line</span> level1 <span class="psc-4">=</span> <span class="psc-6">na</span>
    <span class="psc-4">line</span> level2 <span class="psc-4">=</span> <span class="psc-6">na</span>
    <span class="psc-4">linefill</span> lf <span class="psc-4">=</span> <span class="psc-6">na</span>

<span class="psc-4">method</span> <span class="psc-7">draw</span>(<span class="psc-4">Zone</span> this<span class="psc-4">,</span> price1<span class="psc-4">,</span> price2) <span class="psc-4">=></span>
    this.level1 <span class="psc-4">:=</span> <span class="psc-5">line.new</span>(
      x1 <span class="psc-4">=</span> <span class="psc-5">label.get_x</span>(this.start)<span class="psc-4">,</span>
      y1 <span class="psc-4">=</span> price1<span class="psc-4">,</span>
      x2 <span class="psc-4">=</span> <span class="psc-6">time</span><span class="psc-4">,</span>
      y2 <span class="psc-4">=</span> price1<span class="psc-4">,</span>
      xloc <span class="psc-4">=</span> <span class="psc-6">xloc.bar_time</span><span class="psc-4">,</span>
      extend <span class="psc-4">=</span> <span class="psc-6">extend.right</span><span class="psc-4">,</span>
      color <span class="psc-4">=</span> <span class="psc-6">color.green</span>
      )
    this.level2 <span class="psc-4">:=</span> <span class="psc-5">line.new</span>(
      x1 <span class="psc-4">=</span> <span class="psc-5">label.get_x</span>(this.start)<span class="psc-4">,</span>
      y1 <span class="psc-4">=</span> price2<span class="psc-4">,</span>
      x2 <span class="psc-4">=</span> <span class="psc-6">time</span><span class="psc-4">,</span>
      y2 <span class="psc-4">=</span> price2<span class="psc-4">,</span>
      xloc <span class="psc-4">=</span> <span class="psc-6">xloc.bar_time</span><span class="psc-4">,</span>
      extend <span class="psc-4">=</span> <span class="psc-6">extend.right</span><span class="psc-4">,</span>
      color <span class="psc-4">=</span> <span class="psc-6">color.green</span>
      )
    this.lf <span class="psc-4">:=</span> <span class="psc-5">linefill.new</span>(
      line1 <span class="psc-4">=</span> this.level1<span class="psc-4">,</span>
      line2 <span class="psc-4">=</span> this.level2<span class="psc-4">,</span>
      color <span class="psc-4">=</span> <span class="psc-5">color.new</span>(<span class="psc-6">color.green</span><span class="psc-4">,</span> <span class="psc-1">90</span>)
      )

<span class="psc-4">method</span> <span class="psc-7">clear</span>(<span class="psc-4">Zone</span> this) <span class="psc-4">=></span>
    <span class="psc-5">label.delete</span>(this.start)
    <span class="psc-5">line.delete</span>(this.level1)
    <span class="psc-5">line.delete</span>(this.level2)

<span class="psc-4">var</span> zones <span class="psc-4">=</span> <span class="psc-5">array.new</span><<span class="psc-4">Zone</span>>()
pivotLow <span class="psc-4">=</span> <span class="psc-5">ta.pivotlow</span>(n1<span class="psc-4">,</span> n1)
index <span class="psc-4">=</span> <span class="psc-1">0</span>

<span class="psc-4">while</span> index <span class="psc-4"><=</span> <span class="psc-5">array.size</span>(zones) <span class="psc-4">-</span> <span class="psc-1">1</span>
    price1 <span class="psc-4">=</span> <span class="psc-5">array.get</span>(zones<span class="psc-4">,</span> index).price1

    <span class="psc-4">if</span> <span class="psc-6">low</span> <span class="psc-4"><</span> price1
        <span class="psc-5">array.get</span>(zones<span class="psc-4">,</span> index).<span class="psc-7">clear</span>()
        <span class="psc-5">array.remove</span>(zones<span class="psc-4">,</span> index)
        index <span class="psc-4">-=</span> <span class="psc-1">1</span>

    index <span class="psc-4">+=</span> <span class="psc-1">1</span>

<span class="psc-4">if</span> <span class="psc-4">not</span> <span class="psc-5">na</span>(pivotLow)
    newZone <span class="psc-4">=</span> <span class="psc-6">true</span>

    <span class="psc-4">for</span> zone <span class="psc-4">in</span> zones
        price1 <span class="psc-4">=</span> zone.price1
        price2 <span class="psc-4">=</span> zone.price2

        <span class="psc-4">if</span> pivotLow <span class="psc-4">>=</span> price1 <span class="psc-4">and</span> pivotLow <span class="psc-4"><=</span> price2
            newZone <span class="psc-4">:=</span> <span class="psc-6">false</span>
            zone.counter <span class="psc-4">+=</span> <span class="psc-1">1</span>

            <span class="psc-4">if</span> zone.counter <span class="psc-4">==</span> n2
                zone.<span class="psc-7">draw</span>(price1<span class="psc-4">,</span> price2)

    <span class="psc-4">if</span> newZone
        start <span class="psc-4">=</span> <span class="psc-5">label.new</span>(
          x <span class="psc-4">=</span> <span class="psc-6">time</span>[n1]<span class="psc-4">,</span> 
          y <span class="psc-4">=</span> <span class="psc-6">high</span>[n1]<span class="psc-4">,</span> 
          xloc <span class="psc-4">=</span> <span class="psc-6">xloc.bar_time</span><span class="psc-4">,</span>
          size <span class="psc-4">=</span> <span class="psc-6">size.tiny</span>
          )
        counter <span class="psc-4">=</span> <span class="psc-1">0</span>
        price1 <span class="psc-4">=</span> pivotLow <span class="psc-4">*</span> (<span class="psc-1">100</span> <span class="psc-4">-</span> n3) <span class="psc-4">/</span> <span class="psc-1">100</span>
        price2 <span class="psc-4">=</span> pivotLow <span class="psc-4">*</span> (<span class="psc-1">100</span> <span class="psc-4">+</span> n3) <span class="psc-4">/</span> <span class="psc-1">100</span>
        zone <span class="psc-4">=</span> <span class="psc-7">Zone.new</span>(start<span class="psc-4">,</span> counter<span class="psc-4">,</span> price1<span class="psc-4">,</span> price2)
        <span class="psc-5">array.push</span>(zones<span class="psc-4">,</span> zone)

<span class="psc-4">if</span> <span class="psc-5">array.size</span>(zones) <span class="psc-4">></span> n4
    <span class="psc-5">array.get</span>(zones<span class="psc-4">,</span> <span class="psc-1">0</span>).<span class="psc-7">clear</span>()
    <span class="psc-5">array.shift</span>(zones)</code></pre>
                    </div>
                    <p>Повторяем теорию:</p>
                    <ul>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_label.get_x"
                          target="_blank"
                          class="underline"
                          >label.get_x()</a
                        >
                        возвращает координату X объекта
                        <em>label</em> (Unix-время или индекс бара);
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_linefill.new"
                          target="_blank"
                          class="underline"
                          >linefill.new()</a
                        >
                        создаёт объект <em>linefill</em> и отображает его на
                        графике;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_label.delete"
                          target="_blank"
                          class="underline"
                          >label.delete()</a
                        >
                        удаляет указанный объект <em>label</em>;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_line.delete"
                          target="_blank"
                          class="underline"
                          >line.delete()</a
                        >
                        удаляет указанный объект <em>line</em>.
                      </li>
                    </ul>
                    <div class="note-box">
                      <div class="note-box-header">На заметку</div>
                      <p>
                        Чтобы удалить объект
                        <a
                          href="https://www.tradingview.com/pine-script-docs/concepts/fills/#line-fills"
                          target="_blank"
                          class="underline"
                          >linefill</a
                        >, достаточно удалить один из объектов <em>line</em>.
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>
          <section id="section-36">
            <h4>Задача #36. Хейкен Аши</h4>
            <p>Написать индикатор.</p>
            <h5>Ввод</h5>
            <p>Отсутствует.</p>
            <h5>Основные вычисления</h5>
            <p>Свечи Хейкен Аши на основе цен баров текущего графика.</p>
            <h5>Вывод</h5>
            <p>Свечи Хейкен Аши.</p>
            <a href="images/tasks/task-36-L.png" class="image">
              <img
                src="images/tasks/task-36-L.png"
                class="img-fluid img-thumbnail"
              />
            </a>
            <div class="accordion" id="task-36">
              <div class="accordion-item">
                <div class="accordion-header">
                  <button
                    class="accordion-button collapsed"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#collapse-36"
                  >
                    Решение
                  </button>
                </div>
                <div
                  id="collapse-36"
                  class="accordion-collapse collapse"
                  data-bs-parent="#task-36"
                >
                  <div class="accordion-body">
                    <div class="code-box mb-2-5">
                      <pre><code><span class="psc-3">//@version=6</span>
<span class="psc-5">indicator</span>(<span class="psc-2">"Task #36"</span>)

haTickerID <span class="psc-4">=</span> <span class="psc-5">ticker.heikinashi</span>(<span class="psc-6">syminfo.tickerid</span>)
[haOpen<span class="psc-4">,</span> haHigh<span class="psc-4">,</span> haLow<span class="psc-4">,</span> haClose] <span class="psc-4">=</span> <span class="psc-5">request.security</span>(
  symbol <span class="psc-4">=</span> haTickerID<span class="psc-4">,</span>
  timeframe <span class="psc-4">=</span> <span class="psc-6">timeframe.period</span><span class="psc-4">,</span> 
  expression <span class="psc-4">=</span> [<span class="psc-6">open</span><span class="psc-4">,</span> <span class="psc-6">high</span><span class="psc-4">,</span> <span class="psc-6">low</span><span class="psc-4">,</span> <span class="psc-6">close</span>]
  )
haColor <span class="psc-4">=</span> haClose <span class="psc-4">>=</span> haOpen <span class="psc-4">?</span> <span class="psc-6">color.teal</span> <span class="psc-4">:</span> <span class="psc-6">color.red</span>

<span class="psc-5">plotcandle</span>(
  open <span class="psc-4">=</span> haOpen<span class="psc-4">,</span>
  high <span class="psc-4">=</span> haHigh<span class="psc-4">,</span>
  low <span class="psc-4">=</span> haLow<span class="psc-4">,</span>
  close <span class="psc-4">=</span> haClose<span class="psc-4">,</span>
  color <span class="psc-4">=</span> haColor<span class="psc-4">,</span>
  wickcolor <span class="psc-4">=</span> haColor<span class="psc-4">,</span>
  bordercolor <span class="psc-4">=</span> haColor
  )</code></pre>
                    </div>
                    <p>Повторяем теорию:</p>
                    <ul>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_ticker.heikinashi"
                          target="_blank"
                          class="underline"
                          >ticker.heikinashi()</a
                        >
                        возвращает идентификатор тикера для запроса значений
                        свечей Хейкен Аши;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_plotcandle"
                          target="_blank"
                          class="underline"
                          >plotcandle()</a
                        >
                        отображает OHLC-свечи на графике.
                      </li>
                    </ul>
                    <div class="note-box">
                      <div class="note-box-header">На заметку</div>
                      <p>
                        <a
                          href="https://www.tradingview.com/pine-script-docs/concepts/non-standard-charts-data/"
                          target="_blank"
                          class="underline"
                          >Нестандартные графики</a
                        >
                        не отражают реальные цены. Это особенно важно помнить
                        при разработке стратегий, которые используют в расчётах
                        цены нестандартных графиков.
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>
          <section id="section-37">
            <h4>Задача #37. Конвертер валют</h4>
            <p>Написать индикатор.</p>
            <h5>Ввод</h5>
            <p>
              Вещественное число A. Значение заголовка: <em>"Converter"</em>.
            </p>
            <p>
              Строка с кодом валюты (стандарт ISO 4217) C1. Значение заголовка:
              <em>"Converter"</em>.
            </p>
            <p>
              Строка с кодом валюты (стандарт ISO 4217) C2. Значение заголовка:
              <em>"Converter"</em>.
            </p>
            <p>
              Логическое значение D1. Значение заголовка: <em>"Display"</em>.
            </p>
            <p>
              Логическое значение D2. Значение заголовка: <em>"Display"</em>.
            </p>
            <p>
              Логическое значение D3. Значение заголовка: <em>"Display"</em>.
            </p>
            <p>
              Логическое значение D4. Значение заголовка: <em>"Display"</em>.
            </p>
            <h5>Основные вычисления</h5>
            <p>Стоимость валюты C1 в количестве A в валюте C2.</p>
            <p>
              Способы отображения стоимости валюты для объекта <em>plot</em> в
              зависимости от логических значений D1, D2, D3 и D4. Если D1 равно
              <em>true</em>, то стоимость отображается в окне данных. Если D2
              равно <em>true</em>, то стоимость отображается на ценовой шкале.
              Если D3 равно <em>true</em>, то стоимость отображается в строке
              статуса скрипта. Если D4 равно <em>true</em>, то стоимость
              отображается на панели графика. Способы отображения стоимости
              валюты должны складываться.
            </p>
            <h5>Вывод</h5>
            <p>Стоимость валюты объектом <em>plot</em>.</p>
            <a href="images/tasks/task-37-L.png" class="image">
              <img
                src="images/tasks/task-37-L.png"
                class="img-fluid img-thumbnail"
              />
            </a>
            <div class="accordion" id="task-37">
              <div class="accordion-item">
                <div class="accordion-header">
                  <button
                    class="accordion-button collapsed"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#collapse-37"
                  >
                    Решение
                  </button>
                </div>
                <div
                  id="collapse-37"
                  class="accordion-collapse collapse"
                  data-bs-parent="#task-37"
                >
                  <div class="accordion-body">
                    <div class="code-box mb-2-5">
                      <pre><code><span class="psc-3">//@version=6</span>
<span class="psc-5">indicator</span>(<span class="psc-2">"Task #37"</span>)

a <span class="psc-4">=</span> <span class="psc-5">input.float</span>(<span class="psc-1">1000.0</span><span class="psc-4">,</span> <span class="psc-2">"A"</span><span class="psc-4">,</span> group <span class="psc-4">=</span> <span class="psc-2">"Converter"</span>)
c1 <span class="psc-4">=</span> <span class="psc-5">input.string</span>(<span class="psc-2">"USD"</span><span class="psc-4">,</span> <span class="psc-2">"C1"</span><span class="psc-4">,</span> group <span class="psc-4">=</span> <span class="psc-2">"Converter"</span>)
c2 <span class="psc-4">=</span> <span class="psc-5">input.string</span>(<span class="psc-2">"RUB"</span><span class="psc-4">,</span> <span class="psc-2">"C2"</span><span class="psc-4">,</span> group <span class="psc-4">=</span> <span class="psc-2">"Converter"</span>)
d1 <span class="psc-4">=</span> <span class="psc-5">input.bool</span>(<span class="psc-6">true</span><span class="psc-4">,</span> <span class="psc-2">"D1"</span><span class="psc-4">,</span> group <span class="psc-4">=</span> <span class="psc-2">"Display"</span>)
d2 <span class="psc-4">=</span> <span class="psc-5">input.bool</span>(<span class="psc-6">true</span><span class="psc-4">,</span> <span class="psc-2">"D2"</span><span class="psc-4">,</span> group <span class="psc-4">=</span> <span class="psc-2">"Display"</span>)
d3 <span class="psc-4">=</span> <span class="psc-5">input.bool</span>(<span class="psc-6">false</span><span class="psc-4">,</span> <span class="psc-2">"D3"</span><span class="psc-4">,</span> group <span class="psc-4">=</span> <span class="psc-2">"Display"</span>)
d4 <span class="psc-4">=</span> <span class="psc-5">input.bool</span>(<span class="psc-6">false</span><span class="psc-4">,</span> <span class="psc-2">"D4"</span><span class="psc-4">,</span> group <span class="psc-4">=</span> <span class="psc-2">"Display"</span>)

<span class="psc-7">convert</span>(amount<span class="psc-4">,</span> currency1<span class="psc-4">,</span> currency2) <span class="psc-4">=></span>
    amount <span class="psc-4">*</span> <span class="psc-5">request.currency_rate</span>(currency1<span class="psc-4">,</span> currency2)

plotDisplay <span class="psc-4">=</span>
  (d1 <span class="psc-4">?</span> <span class="psc-6">display.data_window</span> <span class="psc-4">:</span> <span class="psc-6">display.none</span>) <span class="psc-4">+</span>
  (d2 <span class="psc-4">?</span> <span class="psc-6">display.price_scale</span> <span class="psc-4">:</span> <span class="psc-6">display.none</span>) <span class="psc-4">+</span>
  (d3 <span class="psc-4">?</span> <span class="psc-6">display.status_line</span> <span class="psc-4">:</span> <span class="psc-6">display.none</span>) <span class="psc-4">+</span>
  (d4 <span class="psc-4">?</span> <span class="psc-6">display.pane</span> <span class="psc-4">:</span> <span class="psc-6">display.none</span>)

<span class="psc-5">plot</span>(<span class="psc-7">convert</span>(a<span class="psc-4">,</span> c1<span class="psc-4">,</span> c2)<span class="psc-4">,</span> display <span class="psc-4">=</span> plotDisplay)</code></pre>
                    </div>
                    <p>Повторяем теорию:</p>
                    <ul>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_input.bool"
                          target="_blank"
                          class="underline"
                          >input.bool()</a
                        >
                        добавляет в настройки скрипта чекбокс для ввода
                        логического значения;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_request.currency_rate"
                          target="_blank"
                          class="underline"
                          >request.currency_rate()</a
                        >
                        возвращает курс указанной валюты.
                      </li>
                    </ul>
                    <div class="note-box">
                      <div class="note-box-header">На заметку</div>
                      <p>
                        Функция
                        <a
                          href="https://www.tradingview.com/pine-script-docs/concepts/other-timeframes-and-data/#requestcurrency_rate"
                          target="_blank"
                          class="underline"
                          >request.currency_rate()</a
                        >
                        является более простой альтернативой функции
                        <em>request.security()</em>.
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>
          <section id="section-38">
            <h4>Задача #38. Бэк-тест</h4>
            <p>Написать стратегию.</p>
            <h5>Ввод</h5>
            <p>Целое число N. Минимальное значение: <em>1</em>.</p>
            <p>Вещественное число P1</p>
            <p>Вещественное число P2.</p>
            <p>Вещественное число S. Минимальное значение: <em>0</em>.</p>
            <h5>Основные вычисления</h5>
            <p>
              Быстрый стохастический осциллятор (%K), вычисляемый на основе N
              цен закрытия баров.
            </p>
            <p>
              Логический сигнал #1, принимающий значение <em>true</em>, если
              значение стохастического осциллятора меньше P1 и открытая
              рыночная позиция отсутствует или является короткой, иначе
              принимающий значение <em>false</em>.
            </p>
            <p>
              Логический сигнал #2, принимающий значение <em>true</em>, если
              значение стохастического осциллятора больше P2 и открытая
              рыночная позиция отсутствует или является длинной, иначе
              принимающий значение <em>false</em>.
            </p>
            <p>
              Размещение ордеров на открытие рыночных позиций размером в S
              единиц символа. Если логический сигнал #1 принимает значение
              <em>true</em>, то размещается рыночный ордер на открытие длинной
              позиции. Если логический сигнал #2 принимает значение
              <em>true</em>, то размещается рыночный ордер на открытие короткой
              позиции.
            </p>
            <h5>Вывод</h5>
            <p>
              Горизонтальная линия на уровне цены P1 объектом <em>hline</em> в
              виде сплошной линии.
            </p>
            <p>
              Горизонтальная линия на уровне цены P2 объектом <em>hline</em> в
              виде сплошной линии.
            </p>
            <p>Быстрый стохастический осциллятор объектом <em>plot</em>.</p>
            <a href="images/tasks/task-38-L.png" class="image">
              <img
                src="images/tasks/task-38-L.png"
                class="img-fluid img-thumbnail"
              />
            </a>
            <div class="accordion" id="task-38">
              <div class="accordion-item">
                <div class="accordion-header">
                  <button
                    class="accordion-button collapsed"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#collapse-38"
                  >
                    Решение
                  </button>
                </div>
                <div
                  id="collapse-38"
                  class="accordion-collapse collapse"
                  data-bs-parent="#task-38"
                >
                  <div class="accordion-body">
                    <div class="code-box mb-2-5">
                      <pre><code><span class="psc-3">//@version=6</span>
<span class="psc-5">strategy</span>(<span class="psc-2">"Task #38"</span><span class="psc-4">,</span> commission_value <span class="psc-4">=</span> <span class="psc-1">0.1</span>)

n <span class="psc-4">=</span> <span class="psc-5">input.int</span>(<span class="psc-1">14</span><span class="psc-4">,</span> <span class="psc-2">"N"</span><span class="psc-4">,</span> <span class="psc-1">1</span>)
p1 <span class="psc-4">=</span> <span class="psc-5">input.float</span>(<span class="psc-1">20.0</span><span class="psc-4">,</span> <span class="psc-2">"P1"</span>)
p2 <span class="psc-4">=</span> <span class="psc-5">input.float</span>(<span class="psc-1">80.0</span><span class="psc-4">,</span> <span class="psc-2">"P2"</span>)
s <span class="psc-4">=</span> <span class="psc-5">input.float</span>(<span class="psc-1">2.0</span><span class="psc-4">,</span> <span class="psc-2">"S"</span><span class="psc-4">,</span> <span class="psc-1">0</span>)

k <span class="psc-4">=</span> <span class="psc-5">ta.stoch</span>(<span class="psc-6">close</span><span class="psc-4">,</span> <span class="psc-6">high</span><span class="psc-4">,</span> <span class="psc-6">low</span><span class="psc-4">,</span> n)
longSignal <span class="psc-4">=</span> k <span class="psc-4"><</span> p1 <span class="psc-4">and</span> <span class="psc-6">strategy.position_size</span> <span class="psc-4"><=</span> <span class="psc-1">0</span>
shortSignal <span class="psc-4">=</span> k <span class="psc-4">></span> p2 <span class="psc-4">and</span> <span class="psc-6">strategy.position_size</span> <span class="psc-4">>=</span> <span class="psc-1">0</span>

<span class="psc-4">if</span> longSignal
    <span class="psc-5">strategy.entry</span>(<span class="psc-2">"Buy"</span><span class="psc-4">,</span> <span class="psc-6">strategy.long</span><span class="psc-4">,</span> s)

<span class="psc-4">if</span> shortSignal
    <span class="psc-5">strategy.entry</span>(<span class="psc-2">"Sell"</span><span class="psc-4">,</span> <span class="psc-6">strategy.short</span><span class="psc-4">,</span> s)

<span class="psc-5">hline</span>(p1<span class="psc-4">,</span> linestyle <span class="psc-4">=</span> <span class="psc-6">hline.style_solid</span>)
<span class="psc-5">hline</span>(p2<span class="psc-4">,</span> linestyle <span class="psc-4">=</span> <span class="psc-6">hline.style_solid</span>)
<span class="psc-5">plot</span>(k<span class="psc-4">,</span> linewidth <span class="psc-4">=</span> <span class="psc-1">2</span>)</code></pre>
                    </div>
                    <p>Повторяем теорию:</p>
                    <ul>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_ta.stoch"
                          target="_blank"
                          class="underline"
                          >ta.stoch()</a
                        >
                        возвращает быстрый стохастический осциллятор;
                      </li>
                      <li>
                        переменная
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#var_strategy.position_size"
                          target="_blank"
                          class="underline"
                          >strategy.position_size</a
                        >
                        содержит направление и размер открытых позиций;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_strategy.entry"
                          target="_blank"
                          class="underline"
                          >strategy.entry()</a
                        >
                        открывает позицию рыночным или отложенным ордером.
                      </li>
                    </ul>
                    <div class="note-box">
                      <div class="note-box-header">На заметку</div>
                      <p>
                        Бэк-тестестинг — это тестирование стратегии на
                        исторических данных для оценки её прибыльности и
                        возможных рисков. Качественная оптимизация стратегии на
                        исторических данных гарантирует эффективность (как
                        правило, ниже, чем при бэк-тестинге) стратегии в
                        реальной среде.
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>
          <section id="section-39">
            <h4>Задача #39. Форвард-тест</h4>
            <p>Написать стратегию.</p>
            <h5>Ввод</h5>
            <p>Целое число N. Минимальное значение: <em>1</em>.</p>
            <h5>Основные вычисления</h5>
            <p>
              Логический сигнал #1, принимающий значение <em>true</em>, если
              цена закрытия текущего бара больше цены максимума предыдущего
              бара, объём текущего бара больше объёма предыдущего бара, и
              отсутствует открытая рыночная позиция; в противном случае
              логический сигнал принимает значение <em>false</em>.
            </p>
            <p>
              Логический сигнал #2, принимающий значение <em>true</em>, если
              цена закрытия текущего бара меньше цены минимума предыдущего бара
              и открыта рыночная позиция, или если рыночная позиция открыта N
              баров; в противном случае логический сигнал принимает значение
              <em>false</em>.
            </p>
            <p>
              Размещение рыночных ордеров на открытие и закрытие длинной
              позиции. Если логический сигнал #1 принимает значение
              <em>true</em>, то размещается рыночный ордер на открытие позиции.
              Если логический сигнал #2 принимает значение <em>true</em>, то
              размещается рыночный ордер на закрытие позиции.
            </p>
            <p>
              Начальный расчёт скрипта должен быть ограничен последним баром.
            </p>
            <h5>Вывод</h5>
            <p>Объём баров объектом <em>plot</em> в виде столбцов.</p>
            <a href="images/tasks/task-39-L.png" class="image">
              <img
                src="images/tasks/task-39-L.png"
                class="img-fluid img-thumbnail"
              />
            </a>
            <div class="accordion" id="task-39">
              <div class="accordion-item">
                <div class="accordion-header">
                  <button
                    class="accordion-button collapsed"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#collapse-39"
                  >
                    Решение
                  </button>
                </div>
                <div
                  id="collapse-39"
                  class="accordion-collapse collapse"
                  data-bs-parent="#task-39"
                >
                  <div class="accordion-body">
                    <div class="code-box mb-2-5">
                      <pre><code><span class="psc-3">//@version=6</span>
<span class="psc-5">strategy</span>(
  title <span class="psc-4">=</span> <span class="psc-2">"Task #39"</span><span class="psc-4">,</span>
  default_qty_value <span class="psc-4">=</span> <span class="psc-1">2</span><span class="psc-4">,</span> 
  commission_value <span class="psc-4">=</span> <span class="psc-1">0.1</span><span class="psc-4">,</span> 
  calc_bars_count <span class="psc-4">=</span> <span class="psc-1">1</span>
  )

n <span class="psc-4">=</span> <span class="psc-5">input.int</span>(<span class="psc-1">3</span><span class="psc-4">,</span> <span class="psc-2">"N"</span><span class="psc-4">,</span> <span class="psc-1">1</span>)

entrySignal <span class="psc-4">=</span>
  <span class="psc-6">close</span> <span class="psc-4">></span> <span class="psc-6">high</span>[<span class="psc-1">1</span>] <span class="psc-4">and</span>
  <span class="psc-6">volume</span> <span class="psc-4">></span> <span class="psc-6">volume</span>[<span class="psc-1">1</span>] <span class="psc-4">and</span>
  <span class="psc-6">strategy.position_size</span> <span class="psc-4">==</span> <span class="psc-1">0</span>
exitSignal <span class="psc-4">=</span> 
  <span class="psc-6">close</span> <span class="psc-4"><</span> <span class="psc-6">low</span>[<span class="psc-1">1</span>] <span class="psc-4">and</span> <span class="psc-6">strategy.position_size</span> <span class="psc-4">!=</span> <span class="psc-1">0</span> <span class="psc-4">or</span>
  <span class="psc-6">bar_index</span> <span class="psc-4">-</span> <span class="psc-5">strategy.opentrades.entry_bar_index</span>(<span class="psc-1">0</span>) <span class="psc-4">+</span> <span class="psc-1">1</span> <span class="psc-4">==</span> n

<span class="psc-4">if</span> exitSignal
    <span class="psc-5">strategy.close</span>(<span class="psc-2">"Buy"</span><span class="psc-4">,</span> <span class="psc-2">"Sell"</span>)
<span class="psc-4">else</span> <span class="psc-4">if</span> entrySignal
    <span class="psc-5">strategy.entry</span>(<span class="psc-2">"Buy"</span><span class="psc-4">,</span> <span class="psc-6">strategy.long</span>)

<span class="psc-5">plot</span>(
  series <span class="psc-4">=</span> <span class="psc-6">volume</span><span class="psc-4">,</span>
  color <span class="psc-4">=</span> <span class="psc-6">close</span> <span class="psc-4">>=</span> <span class="psc-6">open</span> <span class="psc-4">?</span> <span class="psc-6">color.teal</span> <span class="psc-4">:</span> <span class="psc-6">color.red</span><span class="psc-4">,</span>
  style <span class="psc-4">=</span> <span class="psc-6">plot.style_columns</span>
  )</code></pre>
                    </div>
                    <p>Повторяем теорию:</p>
                    <ul>
                      <li>
                        переменная
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#var_volume"
                          target="_blank"
                          class="underline"
                          >volume</a
                        >
                        содержит объём текущего бара;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_strategy.opentrades.entry_bar_index"
                          target="_blank"
                          class="underline"
                          >strategy.opentrades.entry_bar_index()</a
                        >
                        возвращает индекс бара, на котором был произведён вход
                        в открытую позицию под указанным номером;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_strategy.close"
                          target="_blank"
                          class="underline"
                          >strategy.close()</a
                        >
                        частично или полностью закрывает позицию рыночным
                        ордером.
                      </li>
                    </ul>
                    <div class="note-box">
                      <div class="note-box-header">На заметку</div>
                      <p>
                        Форвард-тестестинг — это тестирование стратегии на
                        данных, поступающих в реальном времени, или на
                        исторических данных, которые не использовались при
                        оптимизации. Совмещая бэк-тестестинг и
                        форвард-тестестинг, можно получить более чёткое
                        представление об эффективности стратегии.
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>
          <section id="section-40">
            <h4>Задача #40. Отложенные ордера</h4>
            <p>Написать стратегию.</p>
            <h5>Ввод</h5>
            <p>Целое число L1. Минимальное значение: <em>1</em>.</p>
            <p>Целое число L2. Минимальное значение: <em>1</em>.</p>
            <p>Вещественное число P.</p>
            <p>Целое число N. Минимальное значение: <em>1</em>.</p>
            <p>Вещественное число S. Значение шага: <em>0.1</em>.</p>
            <p>Вещественное число T. Значение шага: <em>0.1</em>.</p>
            <h5>Основные вычисления</h5>
            <p>
              Индекс среднего направления движения (ADX — Average Directional
              Movement Index) с периодом сглаживания L2, вычисляемый на основе
              индикаторов +DI и -DI с периодами сглаживания L1.
            </p>
            <p>
              Логический сигнал #1, принимающий значение <em>true</em>, если
              текущее значение ADX больше предыдущего значения и больше P,
              минимум текущего бара меньше минимума предыдущего бара, и
              отсутствуют размещённые отложенные ордера; в противном случае
              логический сигнал принимает значение <em>false</em>.
            </p>
            <p>
              Логический сигнал #2, принимающий значение <em>true</em>, если
              размещённый лимитный ордер на открытие рыночной позиции не
              исполнен на протяжении N баров, иначе принимающий значение
              <em>false</em>.
            </p>
            <p>
              Размещение отложенных ордеров на открытие и закрытие короткой
              позиции при значении <em>true</em> логического сигнала #1.
              Лимитный ордер на открытие позиции размещается по цене максимума
              бара. Лимитный ордер на закрытие позиции размещается по цене
              максимума бара минус T %. Стоп-ордер на закрытие позиции
              размещается по цене максимума бара плюс S %.
            </p>
            <p>
              Отмена всех отложенных ордеров при значении
              <em>true</em> логического сигнала #2.
            </p>
            <h5>Вывод</h5>
            <p>
              Горизонтальная линия на уровне цены P объектом <em>plot</em>.
            </p>
            <p>
              Индекс среднего направления движения объектом <em>plot</em> в
              виде точек, соединённых линиями.
            </p>
            <p>
              Цена лимитного ордера на открытие рыночной позиции объектом
              <em>plot</em>.
            </p>
            <p>
              Цена лимитного ордера на закрытие рыночной позиции объектом
              <em>plot</em>.
            </p>
            <p>
              Цена стоп-ордера на закрытие рыночной позиции объектом
              <em>plot</em>.
            </p>
            <a href="images/tasks/task-40-L.png" class="image">
              <img
                src="images/tasks/task-40-L.png"
                class="img-fluid img-thumbnail"
              />
            </a>
            <div class="accordion" id="task-40">
              <div class="accordion-item">
                <div class="accordion-header">
                  <button
                    class="accordion-button collapsed"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#collapse-40"
                  >
                    Решение
                  </button>
                </div>
                <div
                  id="collapse-40"
                  class="accordion-collapse collapse"
                  data-bs-parent="#task-40"
                >
                  <div class="accordion-body">
                    <div class="code-box mb-2-5">
                      <pre><code><span class="psc-3">//@version=6</span>
<span class="psc-5">strategy</span>(
  title <span class="psc-4">=</span> <span class="psc-2">"Task #40"</span><span class="psc-4">,</span>
  default_qty_type <span class="psc-4">=</span> <span class="psc-6">strategy.percent_of_equity</span><span class="psc-4">,</span>
  default_qty_value <span class="psc-4">=</span> <span class="psc-1">10.0</span><span class="psc-4">,</span>
  commission_value <span class="psc-4">=</span> <span class="psc-1">0.1</span>
  )

l1 <span class="psc-4">=</span> <span class="psc-5">input.int</span>(<span class="psc-1">7</span><span class="psc-4">,</span> <span class="psc-2">"L1"</span><span class="psc-4">,</span> <span class="psc-1">1</span>)
l2 <span class="psc-4">=</span> <span class="psc-5">input.int</span>(<span class="psc-1">14</span><span class="psc-4">,</span> <span class="psc-2">"L2"</span><span class="psc-4">,</span> <span class="psc-1">1</span>)
p <span class="psc-4">=</span> <span class="psc-5">input.float</span>(<span class="psc-1">30.0</span><span class="psc-4">,</span> <span class="psc-2">"P"</span>)
n <span class="psc-4">=</span> <span class="psc-5">input.int</span>(<span class="psc-1">5</span><span class="psc-4">,</span> <span class="psc-2">"N"</span><span class="psc-4">,</span> <span class="psc-1">1</span>)
s <span class="psc-4">=</span> <span class="psc-5">input.float</span>(<span class="psc-1">1.0</span><span class="psc-4">,</span> <span class="psc-2">"S"</span><span class="psc-4">,</span> step <span class="psc-4">=</span> <span class="psc-1">0.1</span>)
t <span class="psc-4">=</span> <span class="psc-5">input.float</span>(<span class="psc-1">1.5</span><span class="psc-4">,</span> <span class="psc-2">"T"</span><span class="psc-4">,</span> step <span class="psc-4">=</span> <span class="psc-1">0.1</span>)

<span class="psc-4">var</span> openPrice <span class="psc-4">=</span> <span class="psc-5">float</span>(<span class="psc-6">na</span>)
<span class="psc-4">var</span> stopPrice <span class="psc-4">=</span> <span class="psc-5">float</span>(<span class="psc-6">na</span>)
<span class="psc-4">var</span> takePrice <span class="psc-4">=</span> <span class="psc-5">float</span>(<span class="psc-6">na</span>)

[_<span class="psc-4">,</span> _<span class="psc-4">,</span> adx] <span class="psc-4">=</span> <span class="psc-5">ta.dmi</span>(l1<span class="psc-4">,</span> l2)
signal1 <span class="psc-4">=</span> adx <span class="psc-4">></span> adx[<span class="psc-1">1</span>] <span class="psc-4">and</span> adx <span class="psc-4">></span> p <span class="psc-4">and</span> <span class="psc-6">low</span> <span class="psc-4"><</span> <span class="psc-6">low</span>[<span class="psc-1">1</span>] <span class="psc-4">and</span> <span class="psc-5">na</span>(stopPrice)
signal2 <span class="psc-4">=</span> <span class="psc-5">ta.barssince</span>(signal1) <span class="psc-4">==</span> n <span class="psc-4">and</span> <span class="psc-6">strategy.position_size</span> <span class="psc-4">==</span> <span class="psc-1">0</span>

<span class="psc-4">if</span> signal1
    openPrice <span class="psc-4">:=</span> <span class="psc-6">high</span>
    stopPrice <span class="psc-4">:=</span> <span class="psc-5">math.round_to_mintick</span>(<span class="psc-6">high</span> <span class="psc-4">*</span> (<span class="psc-1">100</span> <span class="psc-4">+</span> s) <span class="psc-4">/</span> <span class="psc-1">100</span>)
    takePrice <span class="psc-4">:=</span> <span class="psc-5">math.round_to_mintick</span>(<span class="psc-6">high</span> <span class="psc-4">*</span> (<span class="psc-1">100</span> <span class="psc-4">-</span> t) <span class="psc-4">/</span> <span class="psc-1">100</span>)

    <span class="psc-5">strategy.entry</span>(
      id <span class="psc-4">=</span> <span class="psc-2">"Sell"</span><span class="psc-4">,</span>
      direction <span class="psc-4">=</span> <span class="psc-6">strategy.short</span><span class="psc-4">,</span>
      limit <span class="psc-4">=</span> openPrice<span class="psc-4">,</span> 
      comment <span class="psc-4">=</span> <span class="psc-2">"Short"</span>
      )
    <span class="psc-5">strategy.exit</span>(
      id <span class="psc-4">=</span> <span class="psc-2">"Buy"</span><span class="psc-4">,</span>
      from_entry <span class="psc-4">=</span> <span class="psc-2">"Sell"</span><span class="psc-4">,</span>
      limit <span class="psc-4">=</span> takePrice<span class="psc-4">,</span>
      stop <span class="psc-4">=</span> stopPrice<span class="psc-4">,</span>
      comment_profit <span class="psc-4">=</span> <span class="psc-2">"Take-profit"</span><span class="psc-4">,</span>
      comment_loss <span class="psc-4">=</span> <span class="psc-2">"Stop-loss"</span>
      )

<span class="psc-4">if</span> signal2
    <span class="psc-5">strategy.cancel_all</span>()
    openPrice <span class="psc-4">:=</span> <span class="psc-6">na</span>
    stopPrice <span class="psc-4">:=</span> <span class="psc-6">na</span>
    takePrice <span class="psc-4">:=</span> <span class="psc-6">na</span>

<span class="psc-4">if</span> <span class="psc-6">strategy.position_size</span> <span class="psc-4">!=</span> <span class="psc-1">0</span>
    openPrice <span class="psc-4">:=</span> <span class="psc-6">na</span>

<span class="psc-4">if</span> <span class="psc-5">bool</span>(<span class="psc-5">ta.change</span>(<span class="psc-6">strategy.closedtrades</span>))
    openPrice <span class="psc-4">:=</span> <span class="psc-6">na</span>
    stopPrice <span class="psc-4">:=</span> <span class="psc-6">na</span>
    takePrice <span class="psc-4">:=</span> <span class="psc-6">na</span>

<span class="psc-5">plot</span>(p<span class="psc-4">,</span> color <span class="psc-4">=</span> <span class="psc-6">color.gray</span>)
<span class="psc-5">plot</span>(
  series <span class="psc-4">=</span> adx<span class="psc-4">,</span>
  linewidth <span class="psc-4">=</span> <span class="psc-1">2</span><span class="psc-4">,</span>
  style <span class="psc-4">=</span> <span class="psc-6">plot.style_circles</span><span class="psc-4">,</span>
  join <span class="psc-4">=</span> <span class="psc-6">true</span>
  )
<span class="psc-5">plot</span>(
  series <span class="psc-4">=</span> openPrice<span class="psc-4">,</span>
  color <span class="psc-4">=</span> <span class="psc-6">color.orange</span><span class="psc-4">,</span>
  style <span class="psc-4">=</span> <span class="psc-6">plot.style_linebr</span><span class="psc-4">,</span>
  force_overlay <span class="psc-4">=</span> <span class="psc-6">true</span>
  )
<span class="psc-5">plot</span>(
  series <span class="psc-4">=</span> stopPrice<span class="psc-4">,</span>
  color <span class="psc-4">=</span> <span class="psc-6">color.red</span><span class="psc-4">,</span>
  style <span class="psc-4">=</span> <span class="psc-6">plot.style_linebr</span><span class="psc-4">,</span>
  force_overlay <span class="psc-4">=</span> <span class="psc-6">true</span>
  )
<span class="psc-5">plot</span>(
  series <span class="psc-4">=</span> takePrice<span class="psc-4">,</span>
  color <span class="psc-4">=</span> <span class="psc-6">color.green</span><span class="psc-4">,</span>
  style <span class="psc-4">=</span> <span class="psc-6">plot.style_linebr</span><span class="psc-4">,</span>
  force_overlay <span class="psc-4">=</span> <span class="psc-6">true</span>
  )</code></pre>
                    </div>
                    <p>Повторяем теорию:</p>
                    <ul>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_ta.dmi"
                          target="_blank"
                          class="underline"
                          >ta.dmi()</a
                        >
                        возвращает кортеж из трёх серий DMI: индикаторов
                        положительного (+DI) и отрицательного (-DI) направлений
                        и индекса среднего направления движения (ADX);
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_math.round_to_mintick"
                          target="_blank"
                          class="underline"
                          >math.round_to_mintick()</a
                        >
                        возвращает значение, округлённое до тика символа;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_strategy.exit"
                          target="_blank"
                          class="underline"
                          >strategy.exit()</a
                        >
                        частично или полностью закрывает позицию отложенным
                        ордером;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_strategy.cancel_all"
                          target="_blank"
                          class="underline"
                          >strategy.cancel_all()</a
                        >
                        отменяет все отложенные ордера;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_ta.change"
                          target="_blank"
                          class="underline"
                          >ta.change()</a
                        >
                        возвращает разницу между текущим значением аргумента и
                        значением, которое аргумент имел указанное количество
                        баров назад;
                      </li>
                      <li>
                        переменная
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#var_strategy.closedtrades"
                          target="_blank"
                          class="underline"
                          >strategy.closedtrades</a
                        >
                        содержит число закрытых позиций.
                      </li>
                    </ul>
                    <div class="note-box">
                      <div class="note-box-header">На заметку</div>
                      <p>
                        Порядок исполнения отложенных ордеров на историческом
                        баре, цены которых находятся в пределах бара,
                        определяется логикой
                        <a
                          href="https://www.tradingview.com/pine-script-docs/concepts/strategies/#broker-emulator"
                          target="_blank"
                          class="underline"
                          >эмулятора брокера</a
                        >
                        TradingView.
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>
          <section id="section-41">
            <h4>Задача #41. Уровни Фибоначчи</h4>
            <p>Написать стратегию.</p>
            <h5>Ввод</h5>
            <p>Целое число N. Минимальное значение: <em>1</em>.</p>
            <p>Целое число L. Минимальное значение: <em>1</em>.</p>
            <p>
              Вещественное число S1. Значение подсказки:
              <em>"% of equity"</em>.
            </p>
            <p>
              Вещественное число S2. Значение подсказки:
              <em>"% of position"</em>.
            </p>
            <h5>Основные вычисления</h5>
            <p>
              Верхние точки разворота максимумов баров. Максимум бара считается
              верхней точкой разворота, если слева и справа от бара закрыто N
              баров с более низкими максимумами.
            </p>
            <p>
              Нижние точки разворота минимумов баров. Минимум бара считается
              нижней точкой разворота, если слева и справа от бара закрыто N
              баров с более высокими минимумами.
            </p>
            <p>Простая скользящая медиана цен закрытия баров длиной L.</p>
            <p>
              Уровни Фибоначчи: 0, 0.236, 0.382, 0.5, 0.618 и 1, где уровень 0
              совпадает с последней нижней точкой разворота, а уровень 1 — с
              последней верхней точкой разворота. Уровни Фибоначчи должны
              вычисляться при появлении нижней точки разворота (и наличии
              верхней точки), если отсутствует открытая рыночная позиция.
            </p>
            <p>
              Логический сигнал, принимающий значение <em>true</em>, если цена
              закрытия текущего бара меньше значения скользящей медианы, больше
              уровня Фибоначчи 0.236, и меньше уровня Фибоначчи 0.382, а также
              отсутствует открытая рыночная позиция; в противном случае
              логический сигнал принимает значение <em>false</em>.
            </p>
            <p>
              Размещение ордеров на открытие и закрытие длинной позиции при
              значении <em>true</em> логического сигнала. Позицию открывает
              рыночный ордер размером в S1 % от капитала. Стоп-ордер на
              закрытие позиции размещается по цене уровня Фибоначчи 0. Лимитный
              ордер на закрытие S2 % позиции размещается по цене уровня
              Фибоначчи 0.5. Лимитный ордер на закрытие оставшейся части
              позиции размещается по цене уровня Фибоначчи 0.618.
            </p>
            <h5>Вывод</h5>
            <p>Простая скользящая медиана объектом <em>plot</em>.</p>
            <p>
              Уровни Фибоначчи в пределах открытой рыночной позиции объектами
              <em>plot</em>.
            </p>
            <a href="images/tasks/task-41-L.png" class="image">
              <img
                src="images/tasks/task-41-L.png"
                class="img-fluid img-thumbnail"
              />
            </a>
            <div class="accordion" id="task-41">
              <div class="accordion-item">
                <div class="accordion-header">
                  <button
                    class="accordion-button collapsed"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#collapse-41"
                  >
                    Решение
                  </button>
                </div>
                <div
                  id="collapse-41"
                  class="accordion-collapse collapse"
                  data-bs-parent="#task-41"
                >
                  <div class="accordion-body">
                    <div class="code-box mb-2-5">
                      <pre><code><span class="psc-3">//@version=6</span>
<span class="psc-5">strategy</span>(
  title <span class="psc-4">=</span> <span class="psc-2">"Task #41"</span><span class="psc-4">,</span>
  overlay <span class="psc-4">=</span> <span class="psc-6">true</span><span class="psc-4">,</span>
  initial_capital <span class="psc-4">=</span> <span class="psc-1">10000.0</span><span class="psc-4">,</span>
  commission_value <span class="psc-4">=</span> <span class="psc-1">0.1</span>
  )

n <span class="psc-4">=</span> <span class="psc-5">input.int</span>(<span class="psc-1">5</span><span class="psc-4">,</span> <span class="psc-2">"N"</span><span class="psc-4">,</span> <span class="psc-1">1</span>)
l <span class="psc-4">=</span> <span class="psc-5">input.int</span>(<span class="psc-1">100</span><span class="psc-4">,</span> <span class="psc-2">"L"</span><span class="psc-4">,</span> <span class="psc-1">1</span>)
s1 <span class="psc-4">=</span> <span class="psc-5">input.float</span>(<span class="psc-1">50.0</span><span class="psc-4">,</span> <span class="psc-2">"S1"</span><span class="psc-4">,</span> tooltip <span class="psc-4">=</span> <span class="psc-2">"% of equity"</span>)
s2 <span class="psc-4">=</span> <span class="psc-5">input.float</span>(<span class="psc-1">60.0</span><span class="psc-4">,</span> <span class="psc-2">"S2"</span><span class="psc-4">,</span> tooltip <span class="psc-4">=</span> <span class="psc-2">"% of position"</span>)

<span class="psc-4">type</span> <span class="psc-4">FibonacciLevels</span>
    <span class="psc-4">float</span> level0 <span class="psc-4">=</span> <span class="psc-6">na</span>
    <span class="psc-4">float</span> level0236 <span class="psc-4">=</span> <span class="psc-6">na</span>
    <span class="psc-4">float</span> level0382 <span class="psc-4">=</span> <span class="psc-6">na</span>
    <span class="psc-4">float</span> level05 <span class="psc-4">=</span> <span class="psc-6">na</span>
    <span class="psc-4">float</span> level0618 <span class="psc-4">=</span> <span class="psc-6">na</span>
    <span class="psc-4">float</span> level1 <span class="psc-4">=</span> <span class="psc-6">na</span>

<span class="psc-4">method</span> <span class="psc-7">calculate</span>(<span class="psc-4">FibonacciLevels</span> this<span class="psc-4">,</span> level0<span class="psc-4">,</span> level1) <span class="psc-4">=></span>
    this.level0 <span class="psc-4">:=</span> level0
    this.level0236 <span class="psc-4">:=</span> level0 <span class="psc-4">+</span> (level1 <span class="psc-4">-</span> level0) <span class="psc-4">*</span> <span class="psc-1">0.236</span>
    this.level0382 <span class="psc-4">:=</span> level0 <span class="psc-4">+</span> (level1 <span class="psc-4">-</span> level0) <span class="psc-4">*</span> <span class="psc-1">0.382</span>
    this.level05 <span class="psc-4">:=</span> level0 <span class="psc-4">+</span> (level1 <span class="psc-4">-</span> level0) <span class="psc-4">*</span> <span class="psc-1">0.5</span>
    this.level0618 <span class="psc-4">:=</span> level0 <span class="psc-4">+</span> (level1 <span class="psc-4">-</span> level0) <span class="psc-4">*</span> <span class="psc-1">0.618</span>
    this.level1 <span class="psc-4">:=</span> level1

<span class="psc-4">var</span> stopPrice <span class="psc-4">=</span> <span class="psc-5">float</span>(<span class="psc-6">na</span>)
<span class="psc-4">var</span> takePrice1 <span class="psc-4">=</span> <span class="psc-5">float</span>(<span class="psc-6">na</span>)
<span class="psc-4">var</span> takePrice2 <span class="psc-4">=</span> <span class="psc-5">float</span>(<span class="psc-6">na</span>)
<span class="psc-4">var</span> lastPivotHigh <span class="psc-4">=</span> <span class="psc-5">float</span>(<span class="psc-6">na</span>)
<span class="psc-4">var</span> fibonacci <span class="psc-4">=</span> <span class="psc-7">FibonacciLevels.new</span>()

pivotHigh <span class="psc-4">=</span> <span class="psc-5">ta.pivothigh</span>(n<span class="psc-4">,</span> n)
pivotLow <span class="psc-4">=</span> <span class="psc-5">ta.pivotlow</span>(n<span class="psc-4">,</span> n)
median <span class="psc-4">=</span> <span class="psc-5">ta.median</span>(<span class="psc-6">close</span><span class="psc-4">,</span> l)

<span class="psc-4">if</span> <span class="psc-4">not</span> <span class="psc-5">na</span>(pivotHigh)
    lastPivotHigh <span class="psc-4">:=</span> pivotHigh

<span class="psc-4">if</span> <span class="psc-4">not</span> <span class="psc-5">na</span>(pivotLow) <span class="psc-4">and</span> <span class="psc-4">not</span> <span class="psc-5">na</span>(lastPivotHigh) <span class="psc-4">and</span>
      <span class="psc-6">strategy.position_size</span> <span class="psc-4">==</span> <span class="psc-1">0</span>
    fibonacci.<span class="psc-7">calculate</span>(pivotLow<span class="psc-4">,</span> lastPivotHigh)

signal <span class="psc-4">=</span>
  <span class="psc-6">close</span> <span class="psc-4"><</span> median <span class="psc-4">and</span>
  <span class="psc-6">close</span> <span class="psc-4">></span> fibonacci.level0236 <span class="psc-4">and</span>
  <span class="psc-6">close</span> <span class="psc-4"><</span> fibonacci.level0382 <span class="psc-4">and</span>
  <span class="psc-6">strategy.position_size</span> <span class="psc-4">==</span> <span class="psc-1">0</span>

<span class="psc-4">if</span> signal
    positionSize <span class="psc-4">=</span> <span class="psc-6">strategy.equity</span> <span class="psc-4">*</span> (s1 <span class="psc-4">/</span> <span class="psc-1">100.0</span>) <span class="psc-4">/</span> <span class="psc-6">close</span>
    stopPrice <span class="psc-4">:=</span> <span class="psc-5">math.round_to_mintick</span>(fibonacci.level0)
    takePrice1 <span class="psc-4">:=</span> <span class="psc-5">math.round_to_mintick</span>(fibonacci.level05)
    takePrice2 <span class="psc-4">:=</span> <span class="psc-5">math.round_to_mintick</span>(fibonacci.level0618)

    <span class="psc-5">strategy.entry</span>(
      id <span class="psc-4">=</span> <span class="psc-2">"Buy"</span><span class="psc-4">,</span>
      direction <span class="psc-4">=</span> <span class="psc-6">strategy.long</span><span class="psc-4">,</span>
      qty <span class="psc-4">=</span> positionSize<span class="psc-4">,</span> 
      comment <span class="psc-4">=</span> <span class="psc-2">"Long"</span>
      )
    <span class="psc-5">strategy.order</span>(
      id <span class="psc-4">=</span> <span class="psc-2">"Sell #1"</span><span class="psc-4">,</span>
      direction <span class="psc-4">=</span> <span class="psc-6">strategy.short</span><span class="psc-4">,</span>
      qty <span class="psc-4">=</span> positionSize <span class="psc-4">*</span> s2 <span class="psc-4">/</span> <span class="psc-1">100</span><span class="psc-4">,</span>
      limit <span class="psc-4">=</span> takePrice1<span class="psc-4">,</span>
      oca_name <span class="psc-4">=</span> <span class="psc-2">"Bracket"</span><span class="psc-4">,</span>
      oca_type <span class="psc-4">=</span> <span class="psc-6">strategy.oca.reduce</span><span class="psc-4">,</span>
      comment <span class="psc-4">=</span> <span class="psc-2">"Take-profit #1"</span>
      )
    <span class="psc-5">strategy.exit</span>(
      id <span class="psc-4">=</span> <span class="psc-2">"Sell #2"</span><span class="psc-4">,</span>
      from_entry <span class="psc-4">=</span> <span class="psc-2">"Buy"</span><span class="psc-4">,</span>
      limit <span class="psc-4">=</span> takePrice2<span class="psc-4">,</span>
      stop <span class="psc-4">=</span> stopPrice<span class="psc-4">,</span>
      oca_name <span class="psc-4">=</span> <span class="psc-2">"Bracket"</span><span class="psc-4">,</span>
      comment_profit <span class="psc-4">=</span> <span class="psc-2">"Take-profit #2"</span><span class="psc-4">,</span>
      comment_loss <span class="psc-4">=</span> <span class="psc-2">"Stop-loss"</span>
      )

<span class="psc-5">plot</span>(median<span class="psc-4">,</span> linewidth <span class="psc-4">=</span> <span class="psc-1">2</span>)
<span class="psc-5">plot</span>(
  series <span class="psc-4">=</span> <span class="psc-6">strategy.position_size</span> <span class="psc-4">></span> <span class="psc-1">0</span> <span class="psc-4">?</span> fibonacci.level0 <span class="psc-4">:</span> <span class="psc-6">na</span><span class="psc-4">,</span>
  color <span class="psc-4">=</span> <span class="psc-6">color.silver</span><span class="psc-4">,</span>
  style <span class="psc-4">=</span> <span class="psc-6">plot.style_linebr</span>
  )
<span class="psc-5">plot</span>(
  series <span class="psc-4">=</span> <span class="psc-6">strategy.position_size</span> <span class="psc-4">></span> <span class="psc-1">0</span> <span class="psc-4">?</span> fibonacci.level0236 <span class="psc-4">:</span> <span class="psc-6">na</span><span class="psc-4">,</span>
  color <span class="psc-4">=</span> <span class="psc-6">color.red</span><span class="psc-4">,</span>
  style <span class="psc-4">=</span> <span class="psc-6">plot.style_linebr</span>
  )
<span class="psc-5">plot</span>(
  series <span class="psc-4">=</span> <span class="psc-6">strategy.position_size</span> <span class="psc-4">></span> <span class="psc-1">0</span> <span class="psc-4">?</span> fibonacci.level0382 <span class="psc-4">:</span> <span class="psc-6">na</span><span class="psc-4">,</span>
  color <span class="psc-4">=</span> <span class="psc-6">color.orange</span><span class="psc-4">,</span>
  style <span class="psc-4">=</span> <span class="psc-6">plot.style_linebr</span>
  )
<span class="psc-5">plot</span>(
  series <span class="psc-4">=</span> <span class="psc-6">strategy.position_size</span> <span class="psc-4">></span> <span class="psc-1">0</span> <span class="psc-4">?</span> fibonacci.level05 <span class="psc-4">:</span> <span class="psc-6">na</span><span class="psc-4">,</span>
  color <span class="psc-4">=</span> <span class="psc-6">color.green</span><span class="psc-4">,</span>
  style <span class="psc-4">=</span> <span class="psc-6">plot.style_linebr</span>
  )
<span class="psc-5">plot</span>(
  series <span class="psc-4">=</span> <span class="psc-6">strategy.position_size</span> <span class="psc-4">></span> <span class="psc-1">0</span> <span class="psc-4">?</span> fibonacci.level0618 <span class="psc-4">:</span> <span class="psc-6">na</span><span class="psc-4">,</span>
  color <span class="psc-4">=</span> <span class="psc-6">color.lime</span><span class="psc-4">,</span>
  style <span class="psc-4">=</span> <span class="psc-6">plot.style_linebr</span>
  )
<span class="psc-5">plot</span>(
  series <span class="psc-4">=</span> <span class="psc-6">strategy.position_size</span> <span class="psc-4">></span> <span class="psc-1">0</span> <span class="psc-4">?</span> fibonacci.level1 <span class="psc-4">:</span> <span class="psc-6">na</span><span class="psc-4">,</span>
  color <span class="psc-4">=</span> <span class="psc-6">color.silver</span><span class="psc-4">,</span>
  style <span class="psc-4">=</span> <span class="psc-6">plot.style_linebr</span>
  )</code></pre>
                    </div>
                    <p>Повторяем теорию:</p>
                    <ul>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_ta.median"
                          target="_blank"
                          class="underline"
                          >ta.median()</a
                        >
                        возвращает простую скользящую медиану;
                      </li>
                      <li>
                        переменная
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#var_strategy.equity"
                          target="_blank"
                          class="underline"
                          >strategy.equity</a
                        >
                        содержит текущий размер торгового капитала;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_strategy.order"
                          target="_blank"
                          class="underline"
                          >strategy.order()</a
                        >
                        размещает рыночный или отложенный ордер.
                      </li>
                    </ul>
                    <div class="note-box">
                      <div class="note-box-header">На заметку</div>
                      <p>
                        Pine Script позволяет связывать ордера в
                        <a
                          href="https://www.tradingview.com/pine-script-docs/concepts/strategies/#oca-groups"
                          target="_blank"
                          class="underline"
                          >группы OCA</a
                        >. Благодаря этому одни ордера могут быть полностью или
                        частично отменены при исполнении других ордеров.
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>
          <section id="section-42">
            <h4>Задача #42. Внутридневной убыток</h4>
            <p>Написать стратегию.</p>
            <h5>Ввод</h5>
            <p>Целое число N. Минимальное значение: <em>1</em>.</p>
            <p>Вещественное число L. Минимальное значение: <em>0</em>.</p>
            <p>Вещественное число S.</p>
            <p>Вещественное число P1.</p>
            <p>Вещественное число P2.</p>
            <h5>Основные вычисления</h5>
            <p>
              Логический сигнал #1, принимающий значение <em>true</em>, если
              цены закрытия баров уменьшаются N баров подряд, убыток,
              полученный в течение дня, меньше допустимого внутридневного
              убытка L, и отсутствует открытая рыночная позиция; в противном
              случае логический сигнал принимает значение <em>false</em>.
            </p>
            <p>
              Логический сигнал #2, принимающий значение <em>true</em>, если на
              текущем баре убыток, полученный в течение дня, равен или
              превышает допустимый внутридневной убыток L, иначе принимающий
              значение <em>false</em>.
            </p>
            <p>
              Размещение отложенных ордеров на открытие и закрытие короткой
              позиции при значении <em>true</em> логического сигнала #1.
              Стоп-ордер на открытие короткой позиции размером в S единиц
              капитала размещается по цене минимума бара. Трейлинг-стоп-ордер
              на закрытие позиции размещается при достижении цены активации,
              равной цене открытия позиции минус P1 пунктов, по цене, равной
              цене активании плюс P2 пунктов.
            </p>
            <p>
              Размещение рыночного ордера на закрытие позиции при значении
              <em>true</em> логического сигнала #2.
            </p>
            <h5>Вывод</h5>
            <p>
              Допустимый внутридневной убыток L объектом
              <em>hline</em> в виде сплошной линии.
            </p>
            <p>
              Внутридневной убыток объектом <em>plot</em> в виде гистограммы.
            </p>
            <a href="images/tasks/task-42-L.png" class="image">
              <img
                src="images/tasks/task-42-L.png"
                class="img-fluid img-thumbnail"
              />
            </a>
            <div class="accordion" id="task-42">
              <div class="accordion-item">
                <div class="accordion-header">
                  <button
                    class="accordion-button collapsed"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#collapse-42"
                  >
                    Решение
                  </button>
                </div>
                <div
                  id="collapse-42"
                  class="accordion-collapse collapse"
                  data-bs-parent="#task-42"
                >
                  <div class="accordion-body">
                    <div class="code-box mb-2-5">
                      <pre><code><span class="psc-3">//@version=6</span>
<span class="psc-5">strategy</span>(
  title <span class="psc-4">=</span> <span class="psc-2">"Task #42"</span><span class="psc-4">,</span>
  initial_capital <span class="psc-4">=</span> <span class="psc-1">10000.0</span><span class="psc-4">,</span>
  commission_value <span class="psc-4">=</span> <span class="psc-1">0.1</span>
  )

n <span class="psc-4">=</span> <span class="psc-5">input.int</span>(<span class="psc-1">3</span><span class="psc-4">,</span> <span class="psc-2">"N"</span><span class="psc-4">,</span> <span class="psc-1">1</span>)
l <span class="psc-4">=</span> <span class="psc-5">input.float</span>(<span class="psc-1">50.0</span><span class="psc-4">,</span> <span class="psc-2">"L"</span><span class="psc-4">,</span> <span class="psc-1">0</span>)
s <span class="psc-4">=</span> <span class="psc-5">input.float</span>(<span class="psc-1">5000.0</span><span class="psc-4">,</span> <span class="psc-2">"S"</span>)
p1 <span class="psc-4">=</span> <span class="psc-5">input.float</span>(<span class="psc-1">0</span><span class="psc-4">,</span> <span class="psc-2">"P1"</span>)
p2 <span class="psc-4">=</span> <span class="psc-5">input.float</span>(<span class="psc-1">1500.0</span><span class="psc-4">,</span> <span class="psc-2">"P2"</span>)

<span class="psc-4">var</span> realizedProfit <span class="psc-4">=</span> <span class="psc-1">0.0</span>

<span class="psc-4">if</span> <span class="psc-5">bool</span>(<span class="psc-5">ta.change</span>(<span class="psc-6">dayofmonth</span>))
    realizedProfit <span class="psc-4">:=</span> <span class="psc-1">0.0</span>

<span class="psc-4">if</span> <span class="psc-5">bool</span>(<span class="psc-5">ta.change</span>(<span class="psc-6">strategy.netprofit</span>))
    realizedProfit <span class="psc-4">+=</span> (<span class="psc-6">strategy.netprofit</span> <span class="psc-4">-</span> <span class="psc-6">strategy.netprofit</span>[<span class="psc-1">1</span>])

currentProfit <span class="psc-4">=</span> realizedProfit <span class="psc-4">+</span> <span class="psc-6">strategy.openprofit</span>
signal1 <span class="psc-4">=</span>
  <span class="psc-5">ta.falling</span>(<span class="psc-6">close</span><span class="psc-4">,</span> n) <span class="psc-4">and</span>
  <span class="psc-4">-</span>currentProfit <span class="psc-4"><</span> l <span class="psc-4">and</span>
  <span class="psc-6">strategy.position_size</span> <span class="psc-4">==</span> <span class="psc-1">0</span>
signal2 <span class="psc-4">=</span> <span class="psc-4">-</span>currentProfit <span class="psc-4">>=</span> l

<span class="psc-4">if</span> signal1
    <span class="psc-5">strategy.entry</span>(
      id <span class="psc-4">=</span> <span class="psc-2">"Sell"</span><span class="psc-4">,</span>
      direction <span class="psc-4">=</span> <span class="psc-6">strategy.short</span><span class="psc-4">,</span>
      qty <span class="psc-4">=</span> s <span class="psc-4">/</span> <span class="psc-6">low</span><span class="psc-4">,</span>
      stop <span class="psc-4">=</span> <span class="psc-6">low</span><span class="psc-4">,</span>
      comment <span class="psc-4">=</span> <span class="psc-2">"Short"</span>
      )
    <span class="psc-5">strategy.exit</span>(
      id <span class="psc-4">=</span> <span class="psc-2">"Buy"</span><span class="psc-4">,</span>
      from_entry <span class="psc-4">=</span> <span class="psc-2">"Sell"</span><span class="psc-4">,</span>
      trail_points <span class="psc-4">=</span> <span class="psc-6">syminfo.pointvalue</span> <span class="psc-4">/</span> <span class="psc-6">syminfo.mintick</span> <span class="psc-4">*</span> p1<span class="psc-4">,</span>
      trail_offset <span class="psc-4">=</span> <span class="psc-6">syminfo.pointvalue</span> <span class="psc-4">/</span> <span class="psc-6">syminfo.mintick</span> <span class="psc-4">*</span> p2<span class="psc-4">,</span>
      comment <span class="psc-4">=</span> <span class="psc-2">"Trailing Stop"</span>
      )

<span class="psc-4">if</span> signal2
    <span class="psc-5">strategy.close</span>(<span class="psc-2">"Sell"</span><span class="psc-4">,</span> <span class="psc-2">"Exit (max intraday loss)"</span>)

<span class="psc-5">hline</span>(l<span class="psc-4">,</span> color <span class="psc-4">=</span> <span class="psc-6">color.red</span><span class="psc-4">,</span> linestyle <span class="psc-4">=</span> <span class="psc-6">hline.style_solid</span>)
<span class="psc-5">plot</span>(
  series <span class="psc-4">=</span> <span class="psc-4">-</span>currentProfit <span class="psc-4">>=</span> <span class="psc-1">0</span> <span class="psc-4">?</span> <span class="psc-4">-</span>currentProfit <span class="psc-4">:</span> <span class="psc-6">na</span><span class="psc-4">,</span>
  color <span class="psc-4">=</span> <span class="psc-6">color.silver</span><span class="psc-4">,</span>
  linewidth <span class="psc-4">=</span> <span class="psc-1">2</span><span class="psc-4">,</span>
  style <span class="psc-4">=</span> <span class="psc-6">plot.style_histogram</span>
  )</code></pre>
                    </div>
                    <p>Повторяем теорию:</p>
                    <ul>
                      <li>
                        переменная
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#var_dayofmonth"
                          target="_blank"
                          class="underline"
                          >dayofmonth</a
                        >
                        содержит день месяца для текущего бара;
                      </li>
                      <li>
                        переменная
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#var_strategy.netprofit"
                          target="_blank"
                          class="underline"
                          >strategy.netprofit</a
                        >
                        содержит текущую реализованную прибыль или убыток;
                      </li>
                      <li>
                        переменная
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#var_strategy.openprofit"
                          target="_blank"
                          class="underline"
                          >strategy.openprofit</a
                        >
                        содержит текущую нереализованную прибыль или убыток;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_ta.falling"
                          target="_blank"
                          class="underline"
                          >ta.falling()</a
                        >
                        возвращает значение <em>true</em>, если серия значений
                        аргумента уменьшается заданное число баров подряд,
                        иначе возвращает значение <em>false</em>;
                      </li>
                      <li>
                        переменная
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#var_syminfo.pointvalue"
                          target="_blank"
                          class="underline"
                          >syminfo.pointvalue</a
                        >
                        содержит значение пункта для текущего символа;
                      </li>
                      <li>
                        переменная
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#var_syminfo.mintick"
                          target="_blank"
                          class="underline"
                          >syminfo.mintick</a
                        >
                        содержит значение тика для текущего символа.
                      </li>
                    </ul>
                    <div class="note-box">
                      <div class="note-box-header">На заметку</div>
                      <p>
                        Pine Script имеет несколько специальных встроенных
                        функций для
                        <a
                          href="https://www.tradingview.com/pine-script-docs/concepts/strategies/#risk-management"
                          target="_blank"
                          class="underline"
                          >управления рисками</a
                        >.
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>
          <section id="section-43">
            <h4>Задача #43. Белый список</h4>
            <p>Написать стратегию.</p>
            <h5>Ввод</h5>
            <p>Многострочная строка с тикерами S.</p>
            <p>Вещественное число P1.</p>
            <p>Вещественное число P2.</p>
            <h5>Основные вычисления</h5>
            <p>
              Логический сигнал, принимающий значение <em>true</em>, если цена
              закрытия текущего бара больше цены его открытия, отсутствует
              открытая рыночная позиция, и многострочная строка S содержит
              тикер текущего символа; в противном случае логический сигнал
              принимает значение <em>false</em>.
            </p>
            <p>
              Размещение ордеров на открытие и закрытие длинной позиции при
              значении <em>true</em> логического сигнала. Позицию открывает
              рыночный ордер, который должен быть исполнен по цене закрытия
              бара. Лимитный ордер на закрытие позиции размещается по цене
              открытия позиции плюс P1 пунктов. Стоп-ордер на закрытие позиции
              размещается по цене открытия позиции минус P2 пунктов.
            </p>
            <p>
              Начальный расчёт скрипта должен быть ограничен последним баром.
            </p>
            <h5>Вывод</h5>
            <p>
              Оповещение при исполнении ордеров, содержащее тикер текущего
              символа, направление сделки (покупка или продажа), размер ордера
              и цену исполнения ордера.
            </p>
            <a href="images/tasks/task-43-2-L.png" class="image">
              <img
                src="images/tasks/task-43-2-L.png"
                class="img-fluid img-thumbnail"
              />
            </a>
            <div class="accordion" id="task-43">
              <div class="accordion-item">
                <div class="accordion-header">
                  <button
                    class="accordion-button collapsed"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#collapse-43"
                  >
                    Решение
                  </button>
                </div>
                <div
                  id="collapse-43"
                  class="accordion-collapse collapse"
                  data-bs-parent="#task-43"
                >
                  <div class="accordion-body">
                    <a href="images/tasks/task-43-1-L.png" class="image">
                      <img
                        src="images/tasks/task-43-1-L.png"
                        class="img-fluid img-thumbnail mt-0"
                      />
                    </a>
                    <div class="code-box mb-2-5">
                      <pre><code><span class="psc-3">//@version=6</span>
<span class="psc-3">//@strategy_alert_message {{strategy.order.alert_message}}</span>
<span class="psc-5">strategy</span>(
  title <span class="psc-4">=</span> <span class="psc-2">"Task #43"</span><span class="psc-4">,</span>
  overlay <span class="psc-4">=</span> <span class="psc-6">true</span><span class="psc-4">,</span>
  default_qty_type <span class="psc-4">=</span> <span class="psc-6">strategy.cash</span><span class="psc-4">,</span>
  default_qty_value <span class="psc-4">=</span> <span class="psc-1">100.0</span><span class="psc-4">,</span>
  initial_capital <span class="psc-4">=</span> <span class="psc-1">10000.0</span><span class="psc-4">,</span>
  commission_value <span class="psc-4">=</span> <span class="psc-1">0.1</span><span class="psc-4">,</span>
  process_orders_on_close <span class="psc-4">=</span> <span class="psc-6">true</span><span class="psc-4">,</span>
  calc_bars_count <span class="psc-4">=</span> <span class="psc-1">1</span>
  )

s <span class="psc-4">=</span> <span class="psc-5">input.text_area</span>(
  defval <span class="psc-4">=</span> <span class="psc-2">"BTCUSDT BTCUSDT.P\nETHUSDT ETHUSDT.P\nSOLUSDT SOLUSDT.P"</span><span class="psc-4">,</span>
  title <span class="psc-4">=</span> <span class="psc-2">"S"</span>
  )
p1 <span class="psc-4">=</span> <span class="psc-5">input.float</span>(<span class="psc-1">20.0</span><span class="psc-4">,</span> <span class="psc-2">"P1"</span>)
p2 <span class="psc-4">=</span> <span class="psc-5">input.float</span>(<span class="psc-1">10.0</span><span class="psc-4">,</span> <span class="psc-2">"P2"</span>)

signal <span class="psc-4">=</span>
  <span class="psc-6">close</span> <span class="psc-4">></span> <span class="psc-6">open</span> <span class="psc-4">and</span>
  <span class="psc-6">strategy.position_size</span> <span class="psc-4">==</span> <span class="psc-1">0</span> <span class="psc-4">and</span>
  <span class="psc-5">str.contains</span>(s<span class="psc-4">,</span> <span class="psc-6">syminfo.ticker</span>)

<span class="psc-4">if</span> signal
    alertMessage <span class="psc-4">=</span> <span class="psc-5">str.format</span>(
      <span class="psc-2">"ticker: {0}, side: {1}, qty: {2}, price: {3}"</span><span class="psc-4">,</span>
      <span class="psc-2">"{{ticker}}"</span><span class="psc-4">,</span>
      <span class="psc-2">"{{strategy.order.action}}"</span><span class="psc-4">,</span>
      <span class="psc-2">"{{strategy.order.contracts}}"</span><span class="psc-4">,</span>
      <span class="psc-2">"{{strategy.order.price}}"</span>
      )
    <span class="psc-5">strategy.entry</span>(
      id <span class="psc-4">=</span> <span class="psc-2">"Buy"</span><span class="psc-4">,</span>
      direction <span class="psc-4">=</span> <span class="psc-6">strategy.long</span><span class="psc-4">,</span>
      comment <span class="psc-4">=</span> <span class="psc-2">"Long"</span><span class="psc-4">,</span>
      alert_message <span class="psc-4">=</span> alertMessage
      )
    <span class="psc-5">strategy.exit</span>(
      id <span class="psc-4">=</span> <span class="psc-2">"Sell"</span><span class="psc-4">,</span>
      from_entry <span class="psc-4">=</span> <span class="psc-2">"Buy"</span><span class="psc-4">,</span>
      profit <span class="psc-4">=</span> <span class="psc-6">syminfo.pointvalue</span> <span class="psc-4">/</span> <span class="psc-6">syminfo.mintick</span> <span class="psc-4">*</span> p1<span class="psc-4">,</span>
      loss <span class="psc-4">=</span> <span class="psc-6">syminfo.pointvalue</span> <span class="psc-4">/</span> <span class="psc-6">syminfo.mintick</span> <span class="psc-4">*</span> p2<span class="psc-4">,</span>
      comment_profit <span class="psc-4">=</span> <span class="psc-2">"Take-profit"</span><span class="psc-4">,</span>
      comment_loss <span class="psc-4">=</span> <span class="psc-2">"Stop-loss"</span><span class="psc-4">,</span>
      alert_message <span class="psc-4">=</span> alertMessage
      )</code></pre>
                    </div>
                    <p>Повторяем теорию:</p>
                    <ul>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_input.text_area"
                          target="_blank"
                          class="underline"
                          >input.text_area()</a
                        >
                        добавляет в настройки скрипта поле для ввода
                        многострочного текста;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_str.contains"
                          target="_blank"
                          class="underline"
                          >str.contains()</a
                        >
                        возвращает значение <em>true</em>, если исходная строка
                        содержит указанную подстроку, иначе возвращает значение
                        <em>false</em>;
                      </li>
                      <li>
                        переменная
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#var_syminfo.ticker"
                          target="_blank"
                          class="underline"
                          >syminfo.ticker</a
                        >
                        содержит тикер текущего символа.
                      </li>
                    </ul>
                    <div class="note-box">
                      <div class="note-box-header">На заметку</div>
                      <p>
                        Функции, размещающие торговые ордера, могут создавать
                        оповещение в момент исполнения ордера. Для создания
                        таких оповещений используются специальные
                        <a
                          href="https://ru.tradingview.com/support/solutions/43000481368/"
                          target="_blank"
                          class="underline"
                          >плейсхолдеры</a
                        >.
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>
          <section id="section-44">
            <h4>Задача #44. Торговая статистика</h4>
            <p>Написать стратегию.</p>
            <h5>Ввод</h5>
            <p>Целое число N1. Минимальное значение: <em>1</em>.</p>
            <p>Целое число N2. Минимальное значение: <em>1</em>.</p>
            <p>Вещественное число S.</p>
            <p>Вещественное число P1</p>
            <p>Вещественное число P2.</p>
            <h5>Основные вычисления</h5>
            <p>
              Логический сигнал #1, принимающий значение <em>true</em>, если
              текущий бар является закрытым и отсутствуют размещённые лимитные
              ордера, иначе принимающий значение <em>false</em>.
            </p>
            <p>
              Логический сигнал #2, принимающий значение <em>true</em>, если
              максимум текущего бара больше или равен цене последнего
              закрывающего позицию лимитного ордера, иначе принимающий значение
              <em>false</em>.
            </p>
            <p>
              Размещение ордеров на открытие и закрытие длинных позиций при
              значении <em>true</em> логического сигнала #1. Позиции размером в
              S единиц капитала открывают N1 лимитных ордеров. Первый ордер
              размещается по цене закрытия бара минус P1 пунктов. Остальные
              ордера размещаются по цене последнего ордера минус P1 пунктов.
              Каждая позиция закрывается лимитным ордером. Первый ордер
              размещается по цене закрытия бара плюс P2 пунктов. Остальные
              ордера размещаются по цене последнего ордера плюс P2 пунктов.
            </p>
            <p>
              Отмена всех лимитных ордеров при значении
              <em>true</em> логического сигнала #2.
            </p>
            <p>
              Таблица со статистикой последних N2 сделок. Таблица должна
              состоять из первой, третьей, четвертой, пятой, шестой и седьмой
              колонок списка сделок из тестера стратегий TradingView.
            </p>
            <h5>Вывод</h5>
            <p>Таблица со статистикой сделок объектом <em>table</em>.</p>
            <a href="images/tasks/task-44-L.png" class="image">
              <img
                src="images/tasks/task-44-L.png"
                class="img-fluid img-thumbnail"
              />
            </a>
            <div class="accordion" id="task-44">
              <div class="accordion-item">
                <div class="accordion-header">
                  <button
                    class="accordion-button collapsed"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#collapse-44"
                  >
                    Решение
                  </button>
                </div>
                <div
                  id="collapse-44"
                  class="accordion-collapse collapse"
                  data-bs-parent="#task-44"
                >
                  <div class="accordion-body">
                    <div class="code-box mb-2-5">
                      <pre><code><span class="psc-3">//@version=6</span>
<span class="psc-5">strategy</span>(
  title <span class="psc-4">=</span> <span class="psc-2">"Task #44"</span><span class="psc-4">,</span>
  overlay <span class="psc-4">=</span> <span class="psc-6">true</span><span class="psc-4">,</span>
  calc_on_every_tick <span class="psc-4">=</span> <span class="psc-6">true</span><span class="psc-4">,</span>
  initial_capital <span class="psc-4">=</span> <span class="psc-1">10000.0</span><span class="psc-4">,</span>
  commission_value <span class="psc-4">=</span> <span class="psc-1">0.1</span>
  )

n1 <span class="psc-4">=</span> <span class="psc-5">input.int</span>(<span class="psc-1">5</span><span class="psc-4">,</span> <span class="psc-2">"N1"</span><span class="psc-4">,</span> <span class="psc-1">1</span>)
n2 <span class="psc-4">=</span> <span class="psc-5">input.int</span>(<span class="psc-1">5</span><span class="psc-4">,</span> <span class="psc-2">"N2"</span><span class="psc-4">,</span> <span class="psc-1">1</span>)
s <span class="psc-4">=</span> <span class="psc-5">input.float</span>(<span class="psc-1">100.0</span><span class="psc-4">,</span> <span class="psc-2">"S"</span>)
p1 <span class="psc-4">=</span> <span class="psc-5">input.float</span>(<span class="psc-1">500.0</span><span class="psc-4">,</span> <span class="psc-2">"P1"</span>)
p2 <span class="psc-4">=</span> <span class="psc-5">input.float</span>(<span class="psc-1">500.0</span><span class="psc-4">,</span> <span class="psc-2">"P2"</span>)

<span class="psc-4">var</span> ordersPlaced <span class="psc-4">=</span> <span class="psc-6">false</span>
<span class="psc-4">var</span> openPrice <span class="psc-4">=</span> <span class="psc-5">float</span>(<span class="psc-6">na</span>)
<span class="psc-4">var</span> takePrice <span class="psc-4">=</span> <span class="psc-5">float</span>(<span class="psc-6">na</span>)

signal1 <span class="psc-4">=</span> <span class="psc-6">barstate.isconfirmed</span> <span class="psc-4">and</span> <span class="psc-4">not</span> ordersPlaced
signal2 <span class="psc-4">=</span> <span class="psc-6">high</span> <span class="psc-4">>=</span> takePrice

<span class="psc-4">if</span> signal1
    ordersPlaced <span class="psc-4">:=</span> <span class="psc-6">true</span>
    openPrice <span class="psc-4">:=</span> <span class="psc-6">close</span>
    takePrice <span class="psc-4">:=</span> <span class="psc-6">close</span>

    <span class="psc-4">for</span> i <span class="psc-4">=</span> <span class="psc-1">1</span> <span class="psc-4">to</span> n1
        openPrice <span class="psc-4">:=</span> openPrice <span class="psc-4">-</span> <span class="psc-6">syminfo.pointvalue</span> <span class="psc-4">*</span> p1
        takePrice <span class="psc-4">:=</span> takePrice <span class="psc-4">+</span> <span class="psc-6">syminfo.pointvalue</span> <span class="psc-4">*</span> p2

        <span class="psc-5">strategy.order</span>(
          id <span class="psc-4">=</span> <span class="psc-2">"Long #"</span> <span class="psc-4">+</span> <span class="psc-5">str.tostring</span>(i)<span class="psc-4">,</span>
          direction <span class="psc-4">=</span> <span class="psc-6">strategy.long</span><span class="psc-4">,</span>
          qty <span class="psc-4">=</span> s <span class="psc-4">/</span> openPrice<span class="psc-4">,</span>
          limit <span class="psc-4">=</span> openPrice
          )
        <span class="psc-5">strategy.exit</span>(
          id <span class="psc-4">=</span> <span class="psc-2">"Take-profit #"</span> <span class="psc-4">+</span> <span class="psc-5">str.tostring</span>(i)<span class="psc-4">,</span>
          from_entry <span class="psc-4">=</span> <span class="psc-2">"Long #"</span> <span class="psc-4">+</span> <span class="psc-5">str.tostring</span>(i)<span class="psc-4">,</span>
          limit <span class="psc-4">=</span> takePrice
          )

<span class="psc-4">if</span> signal2
    <span class="psc-5">strategy.cancel_all</span>()
    ordersPlaced <span class="psc-4">:=</span> <span class="psc-6">false</span>
    openPrice <span class="psc-4">:=</span> <span class="psc-6">na</span>
    takePrice <span class="psc-4">:=</span> <span class="psc-6">na</span>

<span class="psc-4">if</span> <span class="psc-6">barstate.islast</span>
    <span class="psc-4">var</span> trades <span class="psc-4">=</span> <span class="psc-5">table.new</span>(
      position <span class="psc-4">=</span> <span class="psc-6">position.top_right</span><span class="psc-4">,</span>
      columns <span class="psc-4">=</span> <span class="psc-1">6</span><span class="psc-4">,</span>
      rows <span class="psc-4">=</span> n2 <span class="psc-4">*</span> <span class="psc-1">2</span> <span class="psc-4">+</span> <span class="psc-1">1</span><span class="psc-4">,</span>
      bgcolor <span class="psc-4">=</span> <span class="psc-6">color.white</span><span class="psc-4">,</span>
      frame_color <span class="psc-4">=</span> <span class="psc-6">color.black</span><span class="psc-4">,</span>
      frame_width <span class="psc-4">=</span> <span class="psc-1">1</span><span class="psc-4">,</span>
      border_color <span class="psc-4">=</span> <span class="psc-6">color.black</span><span class="psc-4">,</span>
      border_width <span class="psc-4">=</span> <span class="psc-1">1</span>
      )

    <span class="psc-5">table.cell</span>(trades<span class="psc-4">,</span> <span class="psc-1">0</span><span class="psc-4">,</span> <span class="psc-1">0</span><span class="psc-4">,</span> <span class="psc-2">"Trade #"</span>)
    <span class="psc-5">table.cell</span>(trades<span class="psc-4">,</span> <span class="psc-1">1</span><span class="psc-4">,</span> <span class="psc-1">0</span><span class="psc-4">,</span> <span class="psc-2">"Signal"</span>)
    <span class="psc-5">table.cell</span>(trades<span class="psc-4">,</span> <span class="psc-1">2</span><span class="psc-4">,</span> <span class="psc-1">0</span><span class="psc-4">,</span> <span class="psc-2">"Date/Time"</span>)
    <span class="psc-5">table.cell</span>(trades<span class="psc-4">,</span> <span class="psc-1">3</span><span class="psc-4">,</span> <span class="psc-1">0</span><span class="psc-4">,</span> <span class="psc-2">"Price"</span>)
    <span class="psc-5">table.cell</span>(trades<span class="psc-4">,</span> <span class="psc-1">4</span><span class="psc-4">,</span> <span class="psc-1">0</span><span class="psc-4">,</span> <span class="psc-2">"Size"</span>)
    <span class="psc-5">table.cell</span>(trades<span class="psc-4">,</span> <span class="psc-1">5</span><span class="psc-4">,</span> <span class="psc-1">0</span><span class="psc-4">,</span> <span class="psc-2">"Profit"</span>)

    <span class="psc-4">for</span> i <span class="psc-4">=</span> <span class="psc-1">1</span> <span class="psc-4">to</span> n2 <span class="psc-4">*</span> <span class="psc-1">2</span>
        <span class="psc-4">if</span> i <span class="psc-4">%</span> <span class="psc-1">2</span> <span class="psc-4">==</span> <span class="psc-1">0</span>
            <span class="psc-4">continue</span>

        <span class="psc-5">table.merge_cells</span>(trades<span class="psc-4">,</span> <span class="psc-1">0</span><span class="psc-4">,</span> i<span class="psc-4">,</span> <span class="psc-1">0</span><span class="psc-4">,</span> i <span class="psc-4">+</span> <span class="psc-1">1</span>)
        <span class="psc-5">table.merge_cells</span>(trades<span class="psc-4">,</span> <span class="psc-1">4</span><span class="psc-4">,</span> i<span class="psc-4">,</span> <span class="psc-1">4</span><span class="psc-4">,</span> i <span class="psc-4">+</span> <span class="psc-1">1</span>)
        <span class="psc-5">table.merge_cells</span>(trades<span class="psc-4">,</span> <span class="psc-1">5</span><span class="psc-4">,</span> i<span class="psc-4">,</span> <span class="psc-1">5</span><span class="psc-4">,</span> i <span class="psc-4">+</span> <span class="psc-1">1</span>)

        tradeNum <span class="psc-4">=</span> <span class="psc-6">strategy.closedtrades</span> <span class="psc-4">-</span> <span class="psc-5">int</span>(i <span class="psc-4">/</span> <span class="psc-1">2</span>) <span class="psc-4">-</span> <span class="psc-1">1</span>
        exitSignal <span class="psc-4">=</span>
          <span class="psc-4">not</span> <span class="psc-5">na</span>(<span class="psc-5">strategy.closedtrades.exit_comment</span>(tradeNum)) <span class="psc-4">?</span>
          <span class="psc-5">strategy.closedtrades.exit_comment</span>(tradeNum) <span class="psc-4">:</span>
          <span class="psc-5">strategy.closedtrades.exit_id</span>(tradeNum)
        entrySignal <span class="psc-4">=</span>
          <span class="psc-4">not</span> <span class="psc-5">na</span>(<span class="psc-5">strategy.closedtrades.entry_comment</span>(tradeNum)) <span class="psc-4">?</span>
          <span class="psc-5">strategy.closedtrades.entry_comment</span>(tradeNum) <span class="psc-4">:</span>
          <span class="psc-5">strategy.closedtrades.entry_id</span>(tradeNum)
        exitTime <span class="psc-4">=</span> <span class="psc-5">str.format_time</span>(
          time <span class="psc-4">=</span> <span class="psc-5">strategy.closedtrades.exit_time</span>(tradeNum)<span class="psc-4">,</span>
          format <span class="psc-4">=</span> <span class="psc-2">"yyyy-MM-dd HH:mm"</span>
          )
        entryTime <span class="psc-4">=</span> <span class="psc-5">str.format_time</span>(
          time <span class="psc-4">=</span> <span class="psc-5">strategy.closedtrades.entry_time</span>(tradeNum)<span class="psc-4">,</span>
          format <span class="psc-4">=</span> <span class="psc-2">"yyyy-MM-dd HH:mm"</span>
          )
        exitPrice <span class="psc-4">=</span> <span class="psc-5">str.format</span>(
          <span class="psc-2">"{0} {1}"</span><span class="psc-4">,</span>
          <span class="psc-5">strategy.closedtrades.exit_price</span>(tradeNum)<span class="psc-4">,</span>
          <span class="psc-6">syminfo.currency</span>
          )
        entryPrice <span class="psc-4">=</span> <span class="psc-5">str.format</span>(
          <span class="psc-2">"{0} {1}"</span><span class="psc-4">,</span>
          <span class="psc-5">strategy.closedtrades.entry_price</span>(tradeNum)<span class="psc-4">,</span>
          <span class="psc-6">syminfo.currency</span>
          )
        size <span class="psc-4">=</span> <span class="psc-5">str.tostring</span>(
          <span class="psc-5">math.abs</span>(<span class="psc-5">strategy.closedtrades.size</span>(tradeNum))
          )
        profit <span class="psc-4">=</span> <span class="psc-5">str.format</span>(
          <span class="psc-2">"{0} {1}\n{2} %"</span><span class="psc-4">,</span>
          <span class="psc-5">strategy.closedtrades.profit</span>(tradeNum)<span class="psc-4">,</span>
          <span class="psc-6">strategy.account_currency</span><span class="psc-4">,</span>
          <span class="psc-5">strategy.closedtrades.profit_percent</span>(tradeNum)
          )

        <span class="psc-5">table.cell</span>(trades<span class="psc-4">,</span> <span class="psc-1">0</span><span class="psc-4">,</span> i<span class="psc-4">,</span> <span class="psc-5">str.tostring</span>(tradeNum <span class="psc-4">+</span> <span class="psc-1">1</span>))
        <span class="psc-5">table.cell</span>(trades<span class="psc-4">,</span> <span class="psc-1">1</span><span class="psc-4">,</span> i<span class="psc-4">,</span> exitSignal)
        <span class="psc-5">table.cell</span>(trades<span class="psc-4">,</span> <span class="psc-1">1</span><span class="psc-4">,</span> i <span class="psc-4">+</span> <span class="psc-1">1</span><span class="psc-4">,</span> entrySignal)
        <span class="psc-5">table.cell</span>(trades<span class="psc-4">,</span> <span class="psc-1">2</span><span class="psc-4">,</span> i<span class="psc-4">,</span> exitTime)
        <span class="psc-5">table.cell</span>(trades<span class="psc-4">,</span> <span class="psc-1">2</span><span class="psc-4">,</span> i <span class="psc-4">+</span> <span class="psc-1">1</span><span class="psc-4">,</span> entryTime)
        <span class="psc-5">table.cell</span>(trades<span class="psc-4">,</span> <span class="psc-1">3</span><span class="psc-4">,</span> i<span class="psc-4">,</span> exitPrice)
        <span class="psc-5">table.cell</span>(trades<span class="psc-4">,</span> <span class="psc-1">3</span><span class="psc-4">,</span> i <span class="psc-4">+</span> <span class="psc-1">1</span><span class="psc-4">,</span> entryPrice)
        <span class="psc-5">table.cell</span>(trades<span class="psc-4">,</span> <span class="psc-1">4</span><span class="psc-4">,</span> i<span class="psc-4">,</span> size)
        <span class="psc-5">table.cell</span>(trades<span class="psc-4">,</span> <span class="psc-1">5</span><span class="psc-4">,</span> i<span class="psc-4">,</span> profit)</code></pre>
                    </div>
                    <p>Повторяем теорию:</p>
                    <ul>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_table.merge_cells"
                          target="_blank"
                          class="underline"
                          >table.merge_cells()</a
                        >
                        объединяет ячейки таблицы в одну ячейку;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_strategy.closedtrades.exit_comment"
                          target="_blank"
                          class="underline"
                          >strategy.closedtrades.exit_comment()</a
                        >
                        возвращает комментарий ордера, которым была закрыта
                        позиция под указанным номером, либо возвращает
                        <em>na</em>, если комментарий отсутствует;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_strategy.closedtrades.exit_id"
                          target="_blank"
                          class="underline"
                          >strategy.closedtrades.exit_id()</a
                        >
                        возвращает идентификатор ордера, которым была закрыта
                        позиция под указанным номером;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_strategy.closedtrades.entry_comment"
                          target="_blank"
                          class="underline"
                          >strategy.closedtrades.entry_comment()</a
                        >
                        возвращает комментарий ордера, которым была открыта
                        закрытая позиция под указанным номером, либо возвращает
                        <em>na</em>, если комментарий отсутствует;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_strategy.closedtrades.entry_id"
                          target="_blank"
                          class="underline"
                          >strategy.closedtrades.entry_id()</a
                        >
                        возвращает идентификатор ордера, которым была открыта
                        закрытая позиция под указанным номером;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_str.format_time"
                          target="_blank"
                          class="underline"
                          >str.format_time()</a
                        >
                        преобразует Unix-время в строку в соответствии с
                        указанным форматом;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_strategy.closedtrades.exit_time"
                          target="_blank"
                          class="underline"
                          >strategy.closedtrades.exit_time()</a
                        >
                        возвращает Unix-время исполнения ордера, которым была
                        закрыта позиция под указанным номером;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_strategy.closedtrades.entry_time"
                          target="_blank"
                          class="underline"
                          >strategy.closedtrades.entry_time()</a
                        >
                        возвращает Unix-время исполнения ордера, которым была
                        открыта закрытая позиция под указанным номером;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_strategy.closedtrades.exit_price"
                          target="_blank"
                          class="underline"
                          >strategy.closedtrades.exit_price()</a
                        >
                        возвращает цену исполнения ордера, которым была закрыта
                        позиция под указанным номером;
                      </li>
                      <li>
                        переменная
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#var_syminfo.currency"
                          target="_blank"
                          class="underline"
                          >syminfo.currency</a
                        >
                        содержит код валюты цен текущего символа;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_strategy.closedtrades.entry_price"
                          target="_blank"
                          class="underline"
                          >strategy.closedtrades.entry_price()</a
                        >
                        возвращает цену исполнения ордера, которым была открыта
                        закрытая позиция под указанным номером;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_math.abs"
                          target="_blank"
                          class="underline"
                          >math.abs()</a
                        >
                        возвращает модуль указанного числа;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_strategy.closedtrades.size"
                          target="_blank"
                          class="underline"
                          >strategy.closedtrades.size()</a
                        >
                        возвращает направление и размер закрытой позиции;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_strategy.closedtrades.profit"
                          target="_blank"
                          class="underline"
                          >strategy.closedtrades.profit()</a
                        >
                        возвращает прибыль или убыток от позиции;
                      </li>
                      <li>
                        переменная
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#var_strategy.account_currency"
                          target="_blank"
                          class="underline"
                          >strategy.account_currency</a
                        >
                        содержит код валюты для расчёта результатов стратегии;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_strategy.closedtrades.profit_percent"
                          target="_blank"
                          class="underline"
                          >strategy.closedtrades.profit_percent()</a
                        >
                        возвращает процентную прибыль или убыток от позиции.
                      </li>
                    </ul>
                    <div class="note-box">
                      <div class="note-box-header">На заметку</div>
                      <p>
                        Pine Script обладает рядом встроенных функций и
                        переменных, предназначенных для сбора информации о
                        работе стратегии, аналогичной той, что доступна в
                        <a
                          href="https://www.tradingview.com/pine-script-docs/concepts/strategies/#strategy-tester"
                          target="_blank"
                          class="underline"
                          >тестере стратегий</a
                        >.
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>
          <section id="section-45">
            <h4>Задача #45. Профит-фактор</h4>
            <p>Написать стратегию.</p>
            <h5>Ввод</h5>
            <p>Целое число L1. Минимальное значение: <em>1</em>.</p>
            <p>Целое число L2. Минимальное значение: <em>1</em>.</p>
            <p>Целое число N. Минимальное значение: <em>1</em>.</p>
            <h5>Основные вычисления</h5>
            <p>
              Наибольшие значения, вычисляемые на основе L1 цен максимумов
              баров.
            </p>
            <p>
              Экспоненциальное скользящее среднее, вычисляемое на основе L2
              наибольших значений.
            </p>
            <p>
              Логический сигнал #1, принимающий значение <em>true</em>, если
              закрытие текущего бара больше текущего значения скользящего
              среднего, максимум текущего бара больше максимума предыдущего
              бара, и количество открытых рыночных позиций меньше N; в
              противном случае логический сигнал принимает значение
              <em>false</em>.
            </p>
            <p>
              Логический сигнал #2, принимающий значение <em>true</em>, если
              закрытие текущего бара меньше текущего значения скользящего
              среднего, закрытие предыдущего бара меньше предыдущего значения
              скользящего среднего, и есть хотя бы одна открытая рыночная
              позиция; в противном случае логический сигнал принимает значение
              <em>false</em>.
            </p>
            <p>
              Размещение ордеров на открытие и закрытие длинных позиций. Если
              логический сигнал #1 принимает значение
              <em>true</em>, то размещается рыночный ордер на открытие длинной
              позиции. Если логический сигнал #2 принимает значение
              <em>true</em>, то размещается рыночный ордер на закрытие всех
              открытых позиций.
            </p>
            <p>
              Профит-фактор, вычисляемый после каждого закрытия рыночных
              позиций.
            </p>
            <h5>Вывод</h5>
            <p>
              Сообщения в панели логов, содержащие значение профит-фактора.
              Если профит-фактор увеличился, сообщение должно быть
              информационным. Если профит-фактор уменьшился, сообщение должно
              быть предупредительным.
            </p>
            <p>Экспоненциальное скользящее среднее объектом <em>plot</em>.</p>
            <a href="images/tasks/task-45-L.png" class="image">
              <img
                src="images/tasks/task-45-L.png"
                class="img-fluid img-thumbnail"
              />
            </a>
            <div class="accordion" id="task-45">
              <div class="accordion-item">
                <div class="accordion-header">
                  <button
                    class="accordion-button collapsed"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#collapse-45"
                  >
                    Решение
                  </button>
                </div>
                <div
                  id="collapse-45"
                  class="accordion-collapse collapse"
                  data-bs-parent="#task-45"
                >
                  <div class="accordion-body">
                    <div class="code-box mb-2-5">
                      <pre><code><span class="psc-3">//@version=6</span>
<span class="psc-5">strategy</span>(
  title <span class="psc-4">=</span> <span class="psc-2">"Task #45"</span><span class="psc-4">,</span>
  overlay <span class="psc-4">=</span> <span class="psc-6">true</span><span class="psc-4">,</span>
  commission_value <span class="psc-4">=</span> <span class="psc-1">0.1</span><span class="psc-4">,</span>
  process_orders_on_close <span class="psc-4">=</span> <span class="psc-6">true</span>
  )

l1 <span class="psc-4">=</span> <span class="psc-5">input.int</span>(<span class="psc-1">30</span><span class="psc-4">,</span> <span class="psc-2">"L1"</span><span class="psc-4">,</span> <span class="psc-1">1</span>)
l2 <span class="psc-4">=</span> <span class="psc-5">input.int</span>(<span class="psc-1">20</span><span class="psc-4">,</span> <span class="psc-2">"L2"</span><span class="psc-4">,</span> <span class="psc-1">1</span>)
n <span class="psc-4">=</span> <span class="psc-5">input.int</span>(<span class="psc-1">3</span><span class="psc-4">,</span> <span class="psc-2">"N"</span><span class="psc-4">,</span> <span class="psc-1">1</span>)

<span class="psc-4">var</span> profitFactor <span class="psc-4">=</span> <span class="psc-5">float</span>(<span class="psc-6">na</span>)
ema <span class="psc-4">=</span> <span class="psc-5">ta.ema</span>(<span class="psc-5">ta.highest</span>(l1)<span class="psc-4">,</span> l2)

entrySignal <span class="psc-4">=</span>
  <span class="psc-6">close</span> <span class="psc-4">></span> ema <span class="psc-4">and</span>
  <span class="psc-6">high</span> <span class="psc-4">></span> <span class="psc-6">high</span>[<span class="psc-1">1</span>] <span class="psc-4">and</span>
  <span class="psc-6">strategy.opentrades</span> <span class="psc-4"><</span> n
exitSignal <span class="psc-4">=</span>
  <span class="psc-6">close</span> <span class="psc-4"><</span> ema <span class="psc-4">and</span>
  <span class="psc-6">close</span>[<span class="psc-1">1</span>] <span class="psc-4"><</span> ema[<span class="psc-1">1</span>] <span class="psc-4">and</span>
  <span class="psc-6">strategy.position_size</span> <span class="psc-4">></span> <span class="psc-1">0</span>

<span class="psc-4">if</span> exitSignal
    <span class="psc-5">strategy.close</span>(<span class="psc-2">"Long"</span><span class="psc-4">,</span> <span class="psc-2">"Exit Long"</span>)
<span class="psc-4">else</span> <span class="psc-4">if</span> entrySignal
    <span class="psc-5">strategy.order</span>(<span class="psc-2">"Long"</span><span class="psc-4">,</span> <span class="psc-6">strategy.long</span><span class="psc-4">,</span> comment <span class="psc-4">=</span> <span class="psc-2">"Entry Long"</span>)

<span class="psc-4">if</span> <span class="psc-5">bool</span>(<span class="psc-5">ta.change</span>(<span class="psc-6">strategy.closedtrades</span>))
    profitFactor <span class="psc-4">:=</span> <span class="psc-6">strategy.grossprofit</span> <span class="psc-4">/</span> <span class="psc-6">strategy.grossloss</span>

    <span class="psc-4">if</span> profitFactor <span class="psc-4">></span> profitFactor[<span class="psc-1">1</span>]
        <span class="psc-5">log.info</span>(<span class="psc-2">"Profit Factor: {0}"</span><span class="psc-4">,</span> profitFactor)
    <span class="psc-4">else</span> <span class="psc-4">if</span> profitFactor <span class="psc-4"><</span> profitFactor[<span class="psc-1">1</span>]
        <span class="psc-5">log.warning</span>(<span class="psc-2">"Profit Factor: {0}"</span><span class="psc-4">,</span> profitFactor)

<span class="psc-5">plot</span>(ema<span class="psc-4">,</span> color <span class="psc-4">=</span> <span class="psc-6">color.green</span><span class="psc-4">,</span> linewidth <span class="psc-4">=</span> <span class="psc-1">2</span>)</code></pre>
                    </div>
                    <p>Повторяем теорию:</p>
                    <ul>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_ta.highest"
                          target="_blank"
                          class="underline"
                          >ta.highest()</a
                        >
                        возвращает наибольшее значение серии за указанное
                        количество баров;
                      </li>
                      <li>
                        переменная
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#var_strategy.opentrades"
                          target="_blank"
                          class="underline"
                          >strategy.opentrades</a
                        >
                        содержит число открытых рыночных позиций;
                      </li>
                      <li>
                        переменная
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#var_strategy.grossprofit"
                          target="_blank"
                          class="underline"
                          >strategy.grossprofit</a
                        >
                        содержит текущую валовую прибыль;
                      </li>
                      <li>
                        переменная
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#var_strategy.grossloss"
                          target="_blank"
                          class="underline"
                          >strategy.grossloss</a
                        >
                        содержит текущий валовой убыток;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_log.info"
                          target="_blank"
                          class="underline"
                          >log.info()</a
                        >
                        добавляет сообщение с уровнем «информация» в панель
                        логов;
                      </li>
                      <li>
                        функция
                        <a
                          href="https://ru.tradingview.com/pine-script-reference/v6/#fun_log.warning"
                          target="_blank"
                          class="underline"
                          >log.warning()</a
                        >
                        добавляет сообщение с уровнем «предупреждение» в панель
                        логов.
                      </li>
                    </ul>
                    <div class="note-box">
                      <div class="note-box-header">На заметку</div>
                      <p>
                        <a
                          href="https://www.tradingview.com/pine-script-docs/writing/debugging/#pine-logs"
                          target="_blank"
                          class="underline"
                          >Логи Pine</a
                        >
                        — очень удобный инструмент для отладки скриптов.
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>
        </main>
      </div>
    </div>
    <footer class="text-body-secondary">
      <hr class="my-0" />
      <div class="container px-6 py-3">
        <p class="mb-0">&copy; Китобойная, 2025</p>
      </div>
    </footer>
    <script src="scripts/bootstrap.js"></script>
    <script src="scripts/themeManager.js"></script>
    <script src="scripts/imageManager.js"></script>
  </body>
</html>
